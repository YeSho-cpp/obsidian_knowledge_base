# 第一章概述

### 因特网概述

网络、互连网（互联网）与因特网的区别与关系 

- 若干节点和链路互连形成<font color=#ff0000>网络</font> 

	<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231205170105.png?OSSAccessKeyId=LTAI5tBK1gnqyQLHK2d7sx6F&Expires=9000000001&Signature=vmAWLaNr1615iM16moIHguIr3Ek=" alt="image.png" style="zoom:40%;" />



	- 网络中的节点可以是计算机（笔记本电脑、台式电脑、服务器等）、网络互连设备（集线器、交换机、路由器等）、其他具有网络功能的设备（网络打印机、网络摄像头、物联网设备等）。网络中的链路既可以是有线链路，也可以是无线链路。 


- 若干网络通过路由器互连形成<font color=#ff0000>互连网</font>（互联网） 


	<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231205170159.png?OSSAccessKeyId=LTAI5tBK1gnqyQLHK2d7sx6F&Expires=9000000000&Signature=8zAOrt/HCX6Tw/8kxlX1mUXC67w=" alt="image.png" style="zoom:40%;" />



	- 互联网(internet)是由若干**网络**和连接这些网络的**路由器**组成的，如果我们忽略互连细节，则可将互联网看作一个覆盖范围更大的网络，因此也可称其为“网络 

- 因特网是当今世界上最大的<font color=#ff0000>互联网 </font>

<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231205170343.png?OSSAccessKeyId=LTAI5tBK1gnqyQLHK2d7sx6F&Expires=9000000001&Signature=wB0wFJK1yjgLZNbtvLpmAvCapgQ=" alt="image.png" style="zoom:50%;" />


### 因特网简介 
因特网服务提供者 (Internet Service Provider, <font color=#ff0000>ISP</font>) 

<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231205170450.png?OSSAccessKeyId=LTAI5tBK1gnqyQLHK2d7sx6F&Expires=9000000001&Signature=d3hUwERW/ymTkhst6LeV0UvwiCg=" alt="image.png" style="zoom:50%;" />



因特网已发展成为<font color=#ff0000>基于ISP的多层次结构的互连网络 </font>

<img src="https://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231205170547.png" alt="image.png" style="zoom:30%;" />

### 因特网组成

<img src="https://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231205171135.png" alt="image.png" style="zoom:40%;" />


- 因特网的边缘部分。由连接在因特网上的台式电脑、笔记本电脑、平板电脑、服务器、智能手机、智能手表、网络摄像头和网络打印机等用户设备构成。这些用户设备常称为**主机**，由用户直接使用，为用户直接提供各式各样的网络应用。 
- 因特网的核心部分。由大量**异构型网络**和连接这些网络的**路由器**构成。因特网的核心部分为其边缘部分提供连通性和数据交换等服务。 


## 电路交换、分组交换和报文交换 

### 电路交换

<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231205171454.png?" alt="image.png" style="zoom:50%;" />



流程：

<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231205171739.png?" alt="image.png" style="zoom:40%;" />


计算机之间的数据传送适合采用电路交换方式吗？ 
答：计算机之间的数据传送是<font color=#ff0000>突发式</font>的，当使用电路交换来传送计算机数据时，其线路的传输效率一般都会很低，线路上真正用来传送数据的时间往往不到10%甚至不到1%。 


### 分组转发

- 待发送的整块数据通常被称为**报文**（Message)。
- 长的报文一般不适宜直接传输，对交换节点的缓存容量有很大的需求，在错误处理方面也会比较低效。
- 需要将较长的报文划分成若干个较小的等长数据段，在每个数据段前面添加一些由必要的控制信息（例如源地址和目的地址等）组成的首部（Header) 

<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231205171903.png?" alt="image.png" style="zoom:50%;" />


<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231205172127.png?" alt="image.png" style="zoom:40%;" />


- 源主机将分组发送到分组交换网中，分组交换网中的分组交换机收到一个分组后，先将其缓存下来
- 从其首部中提取出目的地址，按照目的地址查找自己的转发表，找到相应的转发接口后将分组转发出去，把分组交给下一个分组交换机
- 经过多个分组交换机 的存储转发后，分组最终被转发到目的主机 

整体各方工作：
发送方: 构造分组   发送分组
交换节点: 缓存分组  转发分组
接收方: 接受分组  还原分组


分组交换的优点如下： 
1. 没有建立连接和释放连接的过程，分组传输过程中逐段占用通信链路，有较高的通信线路利用率。 
2. 交换节点可以为每一个分组独立选择转发路由，使得网络有很好的生存性。 
分组交换也带来了一些问题： 
1. 分组首部带来了额外的传输开销。 
2. 路由器存储转发分组会造成一定的时延。 
3. 无法确保通信时端到端的通信资源全部可用，在通信量较大时可能造成网络拥塞。 
4. 分组可能会出现失序（未按序到达）和丢失等问题。 
### 报文交换
- 报文交换是分组交换的前身。 
- 在报文交换中，<font color=#ff0000>报文被整个地发送</font>，而不是拆分成若干个分组进行发送。 
- 交换节点将报文<font color=#ff0000>整体接收完成后</font>才能查找转发表，将整个报文<font color=#ff0000>转发</font>到下一个节点。 
- 因此，报文交换比分组交换带来的<font color=#ff0000>转发时延要长很多</font>，需要交换节点具有的<font color=#ff0000>缓存空间也大很多</font>。 



三种交换方式的对比 
- 若要连续传送大量的数据，并且数据传送时间远大于建立连接的时间，则使用电路交换可以有较高的传输效率。然而<font color=#ff0000>计算机的数据传送</font>往往是<font color=#ff0000>突发式</font>的，<font color=#ff0000>采用电路交换</font>时通信<font color=#ff0000>线路的利用率会很低</font>。 
- 报文交换和分组交换都<font color=#ff0000>不需要建立连接</font>（即预先分配通信资源）,在<font color=#ff0000>传送计算机的突发数据</font>时可以<font color=#ff0000>提高通信线路的利用率</font>。 
- 将报文构造成若干个更小的分组进行<font color=#ff0000>分组交换</font>，比将整个报文进行报文交换的<font color=#ff0000>时延要小</font>，并且还可以<font color=#ff0000>避免太长的报文长时间占用链路，有利于差错控制</font>，同时具有更好的灵活性。 

<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231205173132.png?" alt="image.png" style="zoom:50%;" />


### 计算机网络的定义和分类 

计算机网络的定义 
- 计算机网络的精确定义并未统一 
- 计算机网络的最简单定义：一些<font color=#ff0000>互连</font>的、<font color=#ff0000>自治</font>的计算机的<font color=#ff0000>集合</font>。 
- 计算机网络主要是由一些<font color=#ff0000>通用的、可编程的硬件</font>互连而成的，而这些硬件并非专门用来实现某一特定目的（例如，传送数据或视频信号）。这些可编程的硬件能够用来<font color=#ff0000>传送多种不同类型的数据</font>，并能<font color=#ff0000>支持广泛的和日益增长的应用</font>

计算机网络分类

<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231205173245.png?" alt="image.png" style="zoom:40%;" />

<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231205173558.png?" alt="image.png" style="zoom:40%;" />


### 计算机网络的性能指标 

#### 速率

- 速率是指**数据的传送速率**（即**每秒传送多少个比特**）,也称为数据率或比特率。 
- 速率的基本单位：bit/s(b/s,bps); 常用单位：kb/s,Mb/s,Gb/s,Tb/s。 
- 数据量单位中的K、M、G、T的数值分别为$2^{10}、2^{20}、2^{30}、2^{40}$;速率单位中的k、M、G、T的数值分别为$10^3、10^6、10^9、10^{12}$。 

#### 带宽

- 带宽在模拟信号系统中的意义：某个信号所包含的各种不同频率成分所占据的<font color=#ff0000>频率范围</font>。单位：Hz(kHz,MHz,GHz)。 
- 带宽在计算机网络中的意义：用来表示网络的<font color=#ff0000>通信线路所能传送数据的能力</font>，即在单位时间内从网络中的某一点到另一点所能通过的<font color=#ff0000>最高数据率</font>。单位与速率单位相同。 
- 带宽的上述两种表述之间有着密切的联系：一条通信线路的“频带宽度”越宽，其所传输数据的“最高数据率”也越高。 

> 数据传送速率=`min[主机接口速率，线路带宽，交换机或路由器的接口速率]` 这是典型的木桶效应

#### 吞吐量
吞吐量是指在<font color=#ff0000>单位时间内通过某个网络或接口的实际数据量</font>。吞吐量常被用于对实际网络的测量，以便获知到底有多少数据量通过了网络。 
吞吐量<font color=#ff0000>受网络带宽的限制</font>。 

<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231205174106.png?" alt="image.png" style="zoom:40%;" />


从上图可以看到吞吐量是下载速度和上传速度总和
#### 其他指标

- 发送时延=分组长度（b)/发送速率（b/s) 
- 传播时延=信道长度（m)/信号传播速率（m/s) 
- 排队时延和处理时延不方便计算 

- 时延带宽积是<font color=#ff0000>传播时延和带宽的乘积</font>。 
- 若发送端连续发送数据，则在所发送的第一个比特即将到达终点时，发送端就已经发送了时延带宽积个比特。 
- 链路的时延带宽积又称为以<font color=#ff0000>比特为单位的链路长度</font>。 

- 往返时间RTT是指<font color=#ff0000>通信双方双向交互一次所耗费的时间</font>。 

- **信道利用率**：用来表示某信道有百分之几的时间是被利用的（有数据通过） 
- **网络利用率**：全网络的信道利用率的加权平均。 
- **利用率并非越高越好**：当某信道的利用率增大时，该信道引起的时延也会迅速增加。 $D=\frac{D_{_0}} {1-U}$ 也不能使信道利用率太低，这会使宝贵的通信资源被白白浪费。 

- 丢包率是指在一定的时间范围内，传输过程中<font color=#ff0000>丢失的分组数量与总分组数量的比率</font>。 
- 分组丢弃的两个主要原因：<font color=#ff0000>分组误码后被结点交换机丢弃；节点交换机根据丢包策略主动丢弃</font>。 
- 丢包率反映了网络的拥塞程度。 


## 计算机网络体系结构

### 常见的三种计算机网络体系结构 


<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231206085632.png?" alt="image.png" style="zoom:40%;" />



OSI标准失败的原因
1. 专家没有实际经验 完成标准时没有商业驱动力 
2. 协议实现过分复杂 运行效率很低
3. 标准的制定周期太长 产品无法及时进入市场
4. 层次划分不太合理 有些功能在多个层次中重复出现 ****


<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231206085809.png?)" alt="image.png" style="zoom:30%;" />

TCP/IP体系结构各层包含的主要协议如图1-36所示。 
1. TCP/IP体系结构的网络接口层并没有规定什么具体的内容，这样做的目的是可以连全世界各种不同的网络接口，例如**有线的以太网接口**、无线局域网的Wi-Fi接口，而不限定仅使用一种或几种网络接口。 


<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231206085833.png?" alt="image.png" style="zoom:30%;" />

2. 网际协议IP是TCP/IP体系结构网际层的核心协议。 
3. 传输控制协议（Transmission Control Protocol,TCP)和用户数据报协议（User Datagram Protocol,UDP)是TCP/IP体系结构运输层的两个重要协议。 
4. TCP/IP体系结构的应用层包含了大量的应用层协议，例如超文本传送协议 (HyperText Transfer Protocol,HTTP)、简单邮件传送协议（Simple Mail Transfer Protocol,SMTP)、域名系统（Domain Name System,DNS)以及实时运输协议（Real- time Transport Protocol,RTP)等。
## 计算机网络体系结构分层的必要性 

<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231206090319.png?" alt="image.png" style="zoom:40%;" />

1. 物理层解决的问题

	<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231206090531.png?" alt="image.png" style="zoom:40%;" />


2. 数据链路层解决的问题

	<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231206090734.png?" alt="image.png" style="zoom:40%;" />

3. 网络层解决的问题


	<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231206090917.png?" alt="image.png" style="zoom:40%;" />
4. 传输层解决的问题

<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231206091054.png?" alt="image.png" style="zoom:40%;" />

5. 应用层解决的问题

<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231206091156.png?" alt="image.png" style="zoom:40%;" />



## 计算机网络体系结构分层思想举例 



<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231206092433.png?" alt="image.png" style="zoom:50%;" />

主机属于网络N1,Web服务器属于网络N2,N1和N2通过路由器互连。 用户在主机中使用浏览器访问Web服务器的过程如下： 
1. 用户在浏览器地址栏中输入Web服务器的域名
2. 主机向Web服务器发送一个请求报文
3. Web服务器收到请求报文后，执行相应的操作，然后给主机发送响应报文 
4. 主机收到响应报文后，由浏览器负责解析和渲染显示 




<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231206092327.png?" alt="image.png" style="zoom:40%;" />

主机对数据包的处理过程：
1. 应用层：根据HTTP协议的规定，构建一个HTTP请求报文，用来请求Web服务器执行相应的操作。应用层将构建好的HTTP请求报文向下交付给运输层。 
2. 运输层：给HTTP请求报文添加一个TCP首部，将其封装成TCP报文段。TCP首部的主要作用是区分应用进程和实现可靠传输。运输层将封装好的TCP报文段向下交付给网络层。 
3. 网络层：为TCP报文段添加一个IP首部，将其封装成IP数据报。IP首部的主要作用是IP寻址和路由。网络层将封装好的IP数据报向下交付给数据链路层。 
4. 数据链路层：为IP数据报添加一个首部和一个尾部，将其封装成帧。帧首部和尾部的主要作用是MAC寻址和帧校验。数据链路层将封装好的帧向下交付给物理层。 
5. 物理层：并不认识帧的结构，仅仅将其看作比特流，以便将比特流转换成相应的电信号进行发送。对于以太网，物理层还会在比特流前添加前导码，目的是使接收方的时钟同步，并做好接收准备。 


路由器对数据包的处理过程
1. (接收口的）物理层：将收到的电信号转换成比特流，并去掉前导码，然后将帧向上交付给数据链路层。 
2. (接收口的）数据链路层：去掉帧的首部和尾部后，将IP数据报向上交付给网络层。 
3. 网络层：网络层从IP数据报的首部中提取出目的IP地址，根据目的IP地址查找自己的转发表，以便决定从哪个接口转发该IP数据报。与此同时，还要对首部中的某些字段值（例如生存时间TTL字段的值）进行相应的修改，然后将该IP数据报向下交付给数据链路层。 
4. (转发口的）数据链路层：为IP数据报添加一个首部和一个尾部，将其封装成帧，然后将帧向下交付给物理层。 
5. (转发口的）物理层：将帧看作比特流，给其添加前导码后转变成相应的电信号发送出去。 

## 计算机网络体系结构中的专用术语 

- **实体**是指任何可发送或接收信息的**硬件**或**软件进程**。 
- **对等**实体是指通信双方**相同层次**中的**实体**。 
- 协议是控制两个对等实体在“**水平方向**”进行“**逻辑通信**”的**规则的集合**。 
- 协议的三要素 
	- **语法**定义所交换信息的**格式** 
	- **语义**定义通信双方所要完成的**操作** 
	- **同步**定义通信双方的**时序关系** 
- 在协议的控制下，两个对等实体在水平方向的逻辑通信使得本层能够向上一层提供服务。 
	- 要实现本层协议，还需要使用下面一层所提供的服务。 
	- 协议是“**水平**”的，而服务是“**垂直**”的。 
	- 实体看得见下层提供的服务，但并不知道实现该服务的具体协议。下层的协议对上层的实体是“透明”的。 
- 在同一系统中**相邻两层的实体交换信息的逻辑接口**称为**服务访问点SAP**,它被用于区分不同的服务类型。 
- 帧的“类型”字段、IP数据报的“协议”字段，TCP报文段或UDP用户数据报的“端口号”字段都是SAP。 
- 上层要使用下层所提供的服务，必须通过与下层**交换一些命令**，这些命令称为**服务原语**。 
- 对等层次之间传送的数据包称为该层的**协议数据单元**（Protocol Data Unit,PDU)。 
- 同一系统内层与层之间交换的数据包称为**服务数据单元**（Service Data Unit,SDU)。 


# 物理层

## 物理层概述


<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231206095225.png?)" alt="image.png" style="zoom:50%;" />


物理层要实现的功能是在各种传输媒体上传输比特0和1,进而给其上面的数据链路层提供透明传输比特流的服务。“透明传输比特流”的意思是数据链路层 “**看不见**”（也无须看见）物理层究竟使用的是什么方法来传输比特流，数据链路层 **只管 “享受”** 物理层提供的比特流传输服务即可。 

**物理层接口特性**

机械特性 
- 形状和尺寸 
- 引脚数目和排列 
- 固定和锁定装置 

电气特性 
- 信号电压的范围 
- 阻抗匹配的情况 
- 传输速率 
- 距离限制 

功能特性 
- 规定接口电缆的各规定在信号线上传条信号线的作用 

过程特性 
- 规定在信号线上传输比特流的一组操作过程，包括各信号间的时序关系 


## 物理层下面的传输媒体 

传输媒体是计算机网络设备之间的物理通路，也称为传输介质或传输媒介。传输媒体可分为导向型传输媒体和非导向型传输媒体两大类。

![[传输媒体.km]]

1. 同轴电缆
	同轴电缆价格较贵且布线不够灵活和方便。随着技术的发展和集线器的出现，在局域网领域基本上都采用双绞线作为传输媒体。 

2. 双绞线
	主要是减少了电磁干扰

3. 光纤
	这里不多介绍了




## 传输方式
### 串行传输和并行传输 

1. 串行传输
	对于串行传输，在发送端和接收端之间只有一条数据传输线路，构成数据的多个比特，在这条数据传输线路上逐比特依次传输。
2. 并行传输
	对于串行传输，在发送端和接收端之间只有一条数据传输线路，构成数据的多个比特，在这条数据传输线路上逐比特依次传输。 
对于串行传输，在发送端和接收端之间只有一条数据传输线路，构成数据的多个比特，在这条数据传输线路上逐比特依次传输。 

<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231206102617.png?" alt="image.png" style="zoom:50%;" />

并行传输的**成本高**，通常仅用于**短距离传输**，例如计算机内部的数据传输，而远距离传输一般采用串行传输方式。 计算机中的网卡，同时具有串行传输和并行传输方式。

<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231206102755.png?" alt="image.png" style="zoom:50%;" />
### 同步传输和异步传输

#### 同步传输

同步传输方式以比特为传输单位，数据块以比特流的形式传输，字节之间没有间隔，也没有起始位和终止位。这就要求收发双方，对表示比特的信号的时间长度达成一致，即所谓的同步。

<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231206103033.png?" alt="image.png" style="zoom:40%;" />


#### 异步传输

异步传输方式以字节为传输单位，但字节之间的时间间隔并不固定，接收端只在每个字节的起始处对字节内的比特实现同步。

<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231206103251.png?)" alt="image.png" style="zoom:50%;" />

1. **字节之间异步**，即字节之间的时间间隔不固定。 
2. **字节中的每个比特仍然要同步**，即各比特的持续时间是相同的。 

### 单向通信、双向交替通信和双向同时通信 

<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231206103342.png?" alt="image.png" style="zoom:40%;" />


## 编码与调制

### 编码与调制的基本概念 

1. 消息、数据和信号 
	- 消息：在计算机网络中，需要由计算机处理和传输的文字、图片、音频和视频等内容
	- 数据：消息输入计算机后，就成为了有意义的符号序列，是运送消息的实体
	- 信号：计算机中的网卡将比特0和比特1变换成相应的信号（signal)发送到传输媒体，信号课看作数据的电磁表现

2. 基带信号
	由信源发出的原始信号称为基带信号，也就是基本频带信号。例如，由计算机输出的表示各种文字、图像、音频或视频文件的数字信号都属于基带信号。基带信号往往包含较多的低频成分，甚至包含（由连续个“0”或连续个“1”造成的）直流成分，而许多信道并不能传输这种低频分量或直流分量。因此，需要对基带信号进行**调制**（modulation)后才能在信道上传输。 

3. 调制和编码

	- 基带调制：对数字基带信号的波形进行**变换**，使其能够与信道特性相适应，调制后的信号仍然是数字基带信号。由于基带调制是把数字信号转换成另一种形式的数字信号，因此基带调制也称为**编码**（coding) 
	- 带通调制：将数字基带信号的频率范围搬移到较高的频段，并转换为模拟信号，使其能够在模拟信道中传输。 

	<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231206110906.png?" alt="image.png" style="zoom:50%;" />

4. 码元
信号的编码单元称为码元。 
- 对于模拟信号，载波参数（振幅、频率、初相位）的变化就是一个码元。 
- 对于数字信号，一个数字脉冲就是一个码元。 
	<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231206110952.png?" alt="image.png" style="zoom:50%;" />


### 常用编码方式 

这部分先忽略


### 基本的带通调制方法和混合调制方法 

1. 基本的带通调制方法 
基本的带通调制方法有：调幅、调频和调相， 

<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231206111235.png?" alt="image.png" style="zoom:50%;" />

2. 混合调制方法

1个码元可以表示多个比特的信息量，载波的相位和振幅可以结合起来 一起调制，例如**正交振幅调制** 

## 信道的极限容量

<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231206111558.png?" alt="image.png" style="zoom:50%;" />

造成信号失真的主要因素如下： 
- 码元的传输速率：传输速率越高，信号经过传输后的失真就越严重。 
- 信号的传输距离：传输距离越远，信号经过传输后的失真就越严重。 
- 噪声干扰：噪声干扰越大，信号经过传输后的失真就越严重。 
- 传输媒体的质量：质量越差，信号经过传输后的失真就越严重。 

### 奈式准则

略
### 香农公式

略

## 信道复用技术

**复用**：就是在一条传输媒体上同时传输多路用户的信号。 


1. 频分复用 

	<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231206112146.png?" alt="image.png" style="zoom:50%;" />


2. 时分复用

	<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231206112203.png?" alt="image.png" style="zoom:50%;" />

3. 波分复用

	<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231206112219.png?" alt="image.png" style="zoom:50%;" />


4. 码分复用

**码分复用**（Code Division Multiplexing,CDM)常称为**码分多址**（Code Division Multiple Access,CDMA),它是在扩频通信技术的基础上发展起来的一种**无线通信技术**。 与FDM和TDM不同，CDMA的每个用户可以在相同的时间使用相同的频带进行通信。 

# 数据链路层

## 链路、数据链路和帧 

- 链路（Link)是指从一个节点到相邻节点的一段物理线路（有线或无线）,而**中间没有任何其他的交换节点**。 
- 数据链路（Data Link)是基于链路的。当在一条链路上传送数据时，除需要链路本身，还需要一些必要的通信协议来控制这些数据的传输，把**实现这些协议的硬件和软件加到链路上**，就构成了数据链路。 
- 计算机中的网络适配器（俗称**网卡**）和其相应的**软件驱动程序**就实现了这些协议。**一般的网络适配器都包含了物理层和数据链路层这两层的功能。**
- 帧（Frame)是**数据链路层**对等实体之间在水平方向进行逻辑通信的**协议数据单元PDU**。 

	<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231206113255.png?" alt="image.png" style="zoom:50%;" />

## 数据链路层的三个重要问题 

封装成帧和透明传输 
- 数据链路层给上层交付下来的协议数据单元PDU添加帧首部和帧尾部，这称为**封装成帧**。

	<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231206114724.png?" alt="image.png" style="zoom:50%;" />


- 如果能够采取措施，使得数据链路层对上层交付的PDU的内容没有任何限制，就好像数据链路层不存在一样，就称其为**透明传输**。
	- 字节填充 --->其实就是在帧交付给**物理层之前**对**数据载荷**扫描每出现一个帧定界符就插入了转移字符
		<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231206114801.png?" alt="image.png" style="zoom:50%;" />
	- 比特填充 --->其实就是在帧交付给**物理层之前**对**数据载荷**扫描,只要出现连续的5个比特1，就在其后填入一个比特0，这样就不会包含帧定界符了

<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231206114834.png" alt="image.png" style="zoom:50%;" />


差错检测
- 帧在传输的过程中可能出现误码。 
- 接收方根据发送方添加在帧尾部中的检错码，可以检测出帧是否出现了误码。 

1. 奇偶检验

	**奇校验**是在待发送的数据后面添加1个校验位，使整个数据（包括所添加的校验位在内）中“1”的个数为奇数。 
	**偶校验**是在待发送的数据后面添加1个校验位，使整个数据（包括所添加的校验位在内）中“1”的个数为偶数。 
<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231206150921.png" alt="image.png" style="zoom:50%;" />


2.循环冗余校验 
循环冗余校验CRC的基本思想如下： 
- 收发双方约定好一个生成多项式$G(X)$。 
- 发送方基于待发送的数据和生成多项式$G(X)$,计算出差错检测码，即冗余码，将冗余码添加到待发送数据的后面一起传输。 
- 接收方收到数据和冗余码后，通过生成多项式$G(X)$来计算收到的数据和冗余码是否产生了误码。 


- 奇偶校验、循环冗余校验等差错检测技术，只能检测出传输过程中出现了差错，但并不能**定位错误**，因此**无法纠正错误**。 
- 要想纠正传输中的差错，可以使用冗余信息更多的**纠错码**(例如海明码）进行**前向纠错**。但纠错码的开销比较大，在**计算机网络中较少使用**。 
- 在计算机网络中，通常采用我们后续课程中将要介绍的**检错重传方式来纠正传输中的差错，或者仅仅丢弃检测到差错的帧**，这取决于数据链路层向其上层提供的是可靠传输服务还是不可靠传输服务。 
- 循环冗余校验CRC具有很好的检错能力(**漏检率极低**）,虽然计算比较复杂，但非常易于用**硬件实现**，因此被广泛应用于数据链路层。 


可靠传输
- **不可靠传输服务**：收到有误码的帧，直接丢弃，其他什么也不做；未收到发送方发送的帧，也不进行任何处理。 
- **可靠传输服务**：实现发送方发送什么，接收方最终都能正确收到。 

- 一般情况下，**有线链路的误码率比较低**。为了减小开销，**并不要求数据链路层向其上层提供可靠传输服务**。即使出现了误码，可靠传输的问题由其上层处理。 
- **无线链路**易受干扰，**误码率比较高**，因此**要求数据链路层必须向其上层提供可靠传输服务**。 


## 停止-等待协议 

<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231207100616.png?" alt="image.png" style="zoom:70%;" />
所谓停止-等待（Stop-and-Wait,SW),就是指发送方每发送完一个数据 分组就必须**停下**来，等待接收方发来的确认（Acknowledgement,ACK)或否认（Negative Acknowledgement,NAK)分组。

接收方收到发送方的数据分组后，通过差错检测技术可检测出数据分组是否存在误码。 
- 如果没有误码，就接受该数据分组，并给发送方发送ACK分组。发送方收到ACK分组后就可以发送下一个数据分组。 
- 如果存在误码，就丢弃该数据分组，并给发送方发送NAK分组，发送方收到NAK分组后就会重传之前出现误码的这个数据分组。 


> [!attention] 【注意事项】 
> - 使用超时重传机制后，就可以不使用否认机制了，这样可使协议实现起来更加简单。但是，如果点对点链路的误码率较高，**使用否认机制可以使发送方在超时计时器超时前就尽快重传**。 
> - 为了让接收方能够判断所收到的数据分组是否是重复的，需要给**数据分组编号**。由于**停止-等待协议**的特性，只需**1个比特编序号**即可，即序号0和序号1。 
> - 为了让发送方能够判断所收到的确认分组是否是重复的，需要给**确认分组编号**，所用比特数量**与数据分组所用比特数量一样**。 
> 	- 数据链路层一般不会出现确认分组迟到的情况，因此在**数据链路层实现停止-等待协议可以不用给确认分组编号**。 
> - 给超时计时器设置的超时重传时间RTO应当仔细选择，一般将RTO设置为略大于收发双方的平均往返时间RTT。 
> 	- 在数据链路层，点对点的往返时间RTT比较固定，RTO就比较好设定。 
> 	- 在运输层，由于端到端往返时间非常不确定，设置合适的超时重传时间RTO有时并不容易。 
> - 停止-等待协议属于自动请求重传（Automatic Repeat reQuest,**ARQ**)协议。即重传的请求是发送方自进行的，而不是接收方请求发送方重传某个误码的数据分组。 


## 回退N帧协议 

<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231207112316.png?" alt="image.png" style="zoom:70%;" />

回退N帧协议在**流水线传输**的基础上，利用**发送窗口**来限制发送方连续发送数据分组的数量，是一种**连续ARQ协议**。 在回退N帧协议的工作过程中，发送窗口和接收窗口不断向前滑动，因此这类协议又称为滑动窗口协议。 在信道质量较差（容易出现误码）的情况下，回退N帧协议的信道利用率并不比停止-等待协议的信道利用率高。 

**发送方**：
- 发送窗口WT的取值范围是$1<W_T≤（2^{n-1})$, 其中，n是构成分组序号的比特数量。 
	- 如果$W_T$=1  变成了停止-等待协议 
	- 如果$W_T>(2_{n-1})$  接收方**无法分辨新旧数据分组** 
- 可在未收到接收方确认分组的情况下，将序号落入发送窗口内的多个数据分组全部发送出去。 
- 只有收到对已发送数据分组的确认分组时，发送窗口才能向前滑动到相应位置。 
- 收到多个**重复确认**时，可在重传计时器超时前尽早开始重传，由具体实现决定。 
- 发送窗口内某个已发送的数据分组产生超时重传时，发送窗口内该数据分组的后续已发送的数据分组也必须全部重传，这就是回退N帧（**G**o-**b**ack-**N**,**GBN**) 协议名称的由来。 


捎带确认
	在计算机通信中，当一个数据帧到达的时候，接收方并不是立即发送一个单独的**控制帧**，而是**抑制一下自己并且开始等待**，直到网络层传递给它下一个分组。然后，确认信息被**附在往外发送的数据帧上**（使用帧头中的ask域）。实际上，确认报文搭了下一个外发数据帧的便车。这种“将确认暂时延迟以便可以钩到下一个外发数据帧”的技术称为 **捎带确认(piggybacking)。   
	当主机收到远程主机的TCP数据包之后，通常不马上发送ACK数据包，而是等上一个短暂的时间，如果这段时间里面主机还有发送到远程主机的TCP数据包，那么就把这个ACK数据包“捎带”着发送出去，把本来两个TCP数据包整合成一个发送

**接收方**：
- 接收窗口$W_R=1$的，因此只能按序接收数据分组。
- 只接收序号落入接收窗口内且无误码的数据分组，并且将接收窗口向前滑动一个位置，与此同时给发送方发送相应的确认分组。 
- 为了减少开销，接收方不必每收到一个按序到达且无误码的数据分组就给发送方发送一个相应的确认分组。 
	- 可以在连续收到多个按序到达且无误码的数据分组后(数量由具体实现决定）,才针对最后一个数据分组发送确认分组，这称为**累积确认**。 
	- 或者可以在自己有数据分组要发送时才对之前按序接收且无误码的数据分组进行**捎带确认**。 
- 接收方收到未按序到达的数据分组后，除丢弃外，还可对之前最后一个按序到达的数据分组进行重复确认，以便发送方尽快重传。 


## 选择重传协议

<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231207113730.png?、" alt="image.png" style="zoom:70%;" />
为了进一步提高信道利用率，可以设法**只重传出现差错的数据分组**，这就需要接收窗口的尺寸大于1,以便先收下失序但正确到达接收方且序号落入接收窗口内的数据分组，等到所缺数据分组收齐后再一并送交上层，这就是选择重传（Selective Repeat,SR)协议。 

用$n(n>1)$个比特给分组编号，发送窗口$W_T$与接收窗口WR的关系如下： 

<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231207114344.png?" alt="image.png" style="zoom:50%;" />

**发送方:** 
- 可在未收到接收方确认分组的情况下，将序号落入发送窗口内的多个数据分组全部发送出去。 
- 只有按序收到对已发送数据分组的确认分组时，发送窗口才能向前滑动到相应位置。 
- 如果收到未按序到达的确认分组，应对其进行记录， 以防止其相应数据分组的超时重发，但发送窗口不能向前滑动。 

 **接收方:** 
- 可接收未按序到达但没有误码并且序号落入接收窗口内的数据分组。 
- 为了使发送方仅重传出现差错的分组，接收方不再采用累积确认，而需要对每一个正确接收到的数据分组进行逐一确认。 
- 只有在按序接收数据分组后，接收窗口才能向前滑动到相应位置。 

## 点对点协议

PPP协议是因特网工程任务组IETF于1992年制定的。经过多次修订，目前PPP协议已成为因特网的正式标准`[RFC1661,RFC1662]`。PPP协议主要有两种应用： 
- 因特网用户的计算机通过点对点链路连接到某个ISP进而接入因特网，用户计算机与ISP通信时所采用的数据链路层协议一般就是PPP协议，例如图3-27(a)所示。 
- 广泛应用于广域网路由器之间的专用线路，如图所示。 

<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231207120327.png?" alt="image.png" style="zoom:50%;" />
PPP协议由3部分组成：一个链路控制协议LCP,一个网络层PDU封装到串行链路的方 法，一套网络控制协议NCP。 

|  网络层   |                                                                                 <div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;TCP/IP中的IP&nbsp;</div><div>Novell NetWare网络操作系统中的IPX&nbsp;</div><div>&nbsp; &nbsp; &nbsp;Apple公司的AppleTalk</div>                                                                                 |
| :----: | :---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------: |
| 数据链路层  | <div>&nbsp; &nbsp; &nbsp; &nbsp;一套网络控制协议NCP&nbsp;</div><div><span style="background-color: var(--background-popover); color: var(--text-normal); font-family: var(--font-interface); font-size: var(--font-ui-medium);">PPP&nbsp;</span>一个网络层PDU封装到串行链路的方法&nbsp;</div><div>&nbsp; &nbsp; &nbsp; 一个链路控制协议LCP&nbsp;</div> |
|  物理层   |                                                                                                       <div>&nbsp; &nbsp; &nbsp; &nbsp;面向字节的异步链路&nbsp;</div><div>&nbsp; &nbsp; &nbsp; &nbsp;面向比特的同步链路&nbsp;</div>                                                                                                        |

### PPP协议的帧格式 


<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231207121244.png?" alt="image.png" style="zoom:50%;" />


- 标志 (Flag)字段：PPP帧的定界符，取值为`0x7E`。 
- 地址 (Address)字段：取值为`0xFF`,预留（目前没有什么作用） 
- 控制 (Control)字段：取值为`0x03`,预留（目前没有什么作用） 
- 协议 (Protocol)字段：其值用来指明帧的数据载荷应向上交付给哪个协议处理。 
- 帧检验序列（Frame Check Sequence,FCS)字段：其值是使用循环冗余校验CRC计算出的检错码。 

   

### PPP帧的透明传输 

面向字节的异步链路使用字节填充来实现透明传输`[RFC1662]` 
	<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231207121427.png?" alt="image.png" style="zoom:50%;" />

发送方的处理： 
1. 将数据载荷中出现的每一个`0x7E`减去`0x20`(相当于异或`0x20`),然后在其前面插入转义字符`0×7D`。 
2. 若数据载荷中原来就含有`0x7D`,则把每一个`0x7D`减去`0x20`,然后在其前面插入转义字符`0x7D`。 
3. 将数据载荷中出现的每一个ASCII码控制字符（即数值小于`0x20`的字符）加上`0x20`(相当于异或`0x20`,将其转换成非控制字符）,然后在其前面插入转义字符`0x7D`。 

接收方的处理： 
进行**与发送方相反的变换**，就可以正确地恢复出未经过字节填充的原始数据载荷。 

面向比特的同步链路使用零比特填充来实现透明传输 
	<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231207121608.png?" alt="image.png" style="zoom:50%;" />


发送方的处理： 
	对帧的数据载荷进行扫描（一般由硬件完成）,每出现**5个连续的比特1**,则在**其后填充一个比特0**。 
接收方的处理： 
	对帧的数据载荷进行扫描，每出现**5个连续的比特1**时，就把**其后的一个比特0删除**。 

### PPP的工作状态 

**以用户主机拨号接入因特网服务提供者ISP的拨号服务器的过程为例** 

<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231207121733.png" alt="image.png" style="zoom:40%;" />
## 共享式以太网

- 以太网（**Ethernet**) 以曾经被假想的电磁波传播介质——**以太**（Ether)来命名。 
- 以太网最初采用无源电缆（不包含电源线）作为共享总线来传输帧，属于基带总线局域网，传输速率为2.94Mb/s。 

以太网目前已经从传统的**共享式以太网**发展到**交换式以太网**，传输速率已经从10Mb/s提高到100Mb/s、1Gb/s甚至10Gb/s。我们会首先介绍最早流行的传输速率为10Mb/s的共享式以太网的相关知识。 


## 网络适配器和MAC地址 

### 网络适配器 


<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231207151203.png?" alt="image.png" style="zoom:40%;" />


- 要将计算机连接到以太网，需要使用相应的**网络适配器**（Adapter),网络适配器一般简称为“**网卡**”。 
- 在计算机内部，**网卡与CPU**之间的通信，一般是通过计算机主板上的I/O总线以**并行传输**方式进行。 
- **网卡与外部以太网**（局域网）之间的通信，一般是通过传输媒体（同轴电缆、双绞线电缆、光纤）以**串行方式**进行的。 
- 网卡除要**实现物理层和数据链路层功能**，其另外一个重要功能就是要进行**并行传输和串行传输**的转换。由于网络的传输速率和计算机内部总线上的传输速率并不相同，因此在网卡的核心芯片中都会包含用于 缓存数据的存储器。 
- 在确保网卡硬件正确的情况下，为了使网卡正常工作，还必须要在计算机的操作系统中为网卡安装相应 的设备驱动程序。**驱动程序**负责驱动网卡发送和接收帧。 

### MAC地址

- **MAC地址**一般被固化在网卡的电可擦可编程只读存储器EEPROM中，因此MAC地址也被称为硬件地址。 命令提示符MAC地址有时也被称为物理地址。 
- 不要被物理地址中的“物理"二字误导，误认为物理地址属于网络体系结构中物理层的范畴。物理地址属于数据链路层范畴。 

- 一般情况下，普通用户计算机中往往包含两块网卡： 
	- 一块是用于接入有线局域网的**以太网卡** 
	- 另一块是用于接入无线局域网的**Wi-Fi网卡** 
- 每块网卡都有一个**全球唯一的MAC地址**。 
- 交换机和路由器往往具有更多的网络接口，所以会拥有更多的MAC地址。 

综上所述，严格来说，MAC地址是对网络上**各接口**的唯一标识，而不是对网络上各设备的唯一标识。 


<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231207151507.png?" alt="image.png" style="zoom:30%;" />

<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231207151610.png?" alt="image.png" style="zoom:30%;" />

- 网卡从网络上每收到一个无误码的帧，就检查帧首部中的目的MAC地址，按以下情况处理： 
	- (1)如果目的MAC地址是广播地址（FF-FFFFFFFFF),则接受该帧。 
	- (2)如果目的MAC地址与网卡上固化的全球单播MAC地址相同，则接受该帧。 
	- (3)如果目的MAC地址是网卡支持的多播地址，则接受该帧。 
	- (4)除上述（1)、（2)和（3)情况外，丢弃该帧。 
- 网卡还可被设置为一种特殊的工作方式：**混杂方式**（Promiscuous Mode)。工作在混杂方式的网卡，只要收到共享媒体上传来的帧就会收下，而不管帧的目的MAC地址是什么。 
	- 对于网络维护和管理人员，这种方式可以监视和分析局域网上的流量，以便找出提高网络性能的具体措施。 
	- **嗅探器**（Sniffer)就是一种工作在混杂方式的网卡，再配合相应的工具软件（WireShark),就可以作为一种非常有用的网络工具来学习和分析网络。 
	- 混杂方式就像一把“双刃剑”，黑客常利用这种方式非法获取网络用户的口令。 

## CSMA/CD协议 

**CSMA/CD协议的基本原理** 
- 在以太网的发展初期，人们普遍认为“无源的电缆线比有源器件可靠”，因此将多个站点连接在一条总线上来构建**共享总线以太网**。 
- 共享总线以太网具有**天然的广播特性**，即使总线上某个站点给另一个站点发送单播帧，表示帧的信号也会沿着总线传播到总线上的其他各站点。 
- 当某个站点在总线上发送帧时，总线资源会被该站点独占。此时，如果总线上的其他站点也要在总线上发送帧，就会产生信号碰撞。 
- 当两个或多个站点同时使用总线发送帧时，就会产生**信号碰撞**。 
- 为了解决各站点争用总线的问题，共享总线以太网使用了一种专用协议CSMA/CD,它是载波监听多址接入碰撞检测（Carrier Sense Multiple Access Collision Detection)的英文缩写词。 

**CSMA/CD协议的要点如下**： 
1. 多址接入：多个站点连接在一条总线上，它们竞争使用总线。 
2. 载波监听：每一个站点在发送帧之前，先要检测一下总线上是否有其他站点在发送帧。若检测到总线空闲96比特时间（即发送96比特所耗费的时间）,则发送帧；若检测到总线“忙”，则继续检测并等待总线转为空闲96比特时间后发送帧。因此，可将载波监听比喻为“先听后说”。 
3. 碰撞检测：每一个正在发送帧的站点必须“边发送帧边检测碰撞”。一旦发现总线上出现碰撞，就立即停止发送，退避一段随机时间后再次从载波监听开始进行发送。因此，可将碰撞检测比喻为“边说边听，一旦冲突，立即停说，等待时机，重新再说”。 

<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231207153950.png?" alt="image.png" style="zoom:40%;" />


- 载波监听检测到总线空闲，但**总线并不一定空闲**。 
- 使用CSMA/CD协议的共享总线以太网上的各站点，只是尽量避免碰撞并在出现碰撞时做出退避后重发的处理，但**不能完全避免碰撞**。 
- 在使用CSMA/CD协议时，由于正在发送帧的站点必须“边发送帧边检测碰撞”，因此站点不可能同时进行发送和接收，也就是不可能进行全双工通信，而**只能进行半双工通信**（双向交替通信）。 

## MTU

MTU(Maximum Transmission Unit)是指**数据链路层中的最大传输单元** 
通俗点来讲，MTU是指数据链路层能够**传输的最大数据帧的大小**（以字节为单位） 

<img src="https://img-blog.csdnimg.cn/976b5e8d92c94a0c829e138a62333079.png" alt="image.png" style="zoom:90%;" />
为什么需要MTU? 
我们知道，**数据在数据链路层中通常是以数据帧（Frame)的形式来传输** 
因为传输的Frame不可能无限大（传小的可以）,那么一次传多大的Frame最合适、最高效就成了一个需要考虑的问题 所以说我们要设定一个值（也就是MTU),这个值用来限制Frame的大小 

MTU越大，开销越小 
这句话是很容易理解的，更大的Frame意味着包含的有效数据也就更多我一次能传更多的数据了，那么传输次数就少了，在网络上的开销就变小了
较小的MTU值可以减少网络延迟 
如果MTU设置的很大，意味着一次能传更大的数据了，那**占据链路的时间就会更长**，所以总体上网络延迟就会变大 而且如果一大段数据里面有一个bit出错了，这一大段就会整个重传，重传的代价是很大的  


早期的以太网使用共享链路的工作方式，为了保证**CSMA/CD(载波多路复用冲突检测机制**，规定了以太帧长度最小为64字节，最大为1518字节 
- 最小64字节是为了保证最极端的冲突能被检测到，64字节是能被检测到的最小值 
- 最大不超过1518字节是为了防止过长的帧传输时间过长而占用共享链路太长时间导致其他业务阻塞 

<img src="https://img-blog.csdnimg.cn/2830542410a642c4b4c379a9b1d1eeff.png" alt="image.png" style="zoom:70%;" />
18 字节用于帧头和帧尾，其中 CRC 校验占据4字节，剩下的 1500 字节就是最大数据载荷（Payload）
因此，1500 字节被定义为以太网数据帧中数据部分的最大长度（MTU）

如果发送的数据大于 MTU，则就会进行**分片操作**；如果小于MTU，就会在实际数据内容后面添加填充数据，使得数据包总长度达到最小长度要求

## 共享式以太网的争用期
 
<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231207155124.png?" alt="image.png" style="zoom:40%;" />

## 争用期

略

## 使用集线器的共享式以太网 


<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231207161718.png?)" alt="image.png" style="zoom:50%;" />

> 若总线上的某个机械连接点接触不良或断开，则整个网络通信就不稳定或彻底断网。 



- 在使用细同轴电缆的共享总线以太网之后，以太网发展出来了一种使用大规模集成电路来替代总线、并且可靠性非常高的设备，叫作**集线器**（ Hub)。 
- 站点连接到集线器的传输媒体也转而使用更便宜、更灵活的**双绞线电缆**。 
- 集线器的一些主要特点如下： 
	- 使用集线器的以太网虽然物理拓扑是星型的，但在逻辑上仍然是一个总线网。总线上的各站点共享总线资源，使用的还是CSMA/CD协议。 
	- 集线器**只工作在物理层**，它的每个接口仅简单地转发比特，并不进行碰撞检测。碰撞检测的任务由各站点中的网卡负责。 
	- 集线器一般都有**少量的容错能力和网络管理功能**。例如，若网络中某个站点的网卡出现了故障而不停地发送帧，集线器可以检测到这个问题，在内部断开与出故障网卡的连线，使整个以太网能正常工作。 

<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231207162112.png?" alt="image.png" style="zoom:50%;" />

<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231207162148.png?" alt="image.png" style="zoom:40%;" />



> [!summary] 集线器的一些主要特点如下： 
> - 使用集线器的以太网虽然物理拓扑是星型的，但在逻辑上仍然是一个总线网。总线上的各站点共享总线资源，使用的还是CSMA/CD协议。 
> - 集线器只工作在物理层，它的每个接口仅简单地转发比特，并不进行碰撞检测。碰撞检测的任务由各站点中的网卡负责。 
> - 集线器一般都有少量的容错能力和网络管理功能。例如，若网络中某个站点的网卡出现了故障而不停地发送帧，集线器可以检测到这个问题，在内部断开与出故障网卡的连线，使整个以太网仍然能正常工作。 

## 在物理层扩展以太网 
略

## 在数据链路层扩展以太网 


网桥内部的主要结构如图所示。网桥一般具有两个接口，用于连接两个不同的以太网，这样就可形成一个覆盖范围更大、站点数量更多的以太网，而原来的每个以太网就称为网段（Segment)。图所示的网桥的接口1和接口2分别连接了一个网段。 

<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231207163704.png?" alt="image.png" style="zoom:50%;" />

1. 若网桥从接口1收到主机B给主机D发送的帧，则在转发表中查找主机D的目的MAC地址D,根据查找结果可知，应从接口2转发该帧，于是就把该帧从接口2转发给另一个网段，使主机D能够收到该帧。 
2. 若网桥从接口1收到主机C发给主机A的帧，根据查表结果可知，应从接口1转发该帧给主机A,然而网桥正是从接口1收到该帧的，这表明主机C和主机A在同一网段中，主机A能够直接收到这个帧而不需要依靠网桥的转发，因此网桥会丢弃该帧。 
3. 当网桥收到一个广播帧时（目的MAC地址为FF-FF-FF-FF-FF-FF),不用查找转发表，而是会通过除接收该帧的接口的其他接口转发该广播帧。 

## 透明网桥的自学习和转发帧的流程 

- 透明网桥（Transparent Bridge)通过**自学习**算法建立转发表。 
- 透明网桥中的“**透明**”，是指以太网中的各站点并不知道自己所发送的帧将会经过哪些网桥的转发，最终到达目的站点。也就是说，**以太网中的各网桥对于各站点而言是看不见的**。 
- 透明网桥的标准是IEEE 802.1D,它通过一种自学习算法**基于以太网中各站点间的相互通信**逐步建立起自己的转发表。 
	1. 网桥收到帧后进行**登记**（即自学习）,登记的内容为帧的**源MAC地址**和进入网桥的**接口号**。 
	2. 网桥根据帧的目的MAC地址和网桥的转发表对帧进行转发，包含以下三种情况： 
		- **明确转发**：网桥知道应当从哪个接口转发帧。 
		- **盲目转发**：网桥不知道应当从哪个接口转发帧，只能将其通过除进入网桥的接口外的其他所有接口转发。 
		- 丢 弃：网桥知道不应该转发该帧，将其丢弃。 

请注意： 
1. 如果网桥收到有**误码的帧**则直接丢弃。 
2. 如果网桥收到一个无误码的**广播帧**，则不用进行查表，而是直接从除接收该广播帧的接口的**其他接口转发**该广播帧。 
3. 转发表中的每条记录都有其**有效时间，到期自动删除**！这是因为各站点的MAC地址与网桥接口的对应关系不是永久性的，例如某个站点更换了网卡，其MAC地址就会改变。 


**透明网桥的生成树协议STP** 
- 为了提高以太网的**可靠性**，有时需要在两个以太网之间使用多个透明网桥来提供**冗余链路**。 
- 在增加兄余链路提高以太网可靠性的同时，却给网络引入了**环路**。 
- 网络中的**广播帧将在环路中永久兜圈**，造成广播帧充斥整个网络，**网络资源被白白浪费**，而网络中的主机之间无法正常通信！ 
- 为了避免广播帧在环路中永久兜圈，透明网桥使用**生成树协议**（Spanning Tree Protocol,STP),可以在增加冗余链路提高网络可靠性的同时，又避免环路带来的问题。 
	- 不管网桥之间连接成了怎样复杂的带环拓扑，网桥之间通过**交互网桥协议单元**（Bridge Protocol Data Unit, BPDU),**找出原网络拓扑的一个连通子集（即生成树）**,在这个子集里整个连通的网络中不存在环路。 
	- 当首次连接网桥或网络拓扑发生变化时（人为改变或出现故障）,网桥都会重新构造生成树，以确保网络的连通。 


## 以太网交换机 
- 以太网**交换机**（以下简称交换机）本质上就是一个**多接口的网桥**： 
	- 交换机自学习和转发帧的流程与网桥是相同的。 
	- 另外，交换机也使用生成树协议STP,来产生能够连通全网但不产生环路的通信路径。 
- 交换机的每个接口可以连接**计算机**，也可以连接**集线器**或另一个**交换机**。 
	- 当交换机的**接口与计算机或交换机连接**时，可以工作在**全双工方式**，并能在**自身内部同时连通多对接口**，使每一对相互通信的计算机都能像独占传输媒体那样，无碰撞地传输数据，这样就**不需要使用CSMA/CD协议了**。 
	- 当交换机的**接口连接的是集线器**时，该接口就**只能使用CSMA/CD协议**并只能工作在半双工方式。 
	- 现在的交换机和计算机中的网卡都能自动识别上述两种情况，并自动切换到相应的工作方式。 
- 交换机一般都具有多种速率的接口，例如10Mb/s、100Mb/s、1Gb/s甚至10Gb/s的接口，大部分接口支持多速率自适应。 
- 一般的交换机都采用“**存储转发**”方式，为了减小交换机的转发时延，某些交换机采用了**直通**（Cut-Through)交换方式。 
- 采用**直通交换方式**的交换机，在**接收帧的同时就立即按帧的目的MAC地址决定该帧的转发接口**，然后通过其内部**基于硬件的交叉矩阵**进行转发，而不必把整个帧先缓存后再进行处理。 
	- 直通交换的**时延非常小**。 
	- 直通交换**不检查差错就直接将帧转发出去**，有可能会将一些无效帧转发给其他主机。 


## 以太网的MAC帧格式 

以太网V2的MAC帧由目的地址、源地址、类型、数据以及FCS这五个字段组成 

<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231208222848.png?" alt="image.png" style="zoom:50%;" />
- 目的地址和源地址字段分别为6字节长，用来填入帧的目的MAC地址和源MAC地址。 
- 类型字段为2字节长，其值用来指明数据字段中的内容是由上一层的哪个协议封装的，以便将收到的MAC帧的数据字段中的内容上交给上一层的这个协议。
- 数据字段的长度范围是46~1500字节，用来装载上层协议所封装的协议数据单元 (PDU)。由于以太网规定**最小帧长为64字节**，因此除去首部和尾部共18字节，数据字段的最小长度应为46字节。当数据字段的长度小于46字节时，数据链路层就会在数据字段的后面插入相应个填充字节，以确保MAC帧的长度不小于64字节。显然，有效的MAC帧长度为64~1518字节之间。 
- FCS字段的长度为4字节，它的内容是使用CRC生成的帧检验序列。接收方的网卡通过FCS的内容就可检测出帧在传输过程中是否产生了误码。 


## 虚拟局域网

### 诞生背景

- 交换式以太网中的所有站点都属于**同一个广播域**。 
- 随着交换式以太网规模的扩大，广播域也相应扩大。**巨大的广播域会带来一系列问题**。 
	- **广播风暴 广播风暴会浪费网络资源和各主机的CPU资源** 
	- 难以管理和维护，带来潜在的安全问题。 
- 网络中会频繁出现广播信息 
	- `TCP/IP`协议栈中的很多协议都会使用广播（例如地址解析协议ARP,路由信息协议RIPv1,动态主机配置协议DHCP) 
	- `NetBEUI`: Windows下使用的广播型协议 
	- `IPX/SPX`:Novell网络的协议栈 
	- `Apple Talk`: Apple公司的网络协议栈 

分割广播域的方法： 
- 使用**路由器**可以隔离广播域（**成本较高**） 
- 虚拟局域网技术应运而生 

<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231209095205.png?" alt="image.png" style="zoom:50%;" />

### 虚拟局域网VLAN概述 
- 虚拟局域网（Virtual Local Area Network,VLAN)是一种将局域网内的站点划分成与**物理位置无关的逻辑组**的技术，一个逻辑组就是一个VLAN,VLAN中的各站点具有某些共同的应用需求。 

<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231209095326.png?" alt="image.png" style="zoom:40%;" />

- 属于同一VLAN的站点之间可以直接进行通信，而不同VLAN中的站点之间不能直接通信。 
- 网络管理员可对局域网中的各交换机进行配置来建立多个逻辑上独立的VLAN。 
	- 连接在同一交换机上的多个站点可以属于不同的VLAN,而属于同一VLAN的多个站点可以连接在不同的交换机上。 
- **虚拟局域网VLAN并不是一种新型网络，它只是局域网能够提供给用户的一种服务**。 

### 虚拟局域网VLAN的实现机制 

虚拟局域网VLAN有多种实现技术，最常见的就是**基于以太网交换机的接口来实现VLAN**。这就需要以太网交换机能够实现以下两个功能： 
- 能够处理带有VLAN标记的帧，也就是**IEEE 802.1Q帧**。 
- 交换机的各接口可以支持**不同的接口类型**，不同接口类型的接口对帧的处理方式有所不同。 

IEEE 802.1Q帧也称为Dot One Q帧，它对以太网V2的MAC帧格式进行了扩展：在源地址字段和类型字段之 间插入了4字节的VLAN标签（tag)字段。 

<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231209101521.png?" alt="image.png" style="zoom:40%;" />

![image.png](http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231209101558.png?OSSAccessKeyId=LTAI5tBK1gnqyQLHK2d7sx6F&Expires=9000000001&Signature=hvJ6Z1641xRQNlkcshu6Qf8xRyI=)


- **标签协议标识符TPID**:长度为16比特，其值固定为0x8100,表示该帧是IEEE 802.1Q帧。 
- **优先级PRI**:长度为3比特，取值范围是0~7,值越大优先级越高。当网络阻塞时，设备优先发送优先级高的802.1Q帧。 
- **规范格式指示符CFI**:长度为1比特，取值为0表示MAC地址以规范格式封装，取值为1表示MAC地址以非规范格式封装。对于以太网，CFI的取值为0。 
- **虚拟局域网标识符VID**:长度为12比特，取值范围是0~4095,其中0和4095保留不使用。VID是802.1Q帧所属VLAN的编号，设备利用VID来识别帧所属的VLAN。 广播帧只在同一VLAN内转发，这样就将广播域限制在了一个VLAN内。 


802.1Q帧一般不由用户主机处理，而是由以太网交换机来处理： 
- 当交换机收到**普通的以太网MAC帧**时，会给其**插入4字节的VLAN标签使之成为802.1Q帧**，该处理简称为“**打标签**” 
- 当交换机**转发802.1Q帧**时，**可能会删除其4字节的VLAN标签使之成为普通的以太网MAC帧**，该处理简称为“**去标签**”。交换机转发802.1Q帧时也有可能不进行“去标签”处理，是否进行“去标签”处理取决于交换机的接口类型。 

Access接口 
Access接口一般用于**连接用户计算机**，由于其**只能属于一个VLAN**,因此Access接口的**PVID值与其所属VLAN的ID相同**，其默认值为1。 
- 接收处理 
	一般只接受“未打标签”的普通以太网MAC帧，根据接收帧的接口的PVID给帧“**打标签**”，即插入4字节的VLAN标签字段，VLAN标签字段中的VID取值就是接口的PVID值。 
- 转发处理 
	若帧中的VID值与接口的PVID值相等，则给帧“**去标签**”后再进行转发，否则不转发帧。因此，从Access接口转发出的帧，是不带VLAN标签的普通以太网MAC帧。 

Trunk接口 
Trunk接口一般用于**交换机之间的互连**。Trunk接口**可以属于多个VLAN**,即Trunk接口**可以通过属于不同VLAN的帧**。Trunk接口的默认PVID值为1,一般不建议用户修改，若互连的Trunk接口的PVID值不相等，则可能出现转发错误。 
- 接收处理 
	既**可以接收**“未打标签”的**普通以太网MAC帧**，也可以接收“已打标签”的**802.1Q帧**。若接收到普通以太网MAC帧时，根据接收帧的接口的PVID给帧“**打标签**”，这与Access接口的处理相同。 
- 转发处理 
	对于帧的VID值等于接口的PVID值的802.1Q帧，将其**“去标签”转发**；对于帧的VID值不等于接口的PVID值802.1Q帧，将其**直接转发**。因此，从Trunk接口转发出的帧，可能是普通以太网MAC帧，也可能是802.1Q帧。 

## 以太网的发展

- 100BASE-T以太网是指在双绞线上传输基带信号的速率为100Mb/s的以太网，也称为快速以太网（Fast Ethernet) 
- 100BASE-T以太网与10Mb/s标准以太网（传统以太网）一样，**仍然使用IEEE 802.3的帧格式和CSMA/CD协议**。 
- 100BASE-T以太网为了与10Mb/s标准以太网保持兼容，需要以太网最小帧长保持不变，即仍为64字节。 
	- 网段的最大电缆长度从1000m减小到100m 
	- 争用期缩短为5.12us 
	- 帧间最小间隔缩短为0.96us 
> 100BASE-T以太网还可以使用以太网交换机来提供比集线器更好的服务质量，即在全双工方式下无碰撞工作。因此，使用交换机的100BASE-T以太网，工作在**全双工方式**下，并不使用CSMA/CD协议。 

- **吉比特以太网**也称为**干兆以太网**（Gigabit Ethernet)。1998年，干兆以太网的标准**802.3z**成为正式标准。 
- 近几年来，干兆以太网已迅速占领市场，成为了以太网的主流产品。 
- IEEE 802.3z干兆以太网的主要特点有： 
	- 速率为1000Mb/s(1Gb/s) 
	- 使用IEEE 802.3的帧格式（与10Mb/s和100Mb/s以太网相同） 
	- 支持**半双工方式（使用CSMA/CD协议）和全双工方式**（不使用CSMA/CD协议） 
	- 兼容10BASE-T和100BASE-T技术 


- 2002年6月，IEEE802.3ae委员会通过**10吉比特以太网（10GE)**的正式标准，10GE也称为**万兆以太网**。 
- 万兆以太网并不是将干兆以太网的速率简单地提高了10倍。万兆以太网的目标是将以太网从**局域网范围**(校园网或企业网）**扩展到城域网与广域网**，成为城域网和广域网的主干网的主流技术之一。 
- IEEE 802.3ae万兆以太网的主要特点有： 
	- 速率为10Gb/s 
	- 使用IEEE 802.3标准的帧格式（与10Mb/s、100Mb/s和1Gb/s以太网相同） 
	- 保留IEEE 802.3标准对以太网最小帧长和最大帧长的规定。这是为了用户升级以太网时，仍能和较低速率的以太网方便地通信。 
	- 只工作在全双工方式而不存在争用媒体的问题，因此不需要使用CSMA/CD协议，这样传输距离就不再受碰撞检测的限制。 
	- 增加了支持城域网和广域网的物理层标准 


- 2010年，IEEE发布了**40吉比特/100吉比特以太网**（40GE/100GE)的IEEE 802.3ba标准，40GE/100GE也称为**四万兆/十万兆以太网**。 
- 为了使**以太网**能够更高效、更经济地**满足局域网、城域网和广域网的不同应用需求**，IEEE 802.3ba标准定义了 
- 两种速率类型： 
	- 40Gb/s主要用于**计算应用** 
	- 100Gb/s主要用于**汇聚应用** 
- IEEE 802.3ba标准**只工作在全双工方式（不使用CSMA/CD协议）**,但仍**使用IEEE 802.3标准的帧格式**并**遵守最小帧长和最大帧长的规定。** 

## 无线局域网

### 无线局域网的组成

802.11无线局域网可分为“有固定基础设施的”和“无固定基础设施的”两 大类


<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231209104639.png?" alt="image.png" style="zoom:50%;" />

<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231209104714.png?" alt="image.png" style="zoom:40%;" />

### 无线局域网的物理层

- 802.11无线局域网的物理层非常复杂，依据工作频段、调制方式、传输速率等，可将其分为多种物理层标准：
- 802.11无线网卡一般会被做成**多模**的，以便能适应多种不同的物理层标准，例如支持802.11b/g/n。 
- 无线局域网最初还使用红外技术（infrared,IR)和跳频扩频(Frequency Hopping Spread Spectrum,FHSS)技术，但目前已经很少使用了。 
- **跳频技术**的发明人，是好莱坞黄金时代的著名女星海蒂拉玛，跳频技术为CDMA和Wi-Fi等无线通信技术奠定了基础。 
- 因此，海蒂拉玛被誉为 "Wi-Fi之母" 
- 最近几年，802.11无线局域网又有一些新的物理层标准陆续推出： 

### 无线局域网的数据链路层

#### 802.11无线局域网使用CSMA/CA协议的原因 

- 对于802.11无线局域网，其使用无线信道传输数据，这与共享总线以太网使用有线传输介质不同。因此，802.11无线局域网**不能简单照搬**共享总线以太网使用的**CSMA/CD协议**。 
- 802.11无线局域网采用了另一种称为CSMA/CA的协议，也就是**载波监听多址接入/碰撞避免**（Carrier Sense Multiple Access/Collision Avoidance, **CSMA/CA**) 
- CSMA/CA协议**仍然采用**CSMA/CD协议中**的CSMA**,以“先听后说”的方式来减少碰撞的发生，但是**将“碰撞检测CD”改为了“碰撞避免CA”** 
- 尽管CA表示碰撞避免，但并不能避免所有的碰撞，而是尽量减少碰撞发生的概率。 

802.11无线局域网不采用“碰撞检测CD”的原因如下： 
- 由于**无线信道的传输环境复杂**且信号强度的动态范围非常大，在802.11无线网卡上**接收到的信号强度一般都远远小于发送信号的强度**，信号强度甚至相差百万倍。因此，**如果要在802.11无线网卡上实现碰撞检测，对硬件的要求非常高**。 
- 即使能够在硬件上实现碰撞检测功能，但由于无线电波传播的特殊性（**存在隐蔽站问题**）,**还会出现无法检测到碰撞的情况**，因此**实现碰撞检测并没有意义**。 

	<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231209105805.png?" alt="image.png" style="zoom:50%;" />

#### CSMA/CA协议的基本工作原理 

<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231209111826.png?" alt="image.png" style="zoom:50%;" />

1. 当源站要发送它的第1个数据帧时，若检测到信道空闲，则在等待DIFS间隔后就可发送。等待DIFS间隔是考虑到可能有其他的站有高优先级的帧要发送。现在假设没有其他高优先级帧要发送，因而源站就发送了自己的数据帧。 
2. 目的站若正确收到该帧，则经过SIFS间隔后，向源站发送确认帧（ACK)。若源站在重传计时器设置的超时时间内没有收到ACK,就必须重传之前已发送的数据帧，直到收到ACK为止，或者经过若干次的重传失败后放弃发送。 
图中还展示了其他站通过虚拟载波监听调整自己的**网络分配向量**（NAV,即信道被占用时长）的情况。在NAV这段时间内，若其他站也有帧要发送，就必须推迟发送。在NAV这段时间结束后，再经过一个DIFS间隔，然后还要退避一段随机时间后才能发送帧。 

**信道预约** 

1. 源站在发送数据帧之前先发送一个短的控制帧，称为请求发送（Request To Send,RTS)。RTS帧包括源地址、目的地址和本次通信（包括目的站发回确认帧所需的时间）所需的持续时间。请读者注意，源站在发送RTS帧之前，必须先检测信道。若信道空闲，则等待DIFS间隔后，就能够发送RTS帧了。 
2. 若目的站正确收到源站发来的RTS帧，且媒体空闲，等待SIFS间隔后就发送一个响应控制帧，称为允许发送（Clear To Send,CTS)。CTS帧也包括本次通信所需的持续时间（从RTS帧中将此持续时间复制到CTS帧中）。 
3. 源站收到CTS帧后，再等待SIFS间隔后，就可发送数据帧。 
4. 若目的站正确收到了源站发来的数据帧，则等待SIFS间隔后，就向源站发送确认帧。 

	<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231209112300.png?" alt="image.png" style="zoom:50%;" />
#### 无线局域网的MAC帧 

数据帧
- 用于在站点间传输数据 


控制帧 
- 通常与数据帧搭配使用 
- 负责区域的清空、虚拟载波监听的维护以及信道的接入，并于收到数据帧时予以确认。 
- ACK帧、RTS帧以及CTS帧等都属于控制帧。 

管理帧
- 用于加入或退出无线网络，以及处理AP之间连接的转移事宜。 
- 信标帧、关联请求帧以及身份认证帧等都属于管理帧。 

**无线局域网的数据帧格式** 

<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231209114922.png?" alt="image.png" style="zoom:40%;" />

<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231209115058.png?" alt="image.png" style="zoom:50%;" />

# 网络层

## 网络层概述

网络层的主要任务就是**将分组从源主机经过多个网络和多段链路传输到目的主机**，可以将该任务划分为**分组转发**和**路由选择**两种重要的功能。 

**分组转发**：当路由器从自己的某个接口所连接的链路（或网络）上收到一个分组后，将该分组 从自己其他适当的接口转发给下一跳路由器或目的主机。
**路由选择**：源主机和目的主机之间可能存在多条路径，网络层需要决定选择哪一条路径来传送分组。 

**网络层向其上层提供的两种服务** 

| 对比方面 |           虚电路服务           |           数据报服务           |
| :--: | :-----------------------: | :-----------------------: |
| 核心思想 |      可靠通信应当由网络自身来保证       |      可靠通信应当由用户主机来保证       |
|  连接  |         必须建立网络层连接         |        不需要建立网络层连接         |
| 目的地址 | 仅在连接建立阶段使用，之后每个分组使用短的虚电路号 |     每个分组都必须携带完整的目的地址      |
| 分组转发 |   属于同一条虚电路的分组均按同一路由进行转发   |        每个分组可走不同的路由        |
| 节点故障 |    所有通过出故障的节点的虚电路均不能工作    | 出故障的节点可能会丢失分组，一些路由可能会发生变化 |
| 分组顺序 |       总是按发送顺序到达目的主机       |      到达目的主机时不一定按发送顺序      |
| 服务质量 | 可以将通信资源提前分配给每一个虚电路，因此容易实现 |           很难实现            |


<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231209122202.png?" alt="image.png" style="zoom:50%;" />



## 网际协议IP

网际协议IP(即IP协议）是TCP/IP体系结构网络层中的核心协议， 因此TCP/IP体系结构的网络 层常被称为网际层或IP层。在网际层中，与IP协议配套使用的还有以下四个协议： 
- 地址解析协议（Address Resolution Protocol,ARP) 
- 逆地址解析协议（Reverse Address Resolution Protocol, RARP) 
- 网际控制报文协议（Internet Control Message Protocol,ICMP) 
- 网际组管理协议（ Internet Group Management Protocol, IGMP) 

### 异构网络互连 

因特网是由全世界范围内数以百万计的网络通过路由器互连起来的。这些网络的拓扑、性能以及所使用的网络协议都不尽相同，这是由用户需求的多样性造成的，没有一种单一的网络能够适应所有用户的需求。 
要将众多的异构网络都互连起来，并且能够互相通信，则会面临许多需要解决的问题，例如： 
- 不同的网络接入机制。 
- 不同的差错恢复方法。 
- 不同的路由选择技术。 
- 不同的寻址方案。 
- 不同的最大分组长度。 
- 不同的服务(面向连接服务和无连接服务)



<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231209150415.png?" alt="image.png" style="zoom:50%;" />


### IPv4地址及其编址方法 

- IPv4地址是给因特网（Internet)上的**每一个主机**（或路由器）的**每一个接口**分配的一个在全世界范围内 **唯一的32比特的标识符**。 
- 由于IPv4地址由32比特构成，不方便阅读、记录以及输入等，因此IPv4地址采用**点分十进制**表示方法以方 便用户使用。 

<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231209152547.png?" alt="image.png" style="zoom:50%;" />
### IPv4地址的分类编址方法 



|   网络号                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |   主机号                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
|:-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------:|:-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------:|
|<div>标志主机（或路由器）的接口所连接到的**网络**&nbsp;</div><div>**同一个网络**中，**不同**主机（或路由器）的接口<span style="background-color: var(--background-popover); color: var(--text-normal); font-family: var(--font-interface); font-size: var(--font-ui-medium);">的IPv4地址的**网络号必须相同**，表示它们属于</span><span style="background-color: var(--background-popover); color: var(--text-normal); font-family: var(--font-interface); font-size: var(--font-ui-medium);">同一个网络。&nbsp;</span></div><div><br></div>|<div>标志主机（或路由器）的接口&nbsp;</div><div>同一个**网络中**，不同主机（或路由器）的**接口**<span style="background-color: var(--background-popover); color: var(--text-normal); font-family: var(--font-interface); font-size: var(--font-ui-medium);">的IPv4地址的主机号必须各不相同，以便区分</span><span style="background-color: var(--background-popover); color: var(--text-normal); font-family: var(--font-interface); font-size: var(--font-ui-medium);">各主机（或路由器）的接口。&nbsp;</span></div><div><br></div> |

- **A类、B类**和C类地址都是**单播地址**，只有单播地址可以**分配给网络中的主机（或路由器）的各接口**。 
- **主机号为“全0”** 的地址是**网络地址**，**不能分配**给主机（或路由器）的各接口。 
- **主机号为“全1”** 的地址是**广播地址**，**不能分配**给主机（或路由器）的各接口。 

<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231209153830.png?" alt="image.png" style="zoom:40%;" />

<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231209154905.png?" alt="image.png" style="zoom:40%;" />

<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231209154939.png?" alt="image.png" style="zoom:40%;" />
### IPv4地址的划分子网编址方法 

- 随着更多的中小网络加入因特网，**IPv4分类编址方法不够灵活、容易造成大量IPv4地址资源浪费**的缺点就暴露出来了。 

<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231209160356.png?" alt="image.png" style="zoom:100%;" />

- 为新增网络申请新的网络号存在以下弊端： 
	- 需要等待时间和花费更多的费用 
	- 会增加其他路由器中路由条目的数量 
	- 浪费原有网络号中剩余的大量地址 
- **子网掩码**可以表明分类IPv4地址的主机号部分被借用了几个比特作为子网号。 
- 与IPv4地址类似，子网掩码也是由32比特构成的。 
	- 用左起多个**连续的比特1**对应IPv4地址中的网络号和子网号； 
	- 之后的多个**连续的比特0**对应Pv4地址中的主机号。 
- 将划分子网的IPv4地址与相应的子网掩码进行逐比特的逻辑与运算，就可得到该IPv4地址所在子网的网络地址。 

	<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231209160507.png?" alt="image.png" style="zoom:40%;" />


- 给定一个分类的IPv4地址和其相应的子网掩码，就可得出子网划分的细节： 
	- 划分出的子网数量 
	- 每个子网可分配的地址数量 
	- 每个子网的网络地址和广播地址 
	- 每个子网可分配的最小地址和最大地址 
- **默认子网掩码**是指在**未划分子网的情况下使用的子网掩码**。 
	- A类：255.0.0.0 
	- B类：255.255.0.0 
	- C类：255.255.255.0 

### IPv4地址的无分类编址方法 

- 无分类编址方法使用的**地址掩码**与划分子网使用的**子网掩码**类似，由32比特构成。 
	- 用左起多个**连续的比特1**对应IPv4地址中的**网络前缀**； 
	- 之后的多个**连续的比特0**对应IPv4地址中的**主机号**。 

- 为了简便起见，可以不明确给出配套的地址掩码的点分十进制形式，而是在无分类编址的IPv4地址后面 加上斜线“/”，在斜线之后写上网络前缀所占的比特数量（也就是地址掩码中左起连续比特1的数量）, 这种记法称为**斜线记法**。 
- 实际上，无分类域间路由选择CIDR是将网络前缀都相同的、连续的多个无分类IPv4地址，组成一个**CIDR地址块**，只要知道CIDR地址块中的任何一个地址，就可以知道该地址块的以下全部细节： 
	- 地址块中的**最小地址** 
	- 地址块中的**最大地址** 
	- 地址块中的**地址数量** 
	- 地址块中**聚合某类网络（A类、B类、C类）的数量** 
	- **地址掩码** 

<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231209164841.png?" alt="image.png" style="zoom:40%;" />

使用CIDR的一个好处是，可以根据客户的需要**分配适当大小的CIDR地址块**，因此可以更加有效地分配 IPv4的地址空间。 

<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231209165048.png?" alt="image.png" style="zoom:40%;" />

- 使用CIDR的一个好处是，可以根据客户的需要**分配适当大小的CIDR地址块**，因此可以更加有效地分配IPv4的地址空间。 
- 使用CIDR的另一个好处是**路由聚合**（也称为构造超网） 


- **网络前缀越长，地址块越小，路由越具体**； 
- 若路由器查表转发分组时发现有多条路由条目匹配，则选择网络前缀最长的那条路由条目，这称为**最长前缀匹配**，因为这样的路由更具体。 

<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231209165309.png?" alt="image.png" style="zoom:50%;" />

### IPv4地址的应用规划 

IPv4地址的应用规划是指将给定的IPv4地址块（或分类网络）划分成若干个更小的地址块（或子网）,并 将这些地址块（或子网）分配给互联网中的不同网络，进而可以给各网络中的主机和路由器的接口分配 IPv4地址。


> [!multi-column]
>
>> [!todo]+ 定长的子网掩码 (Fixed Length Subnet Mask , FLSM ) 
>>
>>- 所划分出的每一个子网都**使用同一个子网掩码**。 
>>- 每个子网所分配的IP地址数量相同，容易造成**地址资源的浪费**。
>
>> [!check]+ 变长的子网掩码(Variable Length Subnet Mask,VLSM) 
>>
>>- 所划分出的每一个子网**可以使用不同的子网掩码**。
>>- 每个子网所分配的IP地址数量可以不同，**尽可能减少对地址资源的浪费**。


### IPv4地址与MAC地址 

1. IPv4地址与MAC地址的封装位置 

	<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231211103747.png?=" alt="image.png" style="zoom:50%;" />


 
2. 数据报传送过程中IPv4地址与MAC地址的变化情况 
	- 在数据包的传送过程中，数据包的**源IP地址和目的IP地址保持不变**； 
	- 在数据包的传送过程中，数据包的**源MAC地址和目的MAC地址逐链路（或逐网络）改变**。 

	<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231211103853.png?" alt="image.png" style="zoom:50%;" />



#计算机网络面试点
为啥有了MAC地址还需要IP地址？
- 如果仅使用MAC地址进行通信，则会出现以下主要问题： 
	- 因特网中的每台路由器的**路由表**中就必须**记录**因特网上**所有主机和路由器各接口的MAC地址**。 
	- 手工给各路由器配置路由表几乎是不可能完成的任务，即使使用路由协议让路由器通过相互交换路由信息来自动构建路由表，也会因为**路由信息需要包含海量的MAC地址信息而严重占用通信资源**。 
	- **包含海量MAC地址的路由信息需要路由器具备极大的存储空间**，并且会给分组的**查表转发带来非常大的时延**。 
- 因特网的网际层**使用IP地址进行寻址**，就可使因特网中各**路由器**的路由表中的路由记录的数量大大减少，因为**只需记录部分网络的网络地址**，而不是记录每个网络中各通信设备的各接口的MAC地址。 
	- 路由器收到P数据报后，根据其首部中的目的IP地址的网络号部分，基于自己的路由表进行查表转发。 

同理为啥有IP地址还需要MAC地址？

- MAC地址等价于快递包裹上的收件人，是用来确认对方信息的，就如同快递跨越几个城市来到你面前，快递员需要和你确认以下收件人是否正确，才会把包裹交给你一样。
- 虽然同一网段也会用到ip地址，但是它在局域网中不起作用，因为arp是用于网络中寻址的，而在局域网中我们不需要用到网关进行通信，只需要找到目的MAC即可。
- IP地址的使用条件，是在跨网络的时候，两个网络之间想要进行通信需要通过一个媒介，因为在网络内部的主机定位不到网络外的某个主机，即使他们只隔了一个网段。


> 查表转发的结果可以指明IP数据报的下一跳路由器的IP地址，但无法指明该IP地址所对应的MAC地址。因此，在数据链路层封装该IP数据报成为帧时，帧首部中的目的MAC地址字段就无法填写，该问题需要使用网际层中的**地址解析协议ARP**来解决。 


### 地址解析协议 ARP

地址解析协议的主要功能是，通过已知IP地址找到其相应的MAC地址。 与ARP协议相反，逆地址解析协议的主要功能是，使只知道自己MAC地址的主机能够通过RARP协议找出其IP地址。

<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231211111350.png?" alt="image.png" style="zoom:40%;" />

- 每台主机都会维护一个ARP高速缓存表。ARP高速缓存表中记录有IP地址和MAC地址的对应关系。
- 当主机B要给C发送分组时，会首先在自己的ARP高速缓存表中查找主机C的IP地址所对应的MAC地址,没有找到
- 主机B需要发送ARP请求报文来获取主机C的MAC地址，将封装有ARP请求报文的广播帧发送出去，总线上的其他主机都能收到该广播 
	- 主机A的网卡收到该广播帧后，将其所封装的ARP请求报文送交上层处理。上层的ARP进程解析该ARP请求报文，发现所询问的IP地址不是自己的IP地址，因此不予理会。 
	- 主机C的网卡收到该广播帧后，将其所封装的ARP请求报文送交上层处理。上层的ARP进程解析该ARP请求报文，发现所询问的IP地址正是自己的IP地址，需要进行响应。 
	- 主机C首先将ARP请求报文中所携带的主机B的IP地址与MAC地址，记录到自己的ARP高速缓存表中，然后给主机B发送ARP响应报文，告知主机C自己的MAC地址。
- 主机C给B发送封装有ARP响应报文的单播帧，总线上的其他主机都能收到该单播帧 


ARP高速缓存表中的每一条记录都有其类型，分为动态和静态两种： 
- 动态类型是指记录是由主机通过ARP协议自动获取到的，其生命周期默认为2分钟。当生命周期结束时，该记录将自动删除。这样做的原因是IP地址与MAC地址的对应关系并不是永久性的。例如，在主机的网卡坏了，更换新的网卡后，主机的IP地址并没有改变，但主机的MAC地址改变了。 
- 静态类型是指记录是由用户或网络维护人员手工配置的。在不同操作系统中，静态记录的生命周期不同，例如系统重启后不存在或系统重启后依然有效。 

### IP数据报的发送和转发过程 

- 主机发送IP数据报 
- **判断目的主机是否与自己在同一个网络** 
	- 若在**同一个网络**，则属于**直接交付**； 
	- 若**不在同一个网络**，则属于**间接交付**。发送给主机所在网络的**默认网关**（路由器）,由默认网关帮忙转发。 

- 路由器转发IP数据报 
	1. **检查收到的IP数据报是否正确** (生存时间是否结束；首部是否误码） 
		- 若出错，则丢弃该IP数据报并给发送该IP数据报的源主机发送差错报告； 
		- 若正确，则进行查表转发。 
	2. **基于IP数据报首部中的目的IP地址在路由表中进行查找** 
		- 若找到匹配的路由条目，则按该路由条目的指示进行转发； 
		- 若找不到匹配的路由条目，则丢弃该IP数据报，并向发送该IP数据报的源主机发送差错报告。 

<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231211144501.png?" alt="image.png" style="zoom:40%;" />



### IPv4数据报的首部格式 

- IPv4数据报的首部格式及其内容是**实现IPv4协议各种功能的基础**。 
- 在TCP/IP标准中，各种数据格式常常**以32比特（即4字节）为单位来描述**。 

- IPv4数据报的首部由20字节的**固定部分**和最大40字节的**可变部分**组成。所谓固定部分，是指每个IPv4数据报的首部都必须要包含的部分。
- 某些IPv4数据报的首部，除了包含20字节的固定部分，还包含一些可选的字段来增加IPv4数据报的功能。 

<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231211150446.png?" alt="image.png" style="zoom:50%;" />
下面介绍IPv4数据报首部中各字段的含义。 
1. 版本
	版本字段的长度为4个比特，用来表示IP协议的版本。通信双方使用的IP协议的版本必 须一致。目前广泛使用的IP协议的版本号为4(即IPv4)。 
2. 首部长度、可选字段和填充 
	首部长度字段的长度为4个比特，该字段的取值以4字节为单位，用来表示IPv4数据报**首部的长度。** 该字段的最小取值为二进制的0101,即十进制的5,再乘以4字节单位，表示IPv4数据报首部只有20字节固定部分。该字段的最大取值为二进制的1111,即十进制的15,再乘以4字节单位，表示IPv4数据报首部包含20字节固定部分和最大40字节可变部分。 
3. 总长度
	总长度字段的长度为16个比特，该字段的取值以字节为单位，用来表示IPv4数据报的长度，也就是IPv4数据报首部与其后的数据载荷的长度总和。该字段的最大取值为二进制 
4. 标识、标志和片偏移 
	标识字段的长度为16个比特。属于同一个IPv4数据报的各分片数据报应该具有相同的标识。IP软件会维持一个计数器，每产生一个IPv4数据报，计数器值就加1,并将此值赋给标识字段。 
	标志字段的长度为3个比特，各比特含义如下： 
	- 最低位（More Fragment,MF),表示本分片后面是否还有分片。MF=1表示本分片后面还有分片，MF=0表示本分片后面没有分片。 
	- 中间位（Don't Fragment,DF),表示是否允许分片。DF=1表示不允许分片，DF=0表示允许分片。 
	- 最高位为保留位，必须设置为0。 
5. 生存时间
	生存时间字段的长度为8比特，最大取值为二进制的111111,即十进制的255。该字段的取值最初以秒为单位。因此，IPv4数据报的最大生存时间最初为255秒。路由器转发IPv4数据报时，将其首部中**该字段的值减去该数据报在本路由器上所耗费的时间**，若不为0就转发，否则就**丢弃**。 
6. 协议
	协议字段的长度为8个比特，用来指明IPv4数据报的数据载荷是何种协议数据单元PDU，当某个IPv4数据报首部中的协议字段的取值为6时，表明该数据报的数据载荷是运输层TCP协议交付下来的TCP报文段。 
7. 首部检验和 
	首部检验和字段的长度为16个比特，用于检测IPv4数据报在传输过程中其首部是否出现了差错。 IPv4数据报每经过一个路由器，其首部中的某些字段的值（例如生存时间、标志以及 片偏移等）都可能发生变化，因此路由器都要重新计算一下首部检验和。之所以不检IPv4数据报的数据载荷，是为了减少计算的工作量。
8. 源IP地址和目的IP地址 
	源IP地址字段和目的IP地址字段的长度都是32个比特，用来填写发送IPv4数据报的源主机的IPv4地址和接收该IP数据报的目的主机的IPv4地址。 

## 静态路由配置 

静态路由配置是指用户或网络运维人员使用路由器的相关命令给路由器**人工配置路由表**。 
- 人工配置方式**简单、开销小**、但**不能及时适应网络状态（流量、拓扑等）的变化**，一般只在小规模 网络中采用。 

- 进行静态路由配置需要认真考虑和谨慎操作，否则可能出现以下问题： 
	- 路由条目**配置错误**，甚至导致出现**路由环路**。 
	- 聚合路由条目时可能**引入不存在的网络**。 

<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231211154102.png?" alt="image.png" style="zoom:50%;" />

**默认路由**

<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231211162743.png?" alt="image.png" style="zoom:40%;" />
**特定主机路由**

- 出于某种安全问题的考虑，同时为了使网络运维人员更方便地控制网络和测试网络，特别是在对网络的 连接或路由表进行排错时，指明到某一台主机的特定主机路由是十分有用的。 

<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231211162912.png?" alt="image.png" style="zoom:50%;" />

## 因特网的路由选择协议 

### 路由器分类

> [!multi-column]
>
>> [!check] + 静态路由选择 
>> - 采用**人工配置**的方式给路由器添加网络路由、默认路由和特定主机路由等路由条目。 
>> - 静态路由选择**简单、开销小**，但**不能及时适应网络状态（流量、拓扑等）的变化**。 
>> - 静态路由选择一般只在**小规模网络**中采用 
>
>> [!example] + 动态路由选择 
>>
>>- 路由器通过路由选择协议**自动获取**路由信息。 
>>- 动态路由选择**比较复杂、开销比较大**，**但能较好地适应网络状态的变化**。 
>>- 动态路由选择适用于**大规模网络**。 

因特网是全球最大的互联网，它所采取的路由选择协议具有以下三个主要特点： 
- 自适应:因特网采用**动态路由**选择，能较好地适应网络状态的变化。 
- 分布式:因特网中的**各路由器**通过相互间的信息交互，**共同完成路由信息的获取和更新**。 
- 分层次:将整个因特网划分为许多较小的**自治系统**（Autonomous System,AS)。 

<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231211165413.png?" alt="image.png" style="zoom:50%;" />


> [!warning] 注意
> 1. 外部网关协议EGP和内部网关协议IGP只是路由选择协议的分类名称，而不是具体的路由选择协议。 
> 2. 外部网关协议和内部网关协议名称中使用的是“网关”这个名词，是因为在因特网早期的RFC文档中，没有使用“路由器”而使用的是“网关”这一名词。 
> 

### 路由信息协议 RIP

- 路由信息协议（Routing Information Protocol,RIP)是内部网关协议中最先得到广泛使用的协议之一，其相关标准文档为`[RFC 1058]`。 
- RIP要求自治系统AS内的每一个路由器，都要维护从它自己到AS内其他每一个网络的距离记录。这是一组距离，称为**距离向量**（Distance-Vector,D-V) 
- RIP使用**跳数**（Hop Count)作为度量（Metric)来衡量到达目的网络的**距离**。 
	- RIP将路由器**到直连网络**的**距离定义为1**。 
	- RIP将路由器**到非直连网络**的**距离定义为所经过的路由器数加1**。 
	- RIP允许一条路径最多只能包含15个路由器，**距离等于16时相当于不可达**。因此**RIP只适用于小型互联网**。 

RIP认为好的路由就是“距离短”的路由，也就是所通过路由器数量最少的路由。

当到达同一目的网络有多条“RIP距离相等”的路由时，可以进行等价负载均衡。也就是将通信量均衡地分布到多条等价的路径上。路由器R1到R6有两条等价的路径，R1会将通信量均衡地分布到这两条等价的路径上。 

RIP具有以下三个重要特点： 
- 和谁交换信息：仅和**相邻路由器交换信息**。在图4-65中，路由器R1与R2互为相邻路由器，因为它们是直连的，中间没有其他路由器。同理，R2与R3也互为相邻路由器。R1与R3不是相邻路由器，因为它们之间还存在其他路由器R2。 
- 交换什么信息：交换的信息是路由器自己的**路由表**。换句话说，交换的信息是“本路由器到所在自治系统中所有网络的最短RIP距离，以及到每个网络应经过的下一跳路由器” 
- 何时交换信息：**周期性交换**（例如，每隔约30秒）。路由器根据收到的路由信息更新自己的路由表。为了加快RIP的收敛速度，当网络拓扑发生变化时，路由器要及时向相邻路由器通告拓扑变化后的路由信息，这称为触发更新。 


<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231211172938.png?" alt="image.png" style="zoom:50%;" />

RIP的基本工作过程 
1. 路由器刚开始工作时，只知道自己到直连网络的距离为1。如图所示，路由器R1、R2、R3和R4刚开始工作时各自的路由表中只有自己到直连网络的路由条目。 
2. 每个路由器仅和相邻路由器周期性地交换并更新路由信息。如图所示，R1和R2互为相邻路由器，R1和R3互为相邻路由器，R2和R3互为相邻路由器，R2和R4互为相邻路由器，R3和R4也互为相邻路由器。相邻路由器之间周期性地交换并更新路由信息。 
3. 若干次交换和更新后，每个路由器都知道到达本自治系统内各网络的最短距离和下一跳路由器，称为收敛。

RIP存在的问题 
RIP存在“坏消息传播得慢”的问题

<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231211173212.png?" alt="image.png" style="zoom:50%;" />
在上述过程中，R1和R2之间会出现路由环路，时间长达数分钟。如果没有最大RIP距离为15的限制，则上述过程将永久持续下去。 
“坏消息传播得慢”的问题又称为路由环路或RIP距离无穷计数问题，这是距离向量算法的一个固有问题。可以采取以下多种措施减少出现该问题的概率或减小该问题带来的危害： 
- 限制最大RIP距离为15(16表示不可达）。 
- 当路由表发生变化时就立即发送路由更新报文（即“触发更新”）,而不仅是周期性发送。 
- 让路由器记录收到某特定路由信息的接口，而不让同一路由信息再通过此接口向反方向传送（即“水平分割”）。 

RIP的优点有： 
- 实现简单、路由器开销小。 
- 如果一个路由器发现了RIP距离更短的路由，那么这种更新信息就传播得很快，即“好消息传播得快”。 
RIP也有很多缺点： 
- RIP限制了最大RIP距离为15,这就限制了使用RIP的自治系统的规模。 
- 相邻路由器之间交换的路由信息是路由器中的完整路由表，因而随着网络规模的扩大，开销也就增加。 
- “坏消息传播得慢”，使更新过程的收敛时间过长。因此，对于规模较大的AS就 应当使用OSPF协议。然而目前在规模较小的AS中，使用RIP的仍占多数。 

### 开放最短路径优先协议 OSPF

开放最短路径优先（Open Shortest Path First,OSPF)协议是为了**克服路由信息协议RIP的缺点**在1989年开发出来的。 
- “**开放**”表明OSPF协议不是受某一厂商控制，而是**公开发表**的。 
- “**最短路径优先**”是因为使用了Dijkstra提出的**最短路径算法**(Shortest Path First, **SPF**) 

> [!warning] 注意： 
> “开放最短路径优先”只是一个路由选择协议的名称，但这并不表示其他的路由选择协议不是“最短路径优先”。 实际上，用于自治系统AS内部的各种路由选择协议（例如RIP),都要寻找一条“最短”的路径。 

- OSPF是基于链路状态的，而不像RIP是基于距离向量的。 
- OSPF基于链路状态并采用最短路径算法计算路由，从算法上保证了不会产生路由环路。 
- OSPF不限制网络规模，更新效率高，收敛速度快。 

1)链路状态 
链路状态是指本路由器都和哪些路由器相邻，以及相应链路的“代价（cost)”。“代价”用来表示费用、距离、时延和带宽等，这些都由网络管理人员来决定。 

**OSPF路由器邻居关系的建立和维护** 
OSPF相邻路由器之间通过交互**问候（Hello)分组**来建立和维护邻居关系。 
问候（Hello)分组封装在**IP数据报**中，发往**组播地址224.0.0.5**。IP数据报首部中的协议号字段的取值为89，表明IP数据报的数据载荷为OSPF分组

<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231211192715.png?" alt="image.png" style="zoom:40%;" />


- 问候（Hello)分组的**发送周期为10秒**。 
- 若40秒未收到来自邻居路由器的问候（Hello)分组，则认为邻居路由器不可达。 
- 每个路由器都会建立一张**邻居表**。 

**链路状态通告**

- 使用OSPF的每个路由器都会产生**链路状态通告**（Link State Advertisement,LSA) 
- LSA中包含以下两类链路状态信息： 
	- **直连网络**的链路状态信息 
	- **邻居路由器**的链路状态信息 

<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231211212314.png?)" alt="image.png" style="zoom:50%;" />

- 链路状态通告LSA被封装在链路状态更新（Link State Update,LSU)分组中，采用可靠的洪泛法(Flooding)进行发送。 
	- 洪泛法的要点是路由器**向自己所有的邻居路由器发送链路状态更新分组**，收到该分组的各路由器又将该分组转发给自己所有的邻居路由器（但其上游路由器除外）,以此类推。 
	- 可靠是指收到链路状态更新分组后要发送确认，**收到重复的更新分组无需再次转发**，但要发送一次确认。 

链路状态数据库

- 使用OSPF的每一个路由器都有一个**链路状态数据库**（Link State Database,LSDB),用于**存储链路状态通告LSA**。 
- **通过各路由器洪泛发送封装有各自链路状态通告LSA的链路状态更新分组LSU,各路由器的链路状态数据库LSDB最终将达到一致。** 

<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231211212735.png?" alt="image.png" style="zoom:50%;">

基于链路状态数据库进行最短路径优先计算 

使用OSPF的各路由器，**基于链路状态数据库LSDB进行最短路径优先计算**，构建出各自到达其他各路由 器的最短路径，即**构建各自的路由表**。 

<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231211213024.png?)" alt="image.png" style="zoom:40%;" />

**OSPF的五种分组类型** 
- 问候(Hello) ：用来发现和维护邻居路由器的可达性。 
- 数据库描述(Database Description)：用来向邻居路由器给出自己的链路状态数据库中的所有链路状态项目的摘要信息。 
- 链路状态请求(Link State Request)：用来向邻居路由器请求发送某些链路状态项目的详细信息。
- 链路状态更新(Link State Update)：路由器使用链路状态更新分组将其链路状态信息进行洪泛发送，即用洪泛法对整个系统更新链路状态。 
- 链路状态确认(Link State Acknowledgement)：对链路状态更新分组的确认分组。 


**OSPF的基本工作过程** 
借助图4-78理解OSPF的基本工作工程。 
1. 相邻路由器R1与R2之间每隔10秒要交换一次**问候分组**，以便建立和维护邻居关系。 
2. 建立邻居关系后，给邻居路由器发送**数据库描述分组**。也就是将自己的链路状态数据库中的所有链路状态项目的摘要信息发送给邻居路由器。 
3. 假设路由器R1收到R2的数据库描述分组后，发现自己缺少其中的某些链路状态项目，于是就给R2发送**链路状态请求分组**。 
4. R2收到R1发来的链路状态请求分组后，将R1所缺少的链路状态项目的详细信息，封装在**链路状态更新分组**中发送给R1。 
5. R1收到R2发来的链路状态更新分组后，将这些所缺少的链路状态项目的详细信息，添加到自己的链路状态数据库中，并给R2发送**链路状态确认分组**。 
6. R2也可以向R1请求自己所缺少的链路状态项目的详细信息，这里就不再赘述了。 
7. R1和R2的链路状态数据库最终将达到一致，即同步。两个同步的路由器称作“完全邻接的”（fully adjacent)的路由器。 
8. 每30分钟或链路状态发生变化时，路由器都会洪泛发送链路状态更新分组。收到该分组的其他路由器会根据分组的内容更新自己的链路状态数据库，然后洪泛转发该分组，并给该路由器发回链路状态确认分组。这又称为新情况下的链路状态数据库同步。 

**多点接入网络中的OSPF路由器** 
- 为了**减少所发送问候分组和链路状态更新分组的数量**，OSPF采用以下措施： 
- 选举**指定路由器**（Designated Router,DR)和**备用的指定路由器**（Backup Designated Router , BDR ) 
- **所有的非DR/BDR只与DR/BDR建立邻居关系** 
- **非DR/BDR之间通过DR/BDR交换信息** 

**OSPF划分区域** 

将一个规模很大的网络划分成一个AS。在该自治系统内，所有路由器 都使用OSPF协议，并且被划分在了4个更小的区域。每个区域都有一个32比特的区域标识 符，可以用点分十进制表示。主干区域的标识符必须为0,也可表示成点分十进制形式的 0.0.0.0。主干区域用于连通其他区域。其他区域的标识符不能为0且互不相同。每个区域的 规模不应太大，一般所包含的路由器不应超过200个。 

<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231211214651.png?" alt="image.png" style="zoom:50%;" />
划分区域的好处就是把利用洪泛法交换链路状态信息的范围局限于每一个区域，而不 是整个AS,这样就减少了整个网络上的通信量。 

为了本区域可以和自治系统内的其他区域连通，每个区域都会有一个区域边界路由器(**area border router**),如图中的路由器R3、R4和R7。区域边界路由器的一个接口用于连接自身所在区域，另一个接口用于连接主干区域。 


### 边界网关协议 

边界网关协议BGP的相关基本概念 

- 边界网关协议（Border Gateway Protocol,BGP)属于外部网关协议EGP这个类别，用于**自治系统AS之间的路由选择协议**。 
- 由于在不同AS内度量路由的“代价”（距离、带宽、费用等）可能不同，因此**对于AS之间的路由选择，使用统一的“代价”作为度量来寻找最佳路由是不行的**。 
- AS之间的路由选择还必须考虑相关策略（政治、经济、安全等）。 

> BGP只能是力求寻找一条能够到达目的网络且比较好的路由（即不能兜圈子）,而并非要寻找一条最佳路由。 


使用TCP连接交换路由信息的两个BGP发言人，彼此称为对方的**邻站**（neighbor)或**对等站**（peer)。 
BGP发言人除了运行BGP协议外，还必须运行自己所在AS所使用的内部网关协议IGP,例如RIP或OSPF。 

BGP发言人交换网络可达性的信息，也就是**要到达某个网络所要经过的一系列自治系统**。 
当BGP发言人相互交换了网络可达性的信息后，各BGP发言人就**根据**所采用的**策略**，从收到的路由信息中**找出到达各自治系统的较好的路由**，也就是构造出树形结构且**不存在环路的自治系统连通图**。 

<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231211215653.png?" alt="image.png" style="zoom:50%;" />
BGP-4是目前使用得最多的版本，在`[RFC 4271]`中规定了BGP-4的四种报文： 
- 打开 OPEN：用来与相邻的另一个BGP发言人建立关系，使通信初始化。 
- 保活 KEEPALIVE :用来周期性地证实邻站的连通性。 
- 更新 UPDATE:用来通告某一条路由的信息，以及列出要撤销的多条路由。 
- 通知 NOTIFICATION :用来发送检测到的差错。 

### 路由器的基本工作原理 

- 路由器是一种具有多个输入端口和输出端口的**专用计算机**，其任务是**转发分组**。 
- **路由选择部分**：核心构件是**路由选择处理机**，其任务是根据所使用的**路由选择协议**，周期性地与其他路器进行路由信息的交换，以便构建和更新**路由表**。 
- **分组转发部分**：由**一组输入端口**、**交换结构**以及**一组输出端口**。 

<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231212000107.png?" alt="image.png" style="zoom:50%;" />
## 网际控制报文协议 

为了更**有效地转发IP数据报**以及提高IP数据报交付成功的机会，TCP/IP体系结构的**网际层**使用了**网际控制报文协议**（Internet Control Message Protocol,ICMP)`[RFC 792]`。 
**主机**或**路由器**使用ICMP来发送差错报告报文和询问报文。 
**ICMP报文被封装在IP数据报中发送**。 

<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231212001923.png?" alt="image.png" style="zoom:50%;" />
ICMP报文分为以下两大类： 
**差错报告报文**:用来向主机或路由器报告差错情况。 
**询问报文**:用来向主机或路由器询问情况。 

常见的ICMP差错报告报文有以下五种： 
1. 终点不可达:当路由器或主机不能交付IP数据报时，就向源点发送终点可达报文。具体可再根据ICMP的代码字段细分 为目的网络不可达、目的主机不可达、目的协议不可达、目的端口不可达、目的网络未知、目的主机未 知等13种。 
2. 源点抑制: 当路由器或主机由于拥塞而丢弃IP数据报时，就向发送该IP数据报的源点发送源点抑制报文，使源点知道 应当把IP数据报的发送速率放慢。 
3. 时间超过（超时）: 当路由器收到一个目的IP地址不是自己的IP数据报时，会将其首部中生存时间TTL字段的值减1。若结果不为0,则路由器将该数据报转发出去；若结果为0,路由器不但要丢弃该数据报，还要向发送该IP数据报 的源点发送时间超过（超时）报文。
4. 参数问题: 当路由器或目的主机收到P数据报后，根据其首部中的检验和字段的值发现首部在传送过程中出现了误码，就丢弃该数据报，并向发送该数据报的源点发送参数问题报文。 
5. 改变路由（重定向）: 路由器把改变路由报文发送给主机，让主机知道下次应将IP数据报发送给另外的路由器，这样可以通过更好的路由到达目的主机。 

以下情况不应**发送ICMP差错报告报文**： 
- 对ICMP差错报告报文不再发送ICMP差错报告报文。 
- 对第一个分片的IP数据报片的所有后续数据报片都不发送ICMP差错报告报文。 
- 对具有多播地址的IP数据报都不发送ICMP差错报告报文。 
- 对具有特殊地址（例如127.0.0.0或0.0.0.0)的IP数据报不发送ICMP差错报告报文。 

常用的ICMP询问报文有以下两种： 


> [!multi-column]
>
>> [!summary] 回送请求和回答 
>>- 由主机或路由器向一个特定的目的主机或路由器发出。 
>>- 收到此报文的主机或路由器必须给发送该报文的源主机或路由器发送 
>>- ICMP回送回答报文。 
>>- 这种询问报文**用来测试目的站是否可达以及了解其有关状态**。 
>
>> [!summary] 时间戳请求和回答 
>>
>>- 用来请求某个主机或路由器回答当前的日期和时间。 
>>- 在ICMP时间戳回答报文中有一个32比特的字段，其中写入的整数代表 
>>- 从1900年1月1日起到当前时刻一共有多少秒。 
>>- 这种询问报文用来进行**时钟同步和测量时间**。 


ICMP的典型应用 
- 分组网间探测PING 用来**测试主机或路由器之间的连通性**
- 跟踪路由traceroute 用于**探测IP数据报从源主机到达目的主机要经过哪些路由器**

## 虚拟专用网和网络地址转换 

### 虚拟专用网

- 虚拟专用网（Virtual Private Network,VPN):**利用公用的因特网**作为本机构各专用网之间的通信载体，这样形成的网络又称为虚拟专用网。 
- 给专用网内各主机配置的IP地址应该是该**专用网所在机构可以自行分配的IP地址**，这类IP地址仅在机构内部有效，称为**专用地址**（Private Address),不需要向因特网的管理机构申请。 


> [!multi-column]
>
>> 
>>
>> - `[RFC 1918]`规定了以下三个CIDR地址块中的地址作为专用地址： 
>> - 10.0.0.0~10.255.255.255(CIDR地址块10/8) 
>> - 172.16.0.0~172.31.255.255(CIDR地址块172.16/12) 
>> - 192.168.0.0~192.168.255.255(CIDR地址块192.168/16) 
>
>> 
>>
>>- 很显然，全世界可能有**很多不同机构的专 用网具有相同的专用IP地址**，但这并不会 引起麻烦，因为这些专用地址仅在机构内 部使用。


> 因特网中的所有路由器，对目的地址是专用地址的IP数据报一律不进行转发，这需要由 因特网服务提供者ISP对其拥有的因特网路由器进行设置来实现。 

- 本例所示的是同一机构内不同部门的内部网络所构成的VPN,又称为**内联网VPN**。 
- 有时，一个机构的虚拟专用网VPN需要某些外部机构（通常是合作伙伴）参加进来，这样的VPN就称为**外联网VPN**。 
- 在外地工作的员工需要访问公司内部的专用网时，只要在任何地点接入因特网，运行驻留在员工PC中的VPN软件，在员工的PC和公司的主机之间建立VPN隧道，就可以访问专用网中的资源，这种虚拟专用网又称为**远程接入VPN**。 


<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231212103327.png?" alt="image.png" style="zoom:40%;" />

### 网络地址变换


- 尽管因特网采用了无分类编址方法来减缓IPv4地址空间耗尽的速度，但由于**因特网用户数量的急剧增长**，特别是**大量小型办公室**和**家庭网络**接入因特网的需求不断增加，**IPv4地址空间即将耗尽的危险仍然没有解除**（实际上，因特网号码分配管理局IANN于2011年2月3日宣布，IPv4地址已经分配完毕） 
- **网络地址转换**（Network Address Translation,NAT)技术于1994年被提出，用来缓解IPv4地址空间即将耗尽的问题。 
	- NAT能使大量**使用内部专用地址的专用网络用户共享少量外部全球地址来访问因特网上的主机和资源**。 
	- 这种方法需要在专用网络连接到因特网的路由器上**安装NAT软件**。装有NAT软件的路由器称为NAT路由器，它**至少要有一个有效的外部全球地址$IP_G$**。这样，所有使用内部专用地址的主机在和外部因特网通信时，都要**在NAT路由器上将其内部专用地址转换成$IP_G$**。 

<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231212104148.png?" alt="image.png" style="zoom:50%;" />

- 由于目前绝大多数基于TCP/P协议栈的网络应用，都使用运输层的传输控制协议TCP或用户数据报协议UDP,为了**更加有效地利用NAT路由器中的全球IP地址**，现在常**将NAT转换和运输层端口号结合使用**。 
	- 这样就可以使内部专用网中使用专用地址的大量主机，共用NAT路由器上的1个全球IP地址，因而可以同时与因特网中的不同主机进行通信。 
- 将NAT和运输层端口号结合使用，称为网络地址与端口号转换(Network Address and Port Translation, NAPT) 
	- 现在很多家用路由器将家中各种智能设备（手机、平板、笔记本电脑、台式电脑、物联网设备等）接入因特网，这种路由器实际上就是一个**NAPT路由器**，但往往并不运行路由选择协议。 


<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231212104341.png?" alt="image.png" style="zoom:40%;" />
尽管NAT(和NAPT)的出现在很大程度上缓解了IPv4地址资源紧张的局面，但**NAT(和NAPT)对网络应用并不完全透明**，会对某些网络应用产生影响。 
NAT(和NAPT)的一个重要特点就是**通信必须由专用网内部发起，因此拥有内部专用地址的主机不能直接充当因特网中的服务器**。 
对于目前P2P这类需要外网主机主动与内网主机进行通信的网络应用，在通过NAT时会遇到问题，需要网络应用自身使用一些特殊的**NAT穿透技术**来解决。 

## IP多播 

### IP多播技术的相关基本概念 

<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231212104835.png?" alt="image.png" style="zoom:50%;" />

> 当多播组的成员数量很大时，采用多播方式可以显著地减少网络中各种资源的消耗。 

### IP多播地址和多播组 

- 在**IPv4**中，**D类地址**被作为**多播地址**。 
- **多播地址只能用作目的地址**，而不能用作源地址。 
- 用每一个D类地址来标识一个多播组，**使用同一个IP多播地址接收IP多播数据报的所有主机就构成了一个多播组**。 
	- **每个多播组的成员是可以随时变动的**，一台主机可以随时加入或离开多播组。 
	- **多播组成员的数量和所在的地理位置也不受限制，一台主机可以属于几个多播组**。 
- 非多播组成员也可以向多播组发送IP多播数据报。 
- 与IP数据报相同，IP多播数据报也是“**尽最大努力交付**”，不保证一定能够交付给多播组内的所有成员。 

IPv4多播地址又可分为**预留的多播地址**（永久多播地址）、**全球范围可用的多播地址**以及**本地管理的多播地址**`[RFC 3330]`。 

<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231212105408.png?" alt="image.png" style="zoom:50%;" />
- IP多播可以分为以下两种： 
	- 只在**本局域网**上进行的**硬件多播**。 
	- 在**因特网**上进行的**多播**。 
> 目前大部分主机都是通过局域网接入因特网的。因此，在因特网上进行多播的最后阶段，还是要把IP多播数据报在局域网上用硬件多播交付给多播组的所有成员。 


### 在局域网上进行硬件多播 


- 由于MAC地址（也称为硬件地址）有多播MAC地址这种类型，因此只要**把IPv4多播地址映射成多播MAC地址**，即可将IP多播数据报封装在局域网的MAC帧中，而MAC帧首部中的目的MAC地址字段的值，就设置为由IPv4多播地址映射成的多播MAC地址。这样，可以很方便地**利用硬件多播来实现局域网内的IP多播**。 
- 当给某个多播组的成员主机配置其所属多播组的IP多播地址时，系统就会根据映射规则从该IP多播地址生成相应的局域网多播MAC地址。 

<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231212110611.png?" alt="image.png" style="zoom:40%;" />


- 因特网号码指派管理局IANA,将自己从IEEE注册管理机构申请到的以太网MAC地址块中从**01-00-5E-00-00-00到01-00-5E-7F-FF-FF**的多播MAC地址，用于映射IPv4多播地址。 
	- 这些多播MAC地址的**左起前25个比特都是相同**的，**剩余23个比特可以任意变化**，因此共有223个。 

- 由于IP多播地址可变化的28比特的前5个比特无法映射到MAC多播地址的低23比特，这会造成**IP多播地址与多播MAC地址的映射关系并不是唯一的**。 
- 由于IP多播地址与多播MAC地址的映射关系不是唯一的，因此**收到IP多播数据报的主机还要在网际层利用软件进行过滤**，把不是主机要接收的IP多播数据报丢弃。 

### 在因特网上进行IP多播需要的两种协议 


> [!multi-column]
>
>> [!check] 网际组管理协议IGMP 
>>
>>- 网际组管理协议(Internet Group Management Protocol,IGMP)是TCP/IP体系结构网际层中的协议，其作用是**让连接在本地局域网上的多播路由器知道本局域网上是否有主机**（实际上是主机中的某个进程）**加入或退出了某个多播组**。 
>>- **IGMP仅在本网络有效**，使用IGMP**并不能知道**多播组所包含的**成员数量，也不能知道**多播组的**成员都分布**在哪些网络中。 
>>- **仅使用IGMP并不能在因特网上进行IP多播**。连接在局域网上的多播路由器还必须和因特网上的其他多播路由器协同工作，以便把IP多播数据报用最小的代价传送给所有的多播组成员，这就需要使用多播路由选择协议。 
>
>> [!seealso] 多播路由选择协议 
>>
>>- **多播路由选择协议**的主要任务是：在多播路由器之间为每个多播组建立一个**多播转发树**。 
>>	- 多播转发树**连接多播源和所有拥有该多播组成员的路由器**。 
>>	- **IP多播数据报只要沿着多播转发树进行洪泛**，就能被传送到所有拥有该多播组成员的多播路由器。 
>>	- 之后，**在多播路由器所直连的局域网内**，多播路由器通过**硬件多播**，将IP多播数据报发送给该多播组的所有成员。 
>>- 针对**不同的多播组需要维护不同的多播转发树**，而且必须**动态地适应多播组成员的变化**，但此时网络拓扑并不一定发生变化，因此**多播路由选择协议要比单播路由选择协议（例如RIP、OSPF等）复杂得多**。 
>>- 即使某个**主机不是任何多播组的成员**，它**也可以向任何多播组发送多播数据报**。 
>>- 为了覆盖多播组的所有成员，**多播转发树可能要经过一些没有多播组成员的路由器**。 


#### 网际组管理协议 

网际组管理协议IGMP目前的最新版本是2002年10月公布的IGMPV3`[RFC 3376]`。 
IGMP有三种报文类型： 
- 成员报告报文 
- 成员查询报文 
- 离开组报文 

IGMP报文被封装在IP数据报中传送 

<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231213092009.png?" alt="image.png" style="zoom:40%;" />


> [!multi-column]
>
>> [!note] 加入多播组
>>
>>当一个主机（中的某个进程）要加入某个多播组时，该主机会向其所在网络发送一个封装有**IGMP成员报告报文**的IP多播数据报。 
>>- IGMP成员报告报文中包含**要加入的IP多播组的地址**。 
>>- IP多播数据报的目的地址也为**要加入的IP多播组的地址**。 
>>该IP多播数据报会被本网络中该多播组的所有成员主机以及多播路由器接收。                            
>>如果本网络中还有同组其他成员要发送IGMP成员报告加入该多播组，则监听到该IP多播数据报后就取消发送。                        
>>多播路由器收到一个未知多播组的IGMP成员报告，就会将该多播组的地址**添加**到自己的多播组列表中。                         
>
>> [!example] 监视多播组成员变化
>>
>>多播路由器默认**每隔125秒**就向其直连网络发送一个封装有**IGMP成员查询报文**的IP多播数据报。 
>>- IGMP成员查询报文中包含要查询的特定多播组或表示全部多播组的“全0”地址。 
>>- IP多播数据报的目的地址为224.0.0.1,在本网络中所有参加多播的主机和路由器的网际层都会接受该多播数据报。 
>>收到该多播数据报的特定多播组或任意多播组的成员将会发送一个封装有IGMP成员报告报文的IP多播数据报作为**应答**。为了减少不必要的重复应答，每个多播组只需要有一个成员应答就可以了，因此采用**延迟(1~10秒）响应策略**。                               
>>多播路由器如果长时间未收到某个多播组的成员报告，则将该多播组从自己的多播组列表中**删除**。                
>
>> [!cite] 退出多播组 
>>当主机要退出某个多播组时，可主动发送一个**离开组报文**而不必等待多播路由器的查询。这样可使多播路由器能够更快地发现某个多播组有成员离开。 
>>- IGMP离开组报文的内容包含主机**要退出的多播组的地址**。 
>>- IP多播数据报的目的地址为**224.0.0.2**,在本网络中的所有多播路由器的网际层都会接受该多播数据报。 
>>多播路由器在收到离开组报文时**不能立即将多播组从自己的多播组列表中删除**，因为在本网络中可能还有该多播组的其他成员。因此，多播路由器在收到离开组报文后，**会立即针对该多播组发送一个IGMP成员查询报文**。若在预定时间内仍然没有收到该多措组的IGMP成员报告报文，才将该多播组从自己的多播组列表中删除。


#### 多播路由选择协议 

- 多播路由选择协议的主要任务是：**在多播路由器之间为每个多播组建立一个多播转发树**。 
	- 多播转发树连接多播源和所拥有该多播组成员的路由器。 
- 目前有以下两种方法来构建多播转发树： 
	- **基于源树**（Source-Base Tree)多播路由选择 
	- **组共享树** (Group-Shared Tree)多播路由选择 

##### 基于源树的多播路由选择 

- 基于源树的多播路由选择的最典型算法是**反向路径多播**（Reverse Path Multicasting,RPM)算法。 
- RPM算法包含以下两个步骤： 
	1. 利用**反向路径广播**（Reverse Path Broadcasting,RPB)算法建立一个**广播转发树**。 
	2. 利用**剪枝**（Pruning)算法，剪除广播转发树中的下游非成员路由器，获得一个**多播转发树**。 
- 要建立广播转发树，可以使用**洪泛**（Flooding)法。 


<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231213095654.png?" alt="image.png" style="zoom:50%;" />


- 利用**反向路径广播RPB算法**生成的**广播转发树**，**不会存在环路**，因此可以避免广播分组在环路中兜圈。 
- RPB算法的要点是：每一台路由器在收到一个广播分组时，先**检查该广播分组是否是从源点经最短路径传送来的**。 
	- 若是，本路由器就从自己除刚才接收该广播分组的接口的所有其他接口转发该广播分组。 
	- 否则，丢弃该广播分组。 
	- 如果本路由器有好几个邻居路由器都处在到源点的最短路径上，也就是**存在好几条同样长度的最短路径**，那么只能选取一条最短路径。**选取**的规则是这几条最短路径中的**邻居路由器的IP地址最小的那条最短路径**。 
- RPB中“反向路径”的意思是：**在计算最短路径时把源点当作终点**。 

##### 组共享树多播路由选择 

- 组共享树多播路由选择采用基于**核心的分布式**生成树算法来建立共享树。 
	- 该方法在**每个多播组**中指定一个**核心（core)路由器**，以该路由器为**根**，建立一棵**连接多播组的所有成员路由器的生成树**，作为多播转发树。 
- 每个多播组中除了核心路由器，其他所有成员路由器都会向自己多播组中的核心路由器单播**加入报文**。 
	- 加入报文通过单播朝着核心路由器转发，直到它到达已经属于该多播生成树的某个节点或者直接到达该核心路由器。 
	- 加入报文所经过的路径，就确定了一条**从单播该报文的边缘节点到核心路由器之间的分支**，而这个新分支就被**嫁接**到现有的**多播转发树**上。 

<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231213095727.png?" alt="image.png" style="zoom:50%;" />

## 移动IP技术 


### 移动IP技术的相关基本概念 

- 移动IP(Mobile IP)是因特网工程任务组IETF开发的一种技术`[RFC 3344]`,该技术使得**移动IP(Mobile IP)是因特网工程任务组IETF开发的一种技术[RFC 3344],该技术使得移动主机在各网络之间漫游时，仍然能够保持其原来的IP地址不变。** 
- 移动IP技术还为因特网中的非移动主机提供了相应机制，使得它们能够将IP数据报正确发送到移动主机。 


> [!multi-column]
>
>> [!check] 归属网络 归属地址 归属代理
>>
>>- 每个移动主机都有一个**默认连接的网络或初始申请接入的网络**，称为归属网络(Home Network)。 
>>- 移动主机在**归属网络中的IP地址在其整个移动通信过程中是始终不变的**，因此称为永久地址（Permanent Address)或归属地址（Home Address) 
>>- **在归属网络中，代表移动主机执行移动管理功能的实体**称为归属代理（Home Agent)。归属代理通常就是连接在归属网络上的路由器，然而它作为代理的特定功能则是在网络层完成的。 
>
>> [!note] 外地网络 外地代理 转交地址
>>
>>- 移动主机**当前漫游所在的网络**称为外地网络（Foreign Network)或被访网络（Visited Network) 
>>- **在外地网络中，帮助移动主机执行移动管理功能的实体**称为外地代理（Foreign Agent)。 
>>- 外地代理通常就是连接在外地网络上的路由器。**外地代理会为移动主机提供一个临时使用的属于外地网络的转交地址**（Care-of Address) 


<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231213101536.png?" alt="image.png" style="zoom:40%;" />


## IPv6 

### IPV6引进的主要变化

- IPv4是在20世纪70年代末期设计的，其**IPv4地址的设计存在以下缺陷**： 
	- IPv4的设计者最初并没有想到该协议会在全球范围内广泛使用，因此将**IPv4地址的长度**规定为他们认为足够长的32比特。 
	- IPv4地址早期的编址方法（分类的IPv4地址和划分子网的IPv4地址）也不够合理，造成**IPv4地址资源的浪费**。 
- 因特网经过几十年的飞速发展，到**2011年2月3日**，因特网号码分配管理局IANA宣布**IPv4地址**已经**分配完毕**，因特网服务提供者ISP已经不能再申请到新的IPv4地址块。 
	- 我国在2014至2015年也逐步停止向新用户和应用分配IPv4地址，同时全面开展商用部署IPv6。 
- 如果没有**网络地址转换NAT**技术的广泛应用，IPv4早已停止发展。 
- 然而，NAT仅仅是为了延长IPv4使用寿命而采取的权宜之计，**解决IPv4地址耗尽的根本措施就是采用具有更大地址空间(IP地址的长度为128比特）的新版本IP,即IPv6**。 
- 因特网工程任务组IETF早在1992年6月就提出要制定下一代的IP,即IPng(IP Next Generation)。IPng现在正式称为IPv6。 
- **直接将因特网的核心协议从IPv4更换成IPv6是不可行的。** 
	- 世界上许多团体都从因特网的发展中看到了机遇，因此在IPv6标准的制定过程中出于自身经济利益而产生了激烈的争论。 
- 到目前为止，IPv6还只是**草案标准**阶段`[RFC 2460,RFC 4862,RFC 4443]`。 


IPv6引进的主要变化 
- 更大的地址空间:IPv6将IPv4的**32比特**地址空间增大到了**128比特**，在采用合理编址方法的情况下，在可预见的未来是不会用完的。 
- 扩展的地址层次结构:可划分为更多的层次，这样可以更好地反映出因特网的拓扑结构，使得**对寻址和路由层次的设计更具有灵活性**。 
- 灵活的首部格式:与IPv4首部并不兼容。IPv6定义了许多**可选的的扩展首部**，不仅可提供比IPv4更多的功能，而且还可以**提高路由器的处理效率**，因为路由器对逐跳扩展首部外的其他扩展首部都不进行处理。 
- 改进的选项:IPv6允许分组**包含有选项的控制信息**，因而**可以包含一些新的选项**。然而IPv4规定的选项却是固定不变的。 
- 允许协议继续扩充:**这一点很重要，因为技术总是在不断地发展，而新的应用也会层出不穷。然而IPv4的功能却是固定不变的**。 
- 支持即插即用(即自动配置):IPv6支持主机或路由器自动配置IPv6地址及其他网络配置参数。因此**IPv6不需要使用DHCP**。 
- 支持资源的预分配:IPv6能为实时音视频等要求保证一定带宽和时延的应用，提供**更好的服务质量保证**。 

### IPv6的基本首部

IPv6数据报由两部分组成： 
- 长度为40字节的基本首部（Base Header)。 
- 长度可变的有效载荷（payload,也称为净负荷）。有效载荷由零个或多个扩展首部（Extension Header)及其后面的数据部分构成。 

<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231213105303.png?" alt="image.png" style="zoom:60%;" />


与IPv4数据报的首部相比，IPv6对首部中的某些字段进行了以下更改： 
- 取消了首部长度字段，因为IPv6数据报的首部长度是固定的40字节。 
- 取消了服务类型字段，因为IPv6数据报首部中的通信量类和流标号字段实现了服务类型字段的功能。 
- 取消了总长度字段，改用有效载荷长度字段。这是因为IPv6数据报的首部长度是固定的40字节，只有其后面的有效载荷长度是可变的。 
- 取消了标识、标志和片偏移字段，因为这些功能已包含在IPv6数据报的分片扩展首部中。 
- 把生存时间（TTL)字段改称为跳数限制字段，这样名称与作用更加一致。 
- 取消了协议字段，改用下一个首部字段。 
- 取消了检验和字段，这样可以加快路由器处理IPv6数据报的速度。 
- 取消了选项字段，改用扩展首部来实现选项功能。 


IPv6数据报的基本首部的格式如图所示。 

<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231213103734.png?" alt="image.png" style="zoom:50%;" />

通信量类字段：长度为8比特，该字段用来**区分不同的IPv6数据报的类别或优先级**。目前正在进行不同的 通信量类性能的实验。 

- 流标号字段：长度为20比特。 
	- IPv6提出了**流**的抽象概念。 
	- **“流”就是因特网上从特定源点到特定终点（单播或多播）的一系列IPv6数据报（如实时音视频数据的传送）,而在这个“流”所经过的路径上的所有路由器都保证指明的服务质量**。 
	- 所有属于同一个流的IPv6数据报都具有同样的流标号。换句话说，**流标号用于资源分配**。 
	- 流标号对于实时音视频数据的传送特别有用，但对于传统的非实时数据，流标号则没有用处，把流标号字段的值置为0即可。 

- 有效载荷长度字段：长度为16比特，它**指明IPv6数据报基本首部后面的有效载荷（包括扩展首部和数据部分）的字节数量**。
	- 该字段以字节为单位，最大取值为65535,因此 IPv6数据报基本首部后面的有效载荷的最大长度为65535字节。 
- 下一个首部字段：长度为8比特。该字段相当于IPv4 数据报首部中的**协议字段或可选字段**。 
	- **当IPv6数据报没有扩展首部时**，该字段的作用与 IPv4的协议字段一样，它的值指出了IPv6数据报基 本首部后面的数据是何种协议数据单元PDU。 
	- **当IPv6数据报基本首部后面带有扩展首部时**，该 字段的值就标识后面第一个扩展首部的类型。 
- 跳数限制字段：长度为8比特。该字段用来**防止IPv6数据报在因特网中永久兜圈**。 


### IPv6扩展首部

**IPv4数据报**如果在其首部中**使用了选项字段**，则在数据报的整个传送路径中的全部路由器，都要对选项字段进行检查，这就**降低了路由器处理数据报的速度**。 
实际上，在路径中的路由器对很多选项是不需要检查的。因此，**为了提高路由器对数据报的处理效率，IPv6把原来IPv4首部中的选项字段都放在了扩展首部中**，由路径两端的源点和终点的主机来处理，而**数据报传送路径中的所有路由器都不处理这些扩展首部**（除逐跳选项扩展首部） 

### IPV6地址

在IPv6中，每个地址占128比特，因此IPv6地址空间的大小为$2^{128}$(大于$3.4×10^{38}$)。下 面举例说明该地址空间有多么巨大。 

由128比特构成的IPv6地址，如果再使用由32比特构成的IPv4地址的点分十进制记法来 表示，就非常不方便了。为了使IPv6地址的表示再简洁一些，IPv6采用冒号十六进制记法（colon hexadecimal notation): 
1. 将128比特的IPv6地址以每16比特分为1组（共8组）,每组之间使用冒号“：” 分隔。 
2. 将每组中的每4比特转换为1个十六进制数。 

在IPv6地址的冒号十六进制记法的基础上，再使用“左侧零”省略和“连续零”压缩，可使IPv6地址的表示更加简洁。 
- “左侧零”省略是指两个冒号间的十六进制数中最前面的一串0可以省略不写，例如000F可缩写为F。 
- “连续零”压缩是指一连串连续的0可以用一对冒号取代，例如2001:0:0:0:0:0:0:ffd 可缩写为2001::ffd。 将之前例子中的IPv6地址的冒号十六进制记法，再使用“左侧零”省略和“连续零”压缩，结果如下： 
2001:db8:4004:10::6543:ffd 

3.IPv6地址分类 
1)IPv6数据报的目的地址有三种基本类型： 
- 单播（unicast):传统的点对点通信。 
- 多播（multicast):一点对多点的通信。数据报发送到一组计算机中的每一个。IPv6没有采用广播的术语，而将广播看作多播的一个特例。 
- 任播（anycast):这是IPv6新增的一种类型。任播的终点是一组计算机，但数据报只交付其中的一个，通常是距离最近的一个。


|   地址类型   |              地址构成              |
| :------: | :----------------------------: |
|  未指明地址   |       128比特“全0”，可缩写为：::        |
|   环回地址   |  最低比特为1，其余127比特为“全0”，可缩写为：::1  |
|   多播地址   |     最高8比特为“全1”，可记为FF00::/8     |
| 本地链路单播地址 | 最高10比特为1111111010，可记为FE80::/10 |
|  全球单播地址  |        除上述4种的其他所有IPv6地址        |

### 从IPv4向IPv6过渡的技术

- 因特网上使用IPv4的路由器的数量太大，要让所有路由器都改用IPv6并不能一蹴而就。因此，**从IPv4转变到IPv6只能采用逐步演进的办法**。 
- 另外，**新部署的IPv6系统必须能够向后兼容**，也就是IPv6系统必须能够接收和转发IPv4数据报，并且能够为IPv4数据报选择路由。 
- 下面介绍两种由IPv4向IPv6过渡的策略： 
	- **使用双协议栈** 
	- **使用隧道技术** 

使用双协议栈 
- 双协议栈（Dual Stack)是指在完全过渡到IPv6之前，使一部分主机或路由器**装有IPv4和IPv6两套协议栈**。 
- 双协议栈主机或路由器**既可以和IPv6系统通信，又可以和IPv4系统通信**。 
- 双协议栈主机或路由器记为IPv6/IPv4,表明它**具有一个IPv6地址和一个IPv4地址**。 
	- 双协议栈主机在与IPv6主机通信时采用IPv6地址，而与IPv4主机通信时采用IPv4地址。 
	- 双协议栈主机通过域名系统DNS查询目的主机采用的IP地址： 
		- 若DNS返回的是IPv4地址，则双协议栈的源主机就使用IPv4地址； 
		- 若DNS返回的是IPv6地址，则双协议栈的源主机就使用IPv6地址。 

<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231213113344.png?=" alt="image.png" style="zoom:40%;" />


- 隧道技术（Tunneling)的核心思想是： 
	1. 当IPv6数据报要进入IPv4网络时，将IPv6数据报重新封装成IPv4数据报，即整个IPv6数据报成为IPv4数据报的数据载荷。 
	2. 封装有IPv6数据报的IPv4数据报在IPv4网络中传输。 
	3. 当IPv4数据报要离开IPv4网络时，再将其数据载荷（即原来的IPv6数据报）取出并转发到IPv6网络。 


<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231213113437.png?" alt="image.png" style="zoom:40%;" />

### 网际控制报文协议ICMPv6 

- 由于**IPv6**与IPv4一样，都**不确保数据报的可靠交付**，因此IPv6也需要**使用**网际控制报文协议**ICMP**来向发送IPv6数据报的源主机**反馈一些差错信息**，相应的ICMP版本为ICMPv6。 
- **ICMPv6**比ICMPv4要复杂得多，它**合并了原来的地址解析协议ARP和网际组管理协议IGMP的功能**。因此与IPv6配套使用的网际层协议就只有ICMPv6这一个协议。 

<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231213113939.png?" alt="image.png" style="zoom:50%;" />

# 运输层

## 运输层概述

### 进程间基于网络的通信 

- 第2-4章依次介绍了计算机网络体系结构中的物理层、数据链路层和网络层，它们共同解决了将主机通过异构网络互联起来所面临的问题，实现了**主机到主机的通信**。 
- 然而在计算机网络中实际进行通信的**真正实体**，是位于通信两端主机中的**进程**。 
- 如何**为运行在不同主机上的应用进程提供直接的逻辑通信服务**，就是运输层的**主要任务**。运输层协议又称为**端到端**协议。 

<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231213114446.png?" alt="image.png" style="zoom:40%;" />



<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231213114639.png?" alt="image.png" style="zoom:40%;" />

- 运输层向应用层实体屏蔽了下面网络核心的细节（例如网络拓扑、所采用的路由选择协议等）,它使应用进程看见的就好像是在两个运输层实体之间有**一条端到端的逻辑通信信道**。 
- 根据应用需求的不同，因特网的运输层为应用层提供了两种不同的运输层协议，即**面向连接的TCP**和**无连接的UDP**,这两种协议就是本章要讨论的主要内容。 



### TCP/IP体系结构运输层中的两个重要协议 


> [!multi-column]
>
>> [!note]+ TCP 
>>
>>- **传输控制协议**（Transmission Control Protocol,TCP)为其上层提供的是**面向连接**的**可靠**的数据传输服务。 
>>- 使用TCP通信的双方，在传送数据之前必须首先建立TCP连接（**逻辑连接**，而非物理连接）。数据传输结束后必须要释放TCP连接。 
>>- TCP为了实现可靠传输，就必须使用很多措施，例如**TCP连接管理、确认机制、超时重传、流量控制以及拥塞控制**等。 
>>- TCP的实现复杂，TCP报文段的**首部比较大，占用处理机资源比较多** 
>
>> [!note]+ UDP 
>>
>>- **用户数据报协议**（User Datagram Protocol,UDP)为其上层提供的是**无连接的不可靠**的数据传输服务。 
>>- 使用UDP通信的双方，在传送数据之前**不需要建立连接**。 
>>- UDP不需要实现可靠传输，因此**不需要使用实现可靠传输的各种机制**。 
>>- UDP的**实现简单**，UDP用户数据报的**首部比较小**。 



**因特网中的一些典型应用所使用的TCP/IP应用层协议和相应的运输层协议** 

|   应用    |      协议      | 传输层协议 |
| :-----: | :----------: | :---: |
|  域名解析   |   域名系统DNS    |  UDP  |
|  文件传送   | 简单文件传送协议TFTP |  UDP  |
|  路由选择   |  路由信息协议RIP   |  UDP  |
| 网络参数配置  | 动态主机配置协议DHCP |  UDP  |
|  网络管理   | 简单网络管理协议SNMP |  UDP  |
| 远程文件服务器 |  网络文件系统NFS   |  UDP  |
|  IP电话   |     专用协议     |  UDP  |
|  流媒体通信  |     专用协议     |  UDP  |
|  IP多播   | 网际组管理协议IGMP  |  UDP  |
|  电子邮件   | 简单邮件传送协议SMTP |  TCP  |
| 远程终端接入  | 电传机网络TELNET  |  TCP  |
|   万维网   | 超文本传送协议HTTP  |  TCP  |
|  文件传送   |  文件传送协议FTP   |  TCP  |

### 运输层端口号、复用与分用的概念 

- 运行在计算机上的进程是使用**进程标识符**（Process Identification,PID)来标识的。 
	- 然而，因特网上的计算机并不是使用统一的操作系统，而**不同操作系统**（Windows、Linux、MacOS)又**使用不同格式的进程标识符**。 
	- 为了使运行不同操作系统的计算机的应用进程之间能够基于网络进行通信，就必须**使用统一的方法对TCP/IP体系的应用进程进行标识**。 
- TCP/IP体系结构的运输层使用**端口号**来标识和区分应用层的不同应用进程。端口号的**长度为16比特，取值范围是0~65535**。 


<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231213120809.png?" alt="image.png" style="zoom:40%;" />



> 端口号只具有本地意义，即端口号只是为了标识本计算机网络协议栈应用层中的各应用进程。在因特网中，下同计算机中的相同端口号是没有关系的，即相互独立。另外，TCP和UDP端口号之间也是没有关系的。 



发送方的复用和接收方的分用 

<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231213121056.png?" alt="image.png" style="zoom:50%;" />


1. 发送方的某些应用进程所发送的**不同的应用报文**，在运输层使用UDP协议进行封装，这称为**UDP复用**；而另一些应用进程所发送的不同的应用报文，在运输层使用TCP协议进行封装，这称为**TCP复用**。运输层使用**端口号**来区分不同的应用进程。 
2. 不管是使用运输层的UDP协议封装成的UDP用户数据报，还是使用TCP协议封装成的TCP报文段，在网际层都需要使用IP协议封装成IP数据报，这称为**IP复用**。IP数据报首部中协议字段的值用来表明，IP数据报的数据载荷部分封装的是何种协议数据单元，取值为6表示封装的是TCP报文段，取值为17表示封装的是UDP用户数据报。 
3. 接收方的网际层收到IP数据报后进行**IP分用**。若IP数据报首部中协议字段的值为17,则把IP数据报的数据载荷部分所封装的UDP用户数据报向上交付给运输层的UDP。若IP数据报首部中协议字段的值为6,则把IP数据报的数据载荷部分所封装的TCP报文段向上交付给运输层的TCP。 
4. 运输层对UDP用户数据报进行**UDP分用**，对TCP报文段进行**TCP分用**，也就是根据UDP用户数据报或TCP报文段首部中的目的端口号，将它们向上交付给应用层的相应应用进程。 


TCP/IP体系结构应用层常用协议所使用的运输层协议和熟知端口号

<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231213121515.png?" alt="image.png" style="zoom:50%;" />

运输层端口号应用举例 

![image.png](http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231213144212.png?OSSAccessKeyId=LTAI5tBK1gnqyQLHK2d7sx6F&Expires=9000000001&Signature=HO11xlp2TNNzaTtuCBbzNHJkgmc=)


## UDP和TCP的对比 

### 无连接的UDP和面向连接的TCP


<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231213144949.png?" alt="image.png" style="zoom:40%;" />


UDP是**无连接的**。换句话说，使用UDP的通信双方，在传送数据之前**不需要建立连接**，可以**随时发送**数据，如图所示。 
TCP是**面向连接的**。换句话说，使用TCP的通信双方，在传送数据之前必须使用“**三报文握手**”来建立TCP连接，如图所示。TCP连接建立成功后才能基于已建立好的TCP连接进行数据传输。数据传输结束后，必须使用“**四报文挥手**”来释放TCP连接。

### UDP和TCP对单播、多播和广播的支持情况 

<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231213145242.png?" alt="image.png" style="zoom:40%;" />

### UDP和TCP对应用层报文的处理 

<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231213145457.png?" alt="image.png" style="zoom:40%;" />
1. 发送方的应用进程将应用层报文向下交付给运输层的UDP。 
2. UDP直接给应用层报文添加一个UDP首部，使之成为UDP用户数据报，然后进行发送。需要说明的是，为了简单起见，忽略了运输层下面的各层处理。 
3. 接收方的UDP收到UDP用户数据报后，去掉UDP首部，将应用层报文向上交付给应用进程。 
综上所述，UDP对应用进程交付下来的报文既不合并也不拆分，而是保留这些报文的边界。换句话说，UDP是面向应用报文的。 


1. 发送方的TCP把应用进程交付下来的应用报文，仅仅看作一连串的、无结构的字节流。TCP并不知道这些待传输的字节流的含义，仅将它们编号并存储在自己的发送缓存中。 
2. TCP根据发送策略，从发送缓存中提取一定数量的字节，构建TCP报文段并发送。 
3. 接收方的TCP一方面从所接收到的TCP报文段中取出数据载荷并存储在接收缓存中，另一方面将接收缓存中的一些字节向上交付给应用进程。 

TCP不保证接收方应用进程所收到的数据块与发送方应用进程所发出的应用层报文之间具有对应大小的关系。例如，发送方应用进程交给发送方的TCP共10个应用层报文，但接收方的TCP可能只用了4个数据块就把收到的字节流交付给了上层的应用进程。

### UDP和TCP对数据传输可靠性的支持 

<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231213145929.png?" alt="image.png" style="zoom:40%;" />

### UDP首部和TCP首部的对比

<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231213150123.png?)" alt="image.png" style="zoom:40%;" />

## 传输控制协议 

### TCP报文段的首部格式 

<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231213162948.png?" alt="image.png" style="zoom:40%;" />



TCP为实现可靠传输而采用了**面向字节流**的方式。但TCP在发送数据时，是根据发送策略从发送缓存中取出一定数量的字节，并给其添加一个首部使之成为TCP报文段后进行发送。一个TCP报文段由**首部**和**数据载荷**两部分构成，TCP的全部功能都体现在它首部中各字段的作用。


<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231213163139.png?" alt="image.png" style="zoom:50%;" />

- 序号字段占32比特，取值范围是0~$2^{32}-1$。当序号增加到最后一个时，下一个序号又回到0。序号字段的值，用来指出本**TCP报文段数据载荷的第一个字节的**序号。 
- 确认号字段占32比特，取值范围是0~$2^{32}-1$。当确认号增加到最后一个时，下一个确认号又回到0。确认号字段的值，用来指出**期望收到对方下一个TCP报文段的数据载荷的第一个字节**的序号，同时也是对之前收到的所有数据的确认。
- 确认标志位ACK:**只有当ACK取值为1时，确认号字段才有效**。ACK取值为0时，确认号字段无效。 TCP规定：在**TCP连接建立后，所有传送的TCP报文段都必须把ACK置1**。 
- 数据偏移: 
	- 占4比特，该字段的取值以4字节为单位。
	- 指出TCP报文段的数据载荷部分的起始处距离TCP报文段的起始处有多远， 这实际上指出了**TCP报文段的首部长度**。 
- 窗口:
	- 占16比特，该字段的取值以字节为单位。 
	- 指出发送本报文段的一方的**接收窗口的大小**，即接收缓存的可用空间大小，这用来表征接收方的接收能力。 
	- 在计算机网络中，经常用接收方的接收能力的大小来控制发送方的数据发送量，这就是所谓的**流量控制**。
- 检验和
	- 占16比特
	- 用来**检查整个TCP报文段在传输过程中是否出现了误码**。 
- 同步标志位SYN:
	- 用于TCP“三报文握手”**建立连接**。 
	- 当**SYN=1**且**ACK=0**时，表明这是一个**TCP连接请求报文段**。 
	- 对方若**同意建立连接**，则应在**响应**的TCP报文段的首部 中使**SYN=1且ACK=1**。 
	- 综上所述，SYN为1的TCP报文段要么是一个连接请求报 文段，要么是一个连接响应报文段。 
- 终止标志位FIN:
	- 用于TCP“四报文挥手” **释放连接**。 
	- 当**FIN=1**时，表明此TCP报文段的发送方已经将全部数据 发送完毕，现在**要求释放TCP连接**。 
- 复位标志位RST:
	- 用于**复位TCP连接**。 
	- 当**RST=1**时，表明**TCP连接中出现严重差错，必须释放连接，然后再重新建立连接**。 
	- RST置1还用来**拒绝一个非法的TCP报文段或拒绝打开一个TCP连接**。 
- 推送标志位PSH:
	- 发送方TCP把PSH置1,并立即创建一个TCP报文段发送出去，而不需要积累到足够多的数据再发送。
	- 接收方TCP收到PSH为1的TCP报文段，就尽快地交付给应用进程 而不再等到接收到足够多的数据才向上交付。 
- 紧急指针 
	- 占16比特，以字节为单位，用来指明紧急数据的长度。 
	- 当**发送方有紧急数据**时，可将紧急数据“**插队**”到发送缓存的最前面，并立刻封装到一个TCP报文段中进行发送。**紧急指针会指出本报文段数据载荷部分包含了多长的紧 急数据**，紧急数据之后是普通数据。 
	- **接收方收到紧急标志位为1的TCP报文段**，会按照紧急指针字段的值从报文段数据载中取出**紧急数据**并直接上交应用进程，而**不必在接收缓存中排队**。 
- 选项（长度可变，最大40字节）:
	- 最大报文段长度MSS选项：指出TCP报文段数据载荷部分的最大长度，而不是整个TCP报文段的长度。 \
	- 窗口扩大选项：用来扩大窗口，提高吞吐率。 
	- 时间戳选项： 
		- 用于计算往返时间RTT 
		- 用于处理序号超范围的情况，又称为防止序号绕回PAWS。 
		- 选择确认选项：用来实现选择确认功能。 
- 填充：若选项字段的长度加上20字节固定首部的长度不能被4字节整除时，需要填充相应数量的比特 0,以确保首部长度能被4字节整除。 


### TCP的运输连接管理 

主要有下面三个阶段：
1. 建立TCP连接：通过“三报文握手”来建立TCP连接。 
2. 数据传送：基于已建立的TCP连接进行可靠的数据传输。 
3. 释放连接：在数据传输结束后，还要通过“四报文挥手”来释放TCP连接。 


#### “三报文握手”建立TCP连接 


TCP连接要解决的三个问题：
1. 使得TCP双方确认对方的存在
2. TCP双方协商一些参数(最大报文段长度，最大窗口大小，时间戳选项)
3. 使TCP双方能够对运输实体资源（如缓存大小、各状态变量、连接表中的项目等）进行分配和初始化。 

最初，两端的TCP进程都处于关闭（CLOSED)状态。 

1. TCP服务器进程首先创建**传输控制块**，用来存储TCP连接中的一些重要信息（例如**TCP连接表**、指向发送和接收**缓存**的指针、指向重传队列的指针以及当前发送和接收**序号**等）。之后，TCP服务器进程就进入**监听（LISTEN)状态**，等待TCP客户进程的连接请求。由于TCP服务器进程是被动等待来自TCP客户进程的连接请求，而不是主动发起的，因此称为**被动打开连接**。 
2. TCP客户进程也要首先创建传输控制块，之后在打算建立TCP连接时向TCP服务器进程发送**TCP连接请求报文段**，并进入**同步已发送（SYN-SENT)状态**。TCP连接请求 报文段首部中的同步标志位(SYN)被设置为1,表明这是一个TCP连接请求报文段；序号字段seq被设置了一个初始值x。请读者注意，TCP规定SYN被设置为1的报文段**不能携带数据，但要消耗掉一个序号**。由于TCP连接是由TCP客户进程主动发起的，因此称为**主动打开连接**。 
3. TCP服务器进程收到TCP连接请求报文段后，如果同意建立连接，则向TCP客户进程发送**TCP连接请求确认报文段**，并进入**同步已接收（SYN-RCVD)状态**。该报文段首部中的SYN和ACK都设置为1,表明这是一个TCP连接请求确认报文段；序号字段seq被设置了一个初始值y,这是TCP服务器进程所选择的初始序号。确认号字段ack的值被设置为x+1,这是对TCP客户进程所选择的初始序号的确认。请读者注意，TCP连接请求确认报文段也不能携带数据，但也要消耗掉一个序号，因为它也是SYN被设置为1的报文段。 
4. TCP客户进程收到TCP连接请求确认报文段后，还要向TCP服务器进程发送一个**普通的TCP确认报文段**，并进入**连接已建立（ESTABLISHED)状态**。该报文首部中的ACK被设置为1,表明这是一个普通的TCP确认报文段，TCP规定**普通的TCP确认报文段可以携带数据，但如果不携带数据，则不消耗序号**。该普通确认报文段首部中的确认号字段ack被设置为y+1,这是对TCP服务器进程所 选择的初始序号的确认。 
5. TCP服务器进程收到针对TCP连接请求确认报文段的普通确认报文段后，也进入**连接已建立（ESTABLISHED)状态**。此时，TCP双方都进入了连接已建立状态，它们可以 基于已建立的TCP连接进行可靠的数据传输了。 

<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231213170126.png?" alt="image.png" style="zoom:50%;" />


> [!question]+ 为什么TCP客户进程最后还要发送一个普通的TCP确认报?
> 1. TCP客户进程发出一个TCP连接请求报文段。但该报文段在某些网络节点长时间滞留了。这必然会造成该报文段的超时重传，假设重传的连接请求报文段被TCP服务器进程正常接收。 
> 2. TCP服务器进程给TCP客户进程发送一个TCP连接请求确认报文段，并进入连接已建立状态。因为现在改为“两报文握手”，因此TCP服务器进程发送完TCP连接请求确认报文段后，进入的是连接已建立状态，而不像“三报文握手”那样，进入同步已接收状态，并等待TCP客户进程发来针对TCP连接请求确认报文段的普通确认报文段。 
> 3. TCP客户进程收到TCP连接请求确认报文段后，进入TCP连接已建立状态。但不会给TCP服务器进程发送针对该报文段的普通确认报文段。 
> 4. 现在，TCP双方都处于连接已建立状态，它们可以相互传输数据了。之后，可以通过“四报文挥手”来释放连接，TCP双方都进入了关闭状态。 
> 5. 一段时间后，之前滞留在网络中的那个失效的TCP连接请求报文段，到达了TCP服务器进程。TCP服务器进程会误认为这是TCP客户进程又发起了一个新的TCP连接请求。于是给TCP客户进程发送TCP连接请求确认报文段，并进入连接已建立状态。 
> 6. TCP客户进程收到TCP连接请求确认报文段后，由于TCP客户进程并没有发起新的TCP连接请求并且处于关闭状态，因此不会理会该报文段。 
> 7. 然而，TCP服务器进程已进入连接已建立状态，它认为新的TCP连接已建立好了，并一直等待TCP客户进程发来数据，这将白白浪费TCP服务器进程所在主机的很多资源。 


采用“三报文握手”而不是“两报文握手”来建立TCP连接，是为了**防止已失效的TCP连接请求报文段突然又传送到了TCP服务器进程，因而导致错误**。 


#### “四报文挥手”释放TCP连接 

<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231213180749.png?" alt="image.png" style="zoom:40%;" />

1. 数据传输结束后，TCP通信双方都可以**释放TCP连接**。现在TCP客户进程和TCP服务器进程都处于**连接已建立（ESTABLISHED)状态**。 
2. 假设使用TCP客户进程的应用进程通知其主动关闭TCP连接，TCP客户进程会发送**TCP连接释放报文段**，并进入**终止等待1(FIN-WAIT-1)状态**。该报文段首部中的终止标志位（FIN)和ACK的值都被设置为1,表明这是一个TCP连接释放报文段，同时也**对之前收到的报文段进行确认**；序号字段seq的值设置为u,它等于TCP客户进程之前已经传送过的数据的最后一个字节的序号加1。请读者注意，TCP规定FIN等于1的TCP报文段即使不携带数据，也要消耗掉一个序号。
3. TCP服务器进程收到TCP连接释放报文段后，会发送一个普通的TCP确认报文段并进入**关闭等待（CLOSE-WAIT)状态**。该报文段首部中的ACK的值被设置为1,表明这是一个普通的TCP确认报文段；序号字段seq的值被设置为v,它等于TCP服务器进程之前已传送过的数据的最后一个字节的序号加1,这也与之前收到的TCP连接释放报文段中的确认号匹配。确认号字段ack的值被设置为u+1,这是对TCP连接释放报文段的确认。**TCP服务器进程这时应通知高层应用进程：“TCP客户进程要断开与自己的TCP连接**”。此时，**从TCP客户进程到TCP服务器进程这个方向的连接就释放了**。这时的TCP连接属于**半关闭状态**，也就是TCP客户进程已经没有数据要发送了，但TCP服务器进程如果还有数据要发送，TCP客户进程仍要接收，也就是从TCP服务器进程到TCP客户进程这个方向的连接并未关闭。半关闭状态可能会持续一段时间。 
4. TCP客户进程收到该普通的TCP确认报文段后就进入**终止等待2(FIN-WAIT-2)状态**，等待TCP服务器进程发出的TCP连接释放报文段。若使用TCP服务器进程的应用进程已经没有数据要发送了，应用进程就通知其TCP服务器进程释放连接。由于TCP连接释放是由TCP客户进程主动发起的，因此TCP服务器进程对TCP连接的释放称为**被动关闭连接**。 
5. TCP服务器进程发送TCP连接释放报文段并进入最后确认（LAST-ACK)状态。该报文段首部中的FIN和ACK的值都被设置为1,表明这是一个TCP连接释放报文段，同时也对之前收到的报文段进行确认。现在假定序号字段seq的值为w,这是因为在半关闭状态下TCP服务器进程可能又发送了一些数据。确认号字段ack的值为u+1,这是对之前收到的TCP连接释放报文段的重复确认。 
6. TCP客户进程收到**TCP连接释放报文段**后，必须针对该报文段发送**普通的TCP确认报文段**，之后进入**时间等待（TIME-WAIT)状态**。该报文段首部中的ACK的值被设置为1,表明这是一个普通的TCP确认报文段；序号字段seq的值设置为u+1,这是因为TCP客户进程之前发送的TCP连接释放报文段虽然不携带数据，但要消耗掉一个序号。确认号字段ack的值设置为w+1,这是对所收到的TCP连接释放报文段的确认。 
7. TCP服务器进程收到该普通的TCP确认报文段后就进入关闭（CLOSED)状态，TCP服务器进程撤销相应的传输控制块。而TCP客户进程还**要经过2MSL后才能进入关闭（CLOSED)状态**。MSL的意思是最长报文段寿命（Maximum Segment Lifetime), 建议为2分钟。也就是说，TCP客户进程进入时间等待（TIME-WAIT)状态后。


 
> [!question] 为什么TCP客户进程在时间等待（TIME-WAIT)状态必须等待2MSL的时间呢？ 
> 1. TCP服务器进程发送TCP连接释放报文段后进入**最后确认（LAST-ACK)状态**。 
> 2. TCP客户进程收到该报文段后，发送普通的TCP确认报文段并进入**关闭(CLOSED)状态**而不是**时间等待（TIME-WAIT)状态**。 
> 3. 然而，该TCP确认报文段丢失了，这必然会造成TCP服务器进程对之前所发送的TCP连接释放报文段的超时重传，并仍处于最后确认（LAST-ACK)状态。 
> 4. 重传的TCP连接释放报文段到达TCP客户进程，由于TCP客户进程处于关闭(CLOSED)状态，因此不理睬该报文段，这必然会造成TCP服务器进程反复重传TCP连接释放报文段，并一直处于最后确认（LAST-ACK)状态而无法进入关闭（CLOSED)状态。 



<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231213182122.png?" alt="image.png" style="zoom:50%;" />



综上所述，处于时间等待（TIME-WAIT)状态后要经过2MSL时长，可以确保TCP服务器进程能够收到最后一个TCP确认报文段而进入关闭（CLOSED)状态。 


#### 3.TCP保活计时器 

除时间等待计时器（2MSL计时）,TCP还设有一个**保活计时器**（Keepalive Timer) 设想图所示的情况：TCP双方已经建立了连接。后来，TCP客户进程所在的主机突然出 现了故障。显然，TCP服务器进程以后就不能再收到TCP客户进程发来的数据。因此，应当有措施使TCP服务器进程不要再白白等待下去。 

<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231213182306.png?" alt="image.png" style="zoom:40%;" />


TCP服务器进程解决上述问题的方法是使用保活计时器，具体如下： 
- TCP服务器进程每收到一次TCP客户进程的数据，就**重新设置并启动保活计时器**(通常为2小时） 
- 若保活计时器在定时周期内未收到TCP客户进程发来的数据，则当保活计时器到时后，TCP服务器进程就向TCP客户进程发送一个探测报文段，以后则每隔75秒发送一次。若一连发送10个探测报文段后仍无TCP客户进程的响应，TCP服务器进程就认为TCP客户进程所在主机出了故障，于是就关闭这个连接。 


### TCP的流量控制 


<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231213195515.png?" alt="image.png" style="zoom:50%;" />

TCP为应用程序提供了**流量控制**（Flow Control)机制，以**解决因发送方发送数据太快而导致接收方来不及接收，造成接收方的接收缓存溢出的问题**。 
流量控制的基本方法就是**接收方根据自己的接收能力（接收缓存的可用空间大小）控制发送方的发送速率**。 

如图5-24所示，主机A和B已成功建立了TCP连接，A给B发送数据，B对A进行流量控制。图中给出了主机A待发送数据的字节序号，每个小格子表示100字节数据的序号。假设 主机A发送的每个TCP数据报文段都携带100字节的数据，在主机A和B建立TCP连接时，B告诉A:“我的接收窗口为400”，因此主机A将自己的发送窗口也设置为400,这意味着主 机A在未收到主机B发来的确认时，可将序号落入发送窗口中的全部数据发送出去。 


<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231213213108.png?" alt="image.png" style="zoom:60%;" />




1. 主机A将发送窗口内序号为1~100的数据封装成一个TCP报文段发送出去，发送窗口内还有300字节可以发送。图中的seq是TCP报文段首部中的序号字段，取值1表示该TCP报文段数据载荷的第一个字节的序号是1;DATA表示这是TCP数据报文段。 
2. 主机A将发送窗口内序号为101~200的数据封装成一个TCP报文段发送出去，发送窗口内还有200字节可以发送。 
3. 主机A将发送窗口内序号为201~300的数据封装成一个TCP报文段发送出去，但该报文段在传输过程中丢失了（可能由于误码被路由器丢弃或路由器繁忙而丢弃）。 
4. 主机A还可发送100个字节的数据，即序号落在发送窗口内的301~400号数据。此时主机B给主机A发送累积确认报文段，对主机A之前所发送的201号以前的数据进行**累积确认**。该累积确认报文段首部中的ACK被设置为1,表示这是一个TCP确认报文段；确认号字段ack的取值设置为201,表示序号201之前的数据已全部正确接收，现在期望收到序号201及其后续数据；窗口字段rwnd(也就是主机B的接收窗口）的值被设置为300,可简单认为现在主机B的接收缓存的可用空间为300字节，而不是之前的400字节，也就是对主机A进行流量控制。 
5. 主机A收到主机B发来的累积确认报文段后，将发送窗口向前滑动，使已发送并收到确认的数据的序号移出发送窗口，这些数据可从发送缓存中删除了。由于主机B在该累积确认报文段中将自己的接收窗口调整为了300,因此主机A相应地将自己的发送窗口调整为300。这样，主机A的发送窗口内的序号为201~500,其中201~300号是已发送但还未收到确认的数据的序号，因此不能将这些数据从发送缓存删除，因为有可能之后会超时重传这些数据；301~400号字节数据以及401~500号字节数据还未被发送，可被分别封装在一个TCP报文段中发送。 
6. 主机A将发送窗口内序号301~400号的数据封装成一个TCP报文段发送出去，发送窗口内还有401~500号共100字节可以发送。 
7. 主机A将发送窗口内序号401~500号的数据封装成一个TCP报文段发送出去。至此，序号落在发送窗口内的数据已经全部发送出去了，不能再发送新的数据了。 
8. 假设此时主机A发送窗口内序号201~300这100字节数据的重传计时器超时了，主机A将它们重新封装成一个TCP报文段发送出去，暂时不能发送其他数据。 
9. 主机B收到该重传的TCP报文段后，给主机A发送累积确认报文段，对主机A之前所发送的501号以前的数据进行累积确认。另外，主机B在该累积确认报文段中将自己的接收窗口调整为100,这是主机B对主机A进行的第二次流量控制。 
10. 主机A收到主机B发来的累积确认报文段后，将发送窗口向前滑动，使已发送并收到确认的数据的序号移出发送窗口，这些数据可从发送缓存中删除了。由于主机B在该累积确认报文段中将自己的接收窗口调整为了100,因此主机A相应地将自己的发送窗口调整为100。这样，主机A的发送窗口内的序号为501~600,也就是主机A还可以发送这100字节数据。 
11. 主机A将发送窗口内序号为501~600号的数据封装成一个TCP报文段发送出去。至此，序号落在发送窗口内的数据已经全部发送出去了，不能再发送新的数据了。 
12. 主机B给主机A发送累积确认报文段，对主机A之前所发送的601号以前的数据进行累积确认。另外，主机B在该累积确认报文段中将自己的接收窗口调整为0,这是主机B对主机A进行的第三次流量控制。 
13. 主机A收到主机B发来的累积确认报文段后，将发送窗口向前滑动，使已发送并收到确认的数据的序号移出发送窗口，这些数据可从发送缓存中删除了。由于主机B在该累积确认报文段中将自己的接收窗口调整为了0,因此主机A相应地将自己的发送窗口调整为0。至此，主机A不能再发送普通的TCP报文段了。 
14. 假设主机B向主机A发送了零窗口的报文段后不久，主机B的接收缓存又有了一些可用空间。于是主机B向主机A发送了接收窗口等于300的报文段。然而，这个报文段在传输过程中丢失了。
15. 主机A一直等待主机B发送的非零窗口的通知，而主机B也一直等待主机A发送的数据。如果不采取措施，这种互相等待而形成的死锁局面将一直持续下去。 


**理解持续计时器和零窗口探测报文段的作用**： 

1. 主机A收到零窗口通知时，就启动一个持续计时器。当持续计时器超时时，主机A立刻发送一个仅携带1字节数据的零窗口探测报文段。 
2. 假设主机B此时的接收窗口值又为0了，主机B就在确认这个零窗口探测报文段时给出自己现在的接收窗口值为0。 
3. 主机A再次收到零窗口通知，就再次启动一个持续计时器。当持续计时器超时时，主机A立刻发送一个零窗口探测报文段。 
4. 假设主机B此时的接收缓存又有了一些可用空间，于是将自己的接收窗口调整为300,主机B就在确认这个零窗口探测报文段时给出自己现在的接收窗口值为300。这样就打破了死锁的局面。 

<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231213213731.png?" alt="image.png" style="zoom:50%;" />

### TCP的拥塞控制 

#### 拥塞控制的基本概念 

- 在某段时间，若**对网络中某一资源的需求超过了该资源所能提供的可用部分，网络性能就要变坏**，这种情况就叫作**拥塞（congestion)** 
	- 计算机网络中的链路容量（带宽）、交换节点中的缓存和处理机等都是网络的资源。 
- 若**出现拥塞而不进行控制**，整个网络的**吞吐量将随输入负荷的增大而下降**。 

<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231213214437.png?" alt="image.png" style="zoom:50%;" />

#### 拥塞控制的基本方法 
流量控制与拥塞控制的区别 
- 但实际上这两者有很大的区别： 流量控制的任务是确保发送方**不会持续地以超过接收方接收能力的速率发送数据**， 以防止接收方来不及从接收缓存取走数据，而导致接收缓存溢出进而数据丢失。也就是说，流量控制只与特定的**点对点通信的发送方和接收方之间的流量有关**。
- 拥塞控制的任务是**防止过多的数据注入到网络**中，使网络能够承受现有的网络负荷。这是一个**全局性**的问题，涉及各方面的行为，包括网络中所有的**主机、所有的路由器、路由器内部**的存储转发处理过程，还有与降低网络传输性能有关的所有因素。 


拥塞控制的基本方法 
从控制论的角度看，拥塞控制可以分为**开环控制**和**闭环控制**两大类。 


> [!multi-column]
>
>> [!note]+ 开环控制 
>>
>>- 试图用良好的设计来解决问题。 
>>- 从一开始就保证问题不会发生。 
>>- 一旦系统启动并运行起来，就不需要中途修正。
>
>> [!warning]+ 闭环控制 
>>
>>- 基于反馈的控制方法，包括以下三个部分： 
>>	1. 监测网络拥塞在何时、何地发生。 
>>	2. 把拥塞发生的相关信息传送到可以采取行动的地方。 
>>	3. 调整网络的运行以解决拥塞问题。

当网络的流量特征可以**准确规定**且性能要求可以**事先获得时**，适合使用**开环控制**。 
当网络的流量特征**不能准确描述**或者当网络不提供资源预留时，适合使用**闭环控制**。 因特网采用的就是闭环控制方法。 

衡量网络拥塞的指标 
- 由于缓存溢出而丢弃的分组的百分比 
- 路由器的平均队列长度 
- 超时重传的分组数量 
- 平均分组时延和分组时延的标准差 



根据拥塞信息的反馈形式，可将闭环拥塞控制算法分为 
- 显式反馈算法 
	- 从拥塞节点（即路由器）向源点提供关于网络中拥塞状态的显式反馈信息。 
- 隐式反馈算法 
	- **源点自身**通过对网络行为的观察（例如超时重传或往返时间RTT)来推断网络是否发生了拥塞。**TCP采用的就是隐式反馈算法**。

<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231213215628.png?=" alt="image.png" style="zoom:50%;" />

 
> 拥塞控制并不仅仅是运输层要考虑的问题。显式反馈算法就必须涉及网络层。虽然一些网络体系结构（如ATM网络）主要在网络层实现拥塞控制，但因特网主要利用隐式反馈在运输层实现拥塞控制。 


进行拥塞控制是需要付出代价的 
- 可能需要在节点之间**交换信息和各种命令**，以便选择拥塞控制的策略并实施控制，这样会产生额外开销。 
- 可能需要**预留一些资源**用于特殊用户或特殊情况，这样就降低了网络资源的共享程度。 

> 然而，为了确保网络性能的稳定，不会因为输入负载的增长而导致网络性 能的恶化甚至出现崩溃，使用拥塞控制而付出一定的代价是值得的。 


#### TCP的四种拥塞控制方法 

TCP的四种拥塞控制方法是**慢开始（Slow-Start)、拥塞避免（Congestion Avoidance) 快重传（Fast Retransmit)、快恢复（Fast Recovery)**。 

<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231213220240.png?" alt="image.png" style="zoom:50%;" />

在图中，发送方要维护一个叫作**拥塞窗口**（Congestion Window)的**状态变量cwnd**,其值取决于网络的拥塞程度和所采用的TCP拥塞控制算法，很显然cwnd的值是动态变化的。拥塞窗口cwnd的维护原则是，只要网络没有出现拥塞，拥塞窗口就再增大一些， 但只要网络出现拥塞，拥塞窗口就减少一些。 

发送方除了要维护拥塞窗口cwnd变量，还要维护**发送窗口（Sender Window)的状态变量swnd**。发送窗口swnd的大小从拥塞窗口cwnd和接收方的接收窗口（Receiver Window) rwnd中取小者，即**swnd=min(cwnd,rwnd)**。 


除拥塞窗口cwnd和发送窗口swnd,发送方还需要维护一个叫作**慢开始门限（SS Thresh)的状态变量ssthresh**: 
- 当cwnd<ssthresh时，使用慢开始算法。 
- 当cwnd>ssthresh时，停止使用慢开始算法而改用拥塞避免算法。 
- 当cwnd=ssthresh时，既可使用慢开始算法，也可使用拥塞避免算法。 


**满开始和拥塞避免**
<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231213222427.png?" alt="image.png" style="zoom:100%;" />

TCP双方建立连 时，拥塞窗口cwnd的初始值被设置为1,这是因为主机刚开始发送数据时完全不知道网络的拥塞情况，慢开始门限ssthresh的初始值16。 


1. 发送方给接收方发送0号数据报文段。接收方收到后，给发送方发回对0号数据报文段的确认报文段。发送方收到该确认报文段后，将cwnd的值**加1增大到2**,这意味着发送方在下一个传输轮次中**可以发送1和2号共2个数据报文段**。请读者注意，传输轮次是指发送方给接收方发送数据报文段后，接收方给发送方发回相应的确认报文段。一个传输轮次所经历的时间其实就是**往返时间RTT**(RTT并非恒定的数值）。使用传输轮次是为了强调把拥塞窗口所允许发送的数据报文段都连续发送出去，并收到了对已发送的最后一个数据报文段的确认。 
2. 发送方给接收方发送1~2号共2个数据报文段。接收方收到后，给发送方发回对1~2号数据报文段的确认报文段。发送方收到确认报文段后，将cwnd的值加2增大到4,这意味着发送方在下一个传输轮次中可以发送3~6号共4个数据报文段。 
3. 发送方给接收方发送3~6号共4个数据报文段。接收方收到后，给发送方发回对3~6号数据报文段的确认报文段。发送方收到确认报文段后，将cwnd的值加4增大到8,这意味着发送方在下一个传输轮次中可以发送7~14号共8个数据报文段。 
4. 发送方给接收方发送7~14号共8个数据报文段。接收方收到后，给发送方发回对 7~14号数据报文段的确认报文段。发送方收到确认报文段后，将cwnd的值加8增大到16。 至此，发送方当前的cwnd值已经增大到了ssthresh值。因此要改用拥塞避免算法，也就是每个传输轮次结束后，cwnd的值只能线性加1,而不像慢开始算法那样，每个传输轮次结束后 cwnd的值按指数规律增大。
5. 发送方给接收方发送15~30号共16个数据报文段。接收方收到后，给发送方发回对15~30号数据报文段的确认报文段。发送方收到确认报文段后，将cwnd的值加1增大到17,这意味着发送方在下一个传输轮次中可以发送31~47号共17个数据报文段。 
6. 发送方给接收方发送31~47号共17个数据报文段。接收方收到后，给发送方发回对31~47号数据报文段的确认报文段。发送方收到确认报文段后，将cwnd的值加1增大到18。
7. 随着传输轮次的增加，cwnd的值每轮次都线性加1,例如在图中，cwnd的值线性加1增大到了24。 
8. 发送方给接收方发送171~194号共24个数据报文段。假设这24个数据报文段在传输过程中丢失了几个。这必然会造成发送方对这些丢失报文段的超时重传。发送方以此判断网络可能出现了拥塞，需要调整自己的cwnd值和ssthresh值： 
	- 将ssthresh值调整为发生拥塞时cwnd值的一半，对于本例为24/2=12。 
	- 将cwnd值减小为1,并重新开始执行慢开始算法。
9. 发送方重新开始执行慢开始算法，让cwnd值按指数规律增大。当慢开始算法 执行到cwnd值增大到新的ssthresh值12时，就停止使用慢开始算法，转而执行拥塞避免算法。 

<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231213223210.png?" alt="image.png" style="zoom:40%;" />

快重传和快恢复 

提出的理由：有时个别TCP报文段会在网络中丢失（例如由于误码被路由器丢弃）,但实际上网络并未发生拥塞。这将导致发送方超时重传并误认为网络发生了拥塞。

**快重传**：就是使发送方尽快（尽早）进行重传，而**不是等超时重传计时器超时再重传**。这就要求接收方不要等待自己发送数据时才进行**捎带确认**，而是要**立即发送确认**，即使收到了失序的报文段也要立即发出**对已收到的报文段的重复确认**。发送方一旦**收到3个连续的重复确认**，就**将相应的报文段立即重传**，而不是等该报文段的超时重传计时器超时再重传。 

<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231214102427.png?" alt="image.png" style="zoom:50%;" />

1. 发送方发送1号TCP数据报文段，接收方收到后给发送方发回对1号数据报文段的确认。在该确认报文段到达发送方之前，发送方还可以将发送窗口内的2号数据报文段发送 出去。 
2. 接收方收到2号数据报文段后，给发送方发回对2号数据报文段的确认。在该确认报文段到达发送方之前，发送方还可以将发送窗口内的3号数据报文段发送出去，但该报文 段丢失了，接收方自然不会给发送方发回针对该报文段的确认。 
3. 发送方还可以将发送窗口内的4号数据报文段发送出去。 
4. 接收方收到4号数据报文段后，发现这不是按序到达的报文段，因此给发送方发回针对2号数据报文段的重复确认，表明：“我现在期望收到的是3号数据报文段，但是我没有收到3号数据报文段，而是收到了未按序到达的数据报文段”。 
5. 发送方还可以将发送窗口内的5号数据报文段发送出去。 
6. 接收方收到5号数据报文段后，发现这不是按序到达的数据报文段，因此给发送方发回针对2号数据报文段的重复确认。 
7. 发送方还可以将发送窗口内的6号数据报文段发送出去。 
8. 接收方收到6号数据报文段后，发现这不是按序到达的数据报文段，因此给发送方发回针对2号数据报文段的重复确认。 
9. 至此，发送方会收到3个连续的对2号数据报文段的重复确认，就立即重传3号数据报文段。 
10. 接收方收到3号数据报文段后，给发送方发回针对6号数据报文段的确认，表明序号到6为止的数据报文段都正确接收了。这样就不会造成对3号数据报文段的超时重传，而是提早进行了重传。 


快恢复：发送方一旦收到**3个重复确认**，就知道现在只是丢失了个别的报文段，于是**不启动慢开始算法**，而是执行快恢复算法：发送方将慢开始门限ssthresh的值和拥塞窗口cwnd的值**都调整为当前cwnd值的一半**，并开始执行拥塞避免算法。

<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231214103129.png?" alt="image.png" style="zoom:40%;" />


### TCP拥塞控制与网际层拥塞控制的关系 


网际层的策略对TCP拥塞控制 影响最大的就是IP路由器的**IP数据报丢弃策略**：简单的情况下，路由器的**输入缓存**（可看作缓存队列，以下简称为队列）通常都 按照“先进先出”（First In First Out,FIFO)的规则来处理到达的IP数据报。由于队列长度总是有限的，因此当队列已满时，之后再到达的所有IP数据报都将被丢弃，这就叫作**尾部丢弃策略**（Tail-drop Policy)。 

全局同步：当网络中有大量封装了TCP报文段的IP数据报涌入某个（或某些）路由器并造成路由器进行尾部丢弃时，这些TCP报文段的多个发送方就会出现超时重传，这会使得许多TCP连接在同一时间突然都进入TCP拥塞控制的**慢开始阶段**。
全局同步使得全网的通信量骤降，而在网络恢复正常后，其通信量又突然增大很多。 

为了避免网络中出现全局同步问题，在1998年提出了**主动队列管理**（Active Queue Management,AQM)。所谓“主动”，就是在路由器的队列长度达到某个阈值但还未满时就**主动丢弃IP数据报**，

AQM可以有不同的实现方法，其中曾流行多年的就是随机早期检测（Random Early Detection,RED),也称为随机早期丢弃（Random Early Drop,RED或 Random Early Discard, RED)。 
路由器需要维护两个参数来实现RED:队列长度**最小门限和最大门限**。当每一个IP数据报到达路由器时，RED就按照规定的算法计算出当前的平均队列长度。 
- 若平均队列长度小于最小门限，则把新到达的IP数据报存入队列进行排队。 
- 若平均队列长度大于最大门限，则把新到达的IP数据报丢弃。 
- 若平均队列长度在最小门限和最大门限之间，则按照某一丢弃概率p把新到达的IP数据报丢弃（这体现了丢弃IP数据报的随机性） 


### TCP可靠传输的实现 


TCP基于以字节为单位的滑动窗口来实现可靠传输，下面举例说明。 


发送方在没有收到接收方确认的情况下，可以**把序号落入发送窗口内的数据依次全部发送出去**。凡是已经发送过的数据，在**未收到确认之前都必须暂时保留**，以便在超时重传时使用。发送窗口具有**前沿**和**后沿**。发送窗口后沿的后面部分，是已发送并已收到确认的数据字节的序号。这些数据字节显然不需要再保存在发送缓存中了，可以将它们删除。发送窗口前沿的前面部分，是当前不允许发送的数据字节的序号。 
- 发送窗口后沿的移动情况有两种可能： 
	- 不动：没有收到新的确认，发送窗口的后沿不会移动。 
	- 前移：收到新的确认，发送窗口的后沿向前移动。 
发送窗口的后沿不可能向后移动。因为不可能撤销掉已收到的确认。 
- 发送窗口前沿的移动情况有三种可能： 
	- 前移：通常情况下，发送窗口的前沿是不断向前移动的。 
	- 不动： 
		- 一种情况是由于没有收到新的确认，接收方通知的窗口大小也没有改变。 
		- 另一种情况是收到了新的确认，可向前移动相应位置，但接收方通知的窗口缩小了，前沿应该向后回缩，如果向前移动和向后回缩的尺寸恰好相等，就会使得发送窗口的前沿不动。 
	- 向后收缩：这发生在接收方通知的窗口变小了。但TCP标准强烈不赞成这样做，因为很可能发送方在收到这个通知之前，就已经发送了窗口中的许多数据，现在又要收缩窗口，不让发送这些数据，显然就会产生错误。 

假设发送方将发送窗口内的31~41号数据封装在几个不同的TCP数据报文段中发送出去，如图所示。此时发送窗口的位置并没有改变，发送窗口内序号31~41的数据已经 发送但未收到确认，而序号42~50的数据是允许发送但还未发送的。 


<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231214112529.png?" alt="image.png" style="zoom:50%;" />



> [!question] 如果要编程实现滑窗口机制，那么对于发送窗口的状态应该如何标记和维护呢？
> - 可以使用三个指针P1、P2和 P3分别指向相应的字节序号： 
> 	- P1指向发送窗口内已发送但还未收到确认的第一个数据的序号。 
> 	- P2指向发送窗口内还未发送的第一个数据的序号。 
> 	- P3指向发送窗口前沿外的第一个数据的序号。 
> - 这样就可以用P1、P2和P3这三个指针来描述发送窗口的相关信息： 
> 	- 小于P1的就是已发送并已收到确认的部分。 
> 	- 大于等于P3的就是不允许发送的部分。 
> 	- P3减P1可以得出当前发送窗口的尺寸。 
> 	- P2减P1可以得出已发送但尚未收到确认的字节数量。 
> 	- P3减P2可以得出允许发送但当前尚未发送的字节数量（又称为可用窗口或有效窗口）。 




> [!attention] 注意：ack在选择重传协议与TCP协议中并不完全相同。 
> 在**选择重传协议**中，ack表明序号到n为止的数据已正确接收，现在期望收到序号为n+1的数据。  
> 在**TCP协议**中，ack表明序号到n-1为止的数据已正确接收，现在期望收到序号为n的数据。 



> [!example] 对于TCP可靠传输的实现，还需要做以下补充说明 
> 1. 虽然发送方的发送窗口是根据接收方的接收窗口设置的，但在同一时刻，发送方的**发送窗口并不总是和接收方的接收窗口一样大**，这是因为：
> 	- 网络传送窗口值需要经历一定的时间滞后，并且这个时间还是不确定的。 
> 	- 发送方还可能根据网络当时的拥塞情况适当减小自己的发送窗口尺寸。 
> 2. **对于不按序到达的数据应如何处理，TCP并无明确规定**。 
> 	- 如果接收方把不按序到达的数据一律丢弃，那么接收窗口的管理将会比较简单，但这样做对网络资源的利用不利，因为发送方会重复传送较多的数据。
> 	- TCP通常对不按序到达的数据先临时存放在接收窗口中，等到字节流中所缺少的字节收到后，再按序交付上层的应用进程。 
> 3. TCP要求接收方必须有**累积确认**（这一点与选择重传协议不同）和**捎带确认**机制。这样可以减小传输开销。接收方可以在合适的时候发送确认，也可以在自己有数据要发送时把确认信息顺便捎带上。 
> 	- **接收方不应过分推迟发送确认**，否则会导致发送方不必要的超时重传，这反而浪费了网络资源。TCP标准规定，确认推迟的时间不应超过0.5秒。若收到一连串具有最大长度的报文段，则必须每隔一个报文段就发送一个确认。
> 	- **捎带确认实际上并不经常发生**，因为大多数应用程序很少同时在两个方向上发送数据。 
> 4. **TCP的通信是全双工通信**。通信中的每一方都在发送和接收报文段。因此，每一方都有自己的发送窗口和接收窗口。在谈到这些窗口时，一定要弄清楚是哪一方的窗口。 



### TCP超时重传时间的选择 

一般情况下超时重传时间RTO的值应该设置为略大于报文段RTT的值

<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231214120013.png?" alt="image.png" style="zoom:50%;" />


TCP下层是复杂的因特网环境，主机A所发送的报文段可能只经过一个高速率的局域网，也有可能经过多个低速率的网络，并且每个IP数据报的转发路由还可能不同。如图所示， 

<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231214120109.png?" alt="image.png" style="zoom:40%;" />


不能直接使用某次测量得到的RTT样本作为RTO。但是，可以利用每次测量得到的RTT样本**计算加权平均往返时间RTTs**,这样可以得到比较平滑的往返时间。当测量到第一个 

$$新的RTT_s=(1-\alpha)×旧的RTT_s+\alpha×新的RTT样本$$

推荐的$\alpha$值为1/8, 显然，RTO的值应略大于加权平均往返时间RTTs的值。建议使用下面的公式来计算超时RTO。 、
$$RTO=RTT_s+4×RTT_D  (5-2) $$



$$新的RTT_D= ( 1 - \beta ) \times 旧的RTT_D+\beta \times | RTT_s- 新的RTT样本|$$
0≤β<1。β的推荐值是1/4,即0.25。 


<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231214120147.png?" alt="image.png" style="zoom:40%;" />
> 通过上述两个例子可以看出：当发送方出现超时重传后，收到确认报文段时 是无法判断出该确认到底是对原数据报文段的确认还是对重传数据报文段的确认， 也就是无法准确测量出RTT,进而无法正确计算RTO。 



<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231214120244.png?" alt="image.png" style="zoom:40%;" />


### TCP的选择确认 

在之前介绍TCP的快重传和可靠传输时，TCP接收方**只能对按序收到的数据中的最高序号给出确认**。当发送方**超时重传**时，接收方之前**已收到的未按序到达的数据也会被重传**。 

TCP可以采用**选择确认（Selective ACK,SACK)** 

<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231214120837.png?" alt="image.png" style="zoom:40%;" />

### TCP窗口和缓存的关系 


> [!multi-column]
>
>> [!note]+ TCP发送方的发送窗口和发送缓存 
>>
>>如图所示，TCP发送缓存用来存放： 
>>- 发送方应用进程**交付给TCP准备发送的数据**。 
>>- TCP已发送但尚未收到确认的数据。 
>>- <img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231214121008.png?OSSAccessKeyId=LTAI5tBK1gnqyQLHK2d7sx6F&Expires=9000000000&Signature=ialBL83zsfGeK9fhFScAiCXuVCo=" alt="image.png" style="zoom:50%;" />
>>- TCP发送窗口通常**只是TCP发送缓存的一部分**。发送缓存中已被确认的数据应当从发送缓存中删除，因此发送缓存和发送窗口的**后沿是重合的**。发送方应用进程最后写入发送缓存的字节减去最后被确认的字节，就是还保留在发送缓存中的字节数量。发送方应用进程必须控制写入发送缓存的速率，不能太快，否则发送缓存就可能会产生溢出。
>
>> [!warning]+ TCP接收方的接收窗口和接收缓存 
>>
>>如图所示，TCP接收缓存用来存放： 
>>- 按序到达的、但尚未被接收方应用进程读取的数据。 
>>- 未按序到达的数据。 
>>- <img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231214121246.png?" alt="image.png" style="zoom:50%;" />
>>- 如果接收方应用进程来不及读取收到的数据，接收缓存最终就会**产生溢出**，使接收窗口的值减小到0。反之，如果接收方应用进程能够及时从接收缓存中读取收到的数据，接收 窗口的值就可以增大，但最大不能超过接收缓存的大小。 



# 应用层

## 应用层概述

- 应用层是计算机网络体系结构的**最顶层**，是**设计和建立计算机网络的最终目的**，也是计算机网络中发展最快的部分。 
	- 早期基于文本的应用（电子邮件、远程登录、文件传输、新闻组） 
	- 20世纪90年代将因特网带入千家万户的万维网WWW 
	- 当今流行的即时通信、P2P文件共享及各种音视频应用 
	- 计算设备的小型化和“无处不在”，宽带住宅接入和无线接入的日益普及和迅速发展，为未来更多的新型应用提供了广阔的舞台。 
- 在本章中，我们以一些经典的网络应用为例来学习有关网络应用的原理、协议和实现方面的知识。 
	- 万维网WWW 域名系统DNS 动态主机配置协议DHCP 电子邮件 文件传送协议FTP P2P文件共享 多媒体应用


## 客户一服务器方式和对等方式 

网络应用程序运行在处于网络边缘的不同的端系统上，通过彼此间的通信来共同完成某项任务。 
开发一种新的网络应用首先要考虑的问题就是**网络应用程序在各种端系统上的组织方式和它们之间的关系**。 
目前流行的主要有以下两种： 
- **客户/服务器**（Client/Server,C/S)方式 
- **对等**（Peer-to-Peer,P2P)方式 



> [!multi-column]
>
>> [!note]+ 客户/服务器（Client/Server,C/S)方式
>>
>>- 客户和服务器是指通信中所涉及的两个应用进程。 
>>- 客户/服务器方式所描述的是进程之间服务和被服务的关系。 
>>- **客户是服务请求方，服务器是服务提供方**。 
>>- **服务器总是处于运行状态，并等待客户的服务请求。服务器具有固定端口号（例如HTTP服务器的默认端口号为80),而运行服务器的主机也具有固定的IP地址**。
>>- <img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231214201905.png?" alt="image.png" style="zoom:50%;" />
>>- C/S方式是因特网上传统的、同时也是最成熟的方式，很多我们熟悉的网络应用采用的都是C/S方式。包括万维网WWW、电子邮件、文件传输FTP等。 
>>- 基于C/S方式的应用服务通常是**服务集中型**的，即应用服务集中在网络中比客户计算机少得多的服务器计算机上。 
>>	- 由于一台服务器计算机要为多个客户机提供服务，在C/S应用中，常会出现服务器计算机跟不上**众多客户机请求的情况**。 
>>	- 为此，在C/S应用中，常用**计算机群集**(或服务器场）构建一个强大的**虚拟服务器**。 
>
>> [!note]+ 对等（Peer-to-Peer,P2P)方式 
>>
>>- 在P2P方式中，**没有固定的服务请求者和服务提供者**，分布在网络边缘各端系统中的应用进程是对等的，被称为**对等方。对等方相互之间直接通信**，每个对等方既是服务的请求者，又是服务的提供者。 
>>- 目前，在因特网上流行的P2P应用主要包括P2P文件共享、即时通信、P2P流媒体、分布式存储等。 
>>- 基于P2P的应用是**服务分散型**的，因为服务不是集中在少数几个服务器计算机中，而是分散在大量对等计算机中，这些计算机并不为服务提供商所有，而是为个人控制的桌面计算机和笔记本电脑，它们通常位于住宅、校园和办公室中。 
>>- P2P方式的最突出特性之一就是它的**可扩展性**。因为系统每增加一个对等方，不仅增加的是服务的请求者，同时也增加了服务的提供者，**系统性能不会因规模的增大而降低**。 
>>- P2P方式**具有成本上的优势**，因为它通常不需要庞大的服务器设施和服务器带宽。为了降低成本，服务提供商对于将P2P方式用于应用的兴趣越来越大。 
>>- <img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231214202852.png?" alt="image.png" style="zoom:60%;" />


## 动态主机配置协议 (DHCP)

使用TCP/IP协议栈的主机，需要配置相关的网络参数，才能与因特网上的主机进行通信，这些网络参数一般包括以下几类： 
- IP地址。 
- 子网掩码。 
- 默认网关的IP地址。 
- 域名服务器的IP地址。 

由用户配置网络参数可能存在不便，**动态主机配置协议DHCP**(Dynamic Host Configuration Protocol)提供了一种机制，称为**即插即用连**网。 机制允许一台计算机加入新网络时可**自动获取IP地址等网络配置信息**而不用手工参与。 

### 动态主机配置协议的工作过程 


<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231214210349.png" alt="image.png" style="zoom:40%;" />


简要概述
1. DHCP客户要先发送**发现报文(DHCP DISCOVER)**,内部有事务ID和MAC地址
2. DHCP服务器收到发现报文，根据MAC地址查询数据库，如果没有就采用默认的配置信息构建**DHCP提供报文(DHCP OFFER)**,广播发送提供报文，而DHCP客户是通过事务ID来选择是否接收
3. DHCP客户向所选择的DHCP服务器发送**请求报文(DHCP REQUEST)**,内部包含要接收的租用IP地址
4. DHCP服务器给DHCP客户发送**DHCP确认报文(DHCP ACK)**,DHCP客户收到该确认报文段后，就可以使用所租用到的IP地址了。 
5. 当IP地址的租用期过了一半时，DHCP客户会向DHCP服务器**发送DHCP请求报文**来请求更新租用期。与第一次发送的DHCP请求报文不同，封装该报文的IP数据报的源地址为DHCP客户之前租用到的IP地址，目的IP地址为DHCP服务器的地址。 
6. DHCP服务器收到用于续租的DHCP请求报文时，分以下三种情况处理： 
	- 同意
	- 不同意
	- 未响应 重新发送发现报文
7. DHCP客户可以随时提前终止DHCP服务器所提供的租用期，这时只需要向DHCP服务器发送**DHCP释放报文（DHCP RELEASE)**即可


综上所述，DHCP的基本工作过程如下： 
1. DHCP客户寻找DHCP服务器。 
2. DHCP服务器向DHCP客户提供IP地址租用。 
3. DHCP客户接收IP地址租约。 
4. DHCP服务器确认IP地址租约。 
5. DHCP客户进行IP地址续约。 
6. DHCP客户可以随时解除IP地址租约。 


**DHCP中继代理** 
一般各主机是不可以通过DHCP来自动获取网络配置参数的，因为路由器会丢弃主机广播的DHCP发现报文 
解决上述问题的方法：给该路由器配置DHCP服务器的IP地址并使之成为**DHCP中继代理**，这样，该网络中的各主机就可以通过DHCP来自动获取到网络配置参数了。当成为DHCP中继代理的路由器收到广播的DHCP发现报文后，会将其单播转发给DHCP服务器。
 

## 域名系统（DNS)

1. 当用户在主机的浏览器地址栏中输入域名cnnic.net.cn时,主机会首先在自己的DNS缓存中查找该域名所对应的IP地址图
2. 如果没有找到，则会向因特网中的某台DNS服务器查询
3. DNS服务器中有域名和IP地址映射关系的数据库。DNS服务器收到DNS查询报文后，在其数据库中进行查询，并将查询结果发送给用户主机
4. 之后，用户主机中的浏览器就可以通过域名背后的IP地址来访问该网站了 

### 因特网的域名结构 

因特网采用**层次树状结构的域名结构**。域名的结构由若干个分量组成，各分量之间用点“”隔开，分别代表不同级别的域名，

<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231214215838.png?" alt="image.png" style="zoom:50%;" />

顶级域名（Top Level Domain,TLD)分为以下三类： 
- 国家顶级域名（nTLD):采用ISO3166的规定，如cn表示中国，us表示美国，uk表示英国，等等。 
- 通用顶级域名（gTLD):最常见的通用顶级域名有七个，com表示公司企业，net表示网络服务机构，org表示非营利性组织，int表示国际组织，edu表示美国教育机构，gov表示美国政府部门，mil表示美国军事部门。 
- 反向域（arpa):用于反向域名解析，即IP地址反向解析为域名。 

我国将二级域名划分为以下两类： 
- 类别域名：共七个，ac表示科研机构，com表示工、商、金融等企业，edu表示教育机构，gov表示政府部门，net表示提供网络服务的机构，mil表示军事机构，org表示非营利性组织。 
- 行政区域名：共34个，适用于我国的各省、自治区和直辖市。例如bj为北京市，sh为上海市，js为江苏省，等等。 

<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231214215943.png?" alt="image.png" style="zoom:50%;" />

### 因特网上的域名服务器 

域名服务器可以划分为四种不同的类型： 
- **根域名服务器**：这是最高层次的域名服务器。每个根域名服务器都知道所有的顶级域名服务器的域名和IP地址。因特网上共有13个不同IP地址的根域名服务器。 
- **顶级域名服务器**：这些域名服务器负责管理在其下注册的所有**二级域名**。当收到DNS查询请求时就给出相应的回答。这可能是最终的查询结果，也可能是下一级权限域名服务器的IP地址。 
- **权限域名服务器**：这些域名服务器负责**管理某个区的域名**。每一个主机的域名都必须在某个权限域名服务器处注册登记。因此权限域名服务器知道其管辖的域名与IP地址的映射关系。另外，权限域名服务器还知道其下级域名服务器的地址。 
- **本地域名服务器**：本地域名服务器不属于上述的域名服务器的等级结构。当一个主机发出DNS请求报文时，这个报文就**首先被送往该主机的本地域名服务器**。本地域名服务器起着**代理**的作用，会将该报文转发到上述的域名服务器的等级结构中。

### 因特网的域名解析过程 


因特网有两种域名查询方式：递归查询和迭代查询，下面举例说明上述两种域名查询方式。 


> [!multi-column]
>
>> [!note]+ 递归查询
>>
>>1. 主机首先向其本地域名服务器进行**递归查询**
>>2. 本地域名服务器收到递归查询的“**委托**”后，采用递归查询的方式向某个根域名服务器查询 
>>3. 根域名服务器收到递归查询的“委托”后，采用递归查询的方式向某个顶级域名服务器查询 
>>4. 顶级域名服务器收到递归查询的“委托”后，采用递归查询的方式向某个权限域名服务器查询 
>>5. 当查询到域名所对应的IP地址后，查询结果会在之前受“委托”的各域名服务器之间传递,最终传回给用户主机 
>><img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231214220449.png" alt="image.png" style="zoom:50%;" />
>
>> [!warning]+ 迭代查询
>>
>>1. 主机首先向其本地域名服务器进行递归查询 
>>2. 本地域名服务器采用迭代查询，它先向某个根域名服务器查询 
>>3. 根域名服务器告诉本地域名服务器下一次应查询的顶级域名服务器的IP地址 
>>4. 本地域名服务器向顶级域名服务器进行迭代查询 
>>5. 顶级域名服务器告诉本地域名服务器下一次应查询的权限域名服务器的IP地址 
>>6. 本地域名服务器向权限域名服务器进行迭代查询 
>>7. 权限域名服务器告诉本地域名服务器所查询的域名的IP地址 
>>8. 本地域名服务器最后把查询结果告诉用户主机 
>><img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231214220721.png" alt="image.png" style="zoom:50%;" />


### 域名系统高速缓存

为了提高DNS的查询效率，并减轻根域名服务器的负荷和减少因特网上的DNS查询报文数量，在域名服务器和主机中广泛地使用了**高速缓存**。 

<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231214221103.png?" alt="image.png" style="zoom:50%;" />

注意，由于域名到IP地址的映射关系并不是永久不变的，为保持高速缓存中的内容正确，域名服务器应为每项内容设置计时器，并删除超过合理时间的项（例如每个项目只存放两天）。 



## 文件传送协议 FTP


- 将某台计算机中的文件通过网络传送到可能相距很远的另一台计算机中，是一项基本的网络应用，即文件传送。 
- **文件传送协议FTP**(File Transfer Protocol)是因特网上使用得最广泛的文件传送协议。 
	- FTP提供交互式的访问，允许客户**指明文件的类型与格式**（如指明是否使用ASCII码）,并允许**文件具有存取权限**（如访问文件的用户必须经过授权，并输入有效的口令）。 
	- **FTP屏蔽了各计算机系统的细节，因而适合于在异构网络中任意计算机之间传送文件**。 
- 在因特网发展的早期阶段，用FTP传送文件约占整个因特网的通信量的三分之一，而由电子邮件和域名系统所产生的通信量还要小于FTP所产生的通信量。只是到了1995年，万维网WWW的通信量才首次超过了FTP。 


FTP客户和服务器之间要**建立以下两个并行的TCP连接**：
- **控制连接**，在整个会话期间一直保持打开，用于传送FTP相关控制命令。 
- **数据连接**，用于文件传输，在每次文件传输时才建立，传输结束就关闭。 被动方式由服务器和客户端自行协商决定。 
- **默认情况下，FTP使用TCP21端口进行控制连接，TCP20端口进行数据连接**。但是，是否使用TCP20端口建立数据连接与传输模式有关，主动方式使用TCP20端口，被动方式由服务器和客户端自行协商决定。 

<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231214223002.png?" alt="image.png" style="zoom:50%;" />

## 电子邮件 

电子邮件系统采用**客户/服务器**方式。三个主要组成构件：**用户代理，邮件服务器**，以及电子邮件所需的**协议**。 
- 用户代理是用户与电子邮件系统的**接口**，又称为电子邮件客户端软件。 
- 邮件服务器是电子邮件系统的基础设施。因特网上所有的ISP都有邮件服务器，其功能是发送和接收邮件，同时还要负责维护用户的邮箱。 
- 协议包括邮件发送协议（例如SMTP)和邮件读取协议（例如POP3)。 

<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231214235346.png?" alt="image.png" style="zoom:50%;" />



**简单邮件传送协议SMTP(Simple Mail Transfer Protocol)的基本工作原理** 

<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231214235842.png?" alt="image.png" style="zoom:50%;" />

**电子邮件的信息格式** 

一个电子邮件包含信封和内容两部分，而内容又由**首部**和**主体**两部分构成。 
- 关键字“From”后面填入发件人的电子邮件地址，一般由邮件系统自动填入。 
- 关键字“To”后面填入一个或多个收件人的电子邮件地址。 
- 关键字“Cc”后面填入一个或多个收件人以外的抄送人的电子邮件地址，抄送人收到邮件后，可看可不看邮件，可回可不回邮件。 
- 关键字“Subject”后面填入邮件的主题，它反映了邮件的主要内容。 


<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231215000304.png?" alt="image.png" style="zoom:40%;" />

常用的邮件发送协议是简单邮件传送协议SMTP 
- 基于TCP连接，端口号为25;
- 只能传送**ASCII码文本** 
- 用于用户代理向邮件服务器发送邮件以及邮件服务器之间的邮件发送 

为解决SMTP传送非ASCII码文本的问题，提出了**多用途因特网邮件扩展MIME(Multipurpose Internet Mail Extensions)**... 

<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231215000626.png?" alt="image.png" style="zoom:50%;" />

常用的**邮件读取协议**有以下两个： 
- **邮局协议POP3**:非常简单、功能有限的邮件读取协议。用户只能以下载并删除方式或下载并保留方式从邮件服务器下载邮件到用户方计算机。**不允许用户在邮件服务器上管理自己的邮件**。 
- **因特网邮件访问协议IMAP**:功能比POP3强大的邮件读取协议。**用户在自己的计算机上就可以操控邮件服务器中的邮箱**，就像在本地操控一样，因此IMAP是一个联机协议。 
- POP3和IMAP4都采用**基于TCP连接的客户/服务器方式**。POP3使用端口110,IMAP4使用端口143。 

基于万维网的电子邮件 
- 通过**浏览器**登录（提供用户名和口令）**邮件服务器万维网网站**就可以撰写、收发、阅读和管理电子邮件。这种工作模式与IMAP很类似，不同的是用户计算机无需安装专门的用户代理程序，只需要使用通用的万维网浏览器。 
- 邮件服务器网站通常都提供非常强大和方便的邮件管理功能，用户可以在邮件服务器网站上管理和处理自己的邮件，而不需要将邮件下载到本地进行管理。 

<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231215000953.png?" alt="image.png" style="zoom:50%;" />

## 万维网

万维网是一个大规模、联机式的**信息储藏所**，是运行在因特网上的一个**分布式应用**。

超文本传输协议（HTTP)定义了以下功能的实现方法： 
- 浏览器（即万维网客户进程）向万维网服务器请求万维网文档。 
- 万维网服务器把万维网文档传送给浏览器。 


**超文本传输协议HTTP**(HyperText Transfer Protocol)定义了浏览器（即万维网客户进程）怎样向万维网服务器请求万维网文档，以及万维网服务器怎样把万维网文档传送给浏览器。 
- HTTP/1.0采用**非持续连接**方式。每次浏览器要请求一个文件都要与服务器建立TCP连接（80端口）,当收到响应后就立即关闭连接。 

	<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20231215104712.png?" alt="image.png" style="zoom:40%;" />

- HTTP/1.1采用**持续连接**方式。万维网服务器在发送响应后仍然保持这条连接，使同一个客户（浏览器）和该服务器可以继续在这条连接上传送后续的 HTTP请求报文和响应报文。为了进一步提高效率，还可采用**流水线**方式，即浏览器在收到HTTP的响应报文之前就能够连续发送多个请求报文。 

HTTP有两类报文：**请求报文**和**响应报文**。报文中的每一个字段都是一些ASCII码串，并且每个字段的长度都是不确定的。 


### HTTP的报文格式
- HTTP是**面向文本**的,其报文中的每一个**字段**都是一些**ASCII码串**,并且每个字段的**长度**都是不确定的。

<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20240417155640.png" alt="image.png" style="zoom:60%;" />

对于HTTP请求，它通常包括请求行（Request Line）、请求头（Header Fields）、和可选的消息体（Message Body）。

1. 请求行（Request Line）
	- 方法（Method）：这定义了对资源的操作类型，常见的方法有GET, POST, PUT, DELETE等。
	- 请求URI（Request-URI）：指定了请求资源的位置。
	- HTTP版本（HTTP Version）：标识了客户端使用的HTTP协议版本，如HTTP/1.1。

	```html
	GET /index.html HTTP/1.1
	```

2. 请求头（Header Fields）紧随请求行之后的是一系列请求头，它们用来传递额外的操作参数和客户端信息。请求头由关键字/值对组成，每对之间用冒号分隔。请求头在HTTP消息中提供了关于请求、客户端以及所请求资源的详细信息。常见的请求头包括：
	- Host：服务器的域名和端口号。
	- User-Agent：发出请求的客户端信息。
	- Accept：客户端能够接收的内容类型。
	- Content-Type：请求体的媒体类型（主要用于POST和PUT请求中）。
	- Content-Length：请求体的长度。

	```html
	Host: www.example.com
	User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.3029.110 Safari/537.36
	Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8
	```

3. 消息体对于像POST和PUT这类用于提交数据的请求方法来说，消息体是必须的

**整体结构示例**：

```html
GET /index.htm HTTP/1.1        请求行:指明方法GET,URL,HTTP版本
Host: www.hnust.cn             首部行的开始:指明服务器的域名
Connection: close              告诉服务器发送完请求的文档后就可释放连接
User-Agent: Mozilla/5.0        告诉服务器浏览器的类型及版本
Accept-Language:cn             告诉服务器用户希望优先得到中文版本的文档
							   报文的最后还有一个空行
```

```html
POST /submit-form HTTP/1.1
Host: www.example.com
Content-Type: application/x-www-form-urlencoded
Content-Length: 27
username=john&password=12345
```

请求行的方法种类

|   方法    |           描述            |
| :-----: | :---------------------: |
|   GET   |       请求URL标志的文档        |
|  HEAD   |      请求URL标志的文档的首部      |
|  POST   |        向服务器发送数据         |
|   PUT   |     在指明的URL下存储一个文档      |
| DELETE  |       删除URL标志的文档        |
| CONNECT |         用于代理服务器         |
| OPTIONS |        请求一些选项信息         |
|  TRACE  |        用来进行环回测试         |
|  PATCH  | 对PUT方法的补充,用来对已知资源进行局部更新 |


<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20240417160234.png?" alt="image.png" style="zoom:60%;" />


| 状态码 |            描述            |
| :-: | :----------------------: |
| 1XX |  表示通知信息,如请求收到了或正在进行处理;   |
| 2XX |      表示成功,如接受或知道了;       |
| 3XX | 表示重定向,即要完成请求还必须采取进一步的行动; |
| 4XX | 表示客户的差错,如请求中有错误的语法或不能完成; |
| 5XX |  表示服务器的差错,如服务器失效无法完成请求。  |

## SSL协议

SSL是一个不依赖于平台和运用程序的协议，位于TCP/IP协议与各种应用层协议之间，为数据通信提高安全支持。

SSL协议结构：

<img src="https://img-blog.csdnimg.cn/20190511174025464.png?" alt="image.png" style="zoom:50%;" />

**SSL的体系结构中包含两个协议子层**，其中底层是**SSL记录协议层**（SSL Record Protocol Layer）；高层是**SSL握手协议层**（SSL HandShake Protocol Layer）。

SSL协议主要分为两层：

- SSL记录协议层的作用是为高层协议**提供基本的安全服务**。SSL纪录协议针对HTTP协议进行了特别的设计，使得超文本的传输协议HTTP能够在SSL运行。纪录封装各种高层协议，具体实施压缩解压缩、加密解密、计算和校验MAC等与安全有关的操作。
- SSL握手协议层包括SSL握手协议（SSL HandShake Protocol）、SSL密码参数修改协议（SSL Change Cipher Spec Protocol）和SSL告警协议（SSL Alert Protocol）。握手层的这些协议用于SSL**管理信息的交换**，允许应用协议传送数据之间**相互验证**，**协商加密算法**和**生成密钥**等。

SSL握手协议的作用是协调客户和服务器的状态，使双方能够达到状态的同步。
那么SSL协议主要是如何加密传输的呢？

### 安全连接的建立

<img src="https://img-blog.csdnimg.cn/20190511174036444.png" alt="image.png" style="zoom:50%;" />

<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20240115161214.png" alt="image.png" style="zoom:50%;" />


1. TCP三次握手以后发送一个Client Hello 给服务端，这里面会告诉客户端支持的**TSL版本**和支持的**加密套件**，并发送一个**随机数**
2. 服务端要回应Server hello给客户端，在响应报文里面会告诉客户端服务端确认支持的TSL版本和支持的加密套件，并且服务器也生成一个**随机数**发给客户端
3. 服务器会再次发一个响应来出示自己的**证书**，这样浏览器可以根据自己的证书信任列表来确认这个服务器是否可信，还要发送一个**公钥**
4. serverHello Done代表发送完了 
5. 客户端发送生成一个随机数，叫做预主密钥，这个<font color=#ff0000>预主密钥不会直接发送出去</font>，而是经过**公钥的加密**后再发送出去
6. 服务端收到加密后的预主密钥后，会用<font color=#ff0000>自己的私钥进行解密</font>，这样就得到预主密钥了，这个时候只有客户端和服务端知道**预主密钥**了。
7. 第一个随机数+第二个随机数+预主密钥=会话密钥，前面这个部分就叫做**非对称加密**，后面使用这个会话密钥进行加密数据(Change Cipher Spec)，属于**对称加密**。握手完成

### 加密信息的传输

<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20240115161545.png?" alt="image.png" style="zoom:40%;" />

对每次传输的数据先进行分段，每段16k的大小，选择性压缩，最后加上消息认证码(MAC,是指定唯一的)，加密后再加上分段头，可以往下发送给传输层了


#计算机网络面试点 
  
Http和HTTPS之前的区别？



1. **安全性**：
    - **HTTP**：是一种不加密的协议，数据以明文形式传输。这意味着所有传输的信息（如用户名、密码、其他敏感信息）都可以被拦截者轻易阅读。
    - **HTTPS**：在 HTTP 的基础上增加了 **SSL/TLS** 安全层，对传输的数据进行加密。这提高了数据传输的安全性，使拦截和阅读传输数据变得更加困难。
2. **端口**：
    - **HTTP**：默认使用端口 80。
    - **HTTPS**：默认使用端口 443。
3. **性能**：
    - **HTTP**：由于没有加密过程，HTTP的性能通常比 HTTPS 略好，但这个差异随着现代加密技术的提升正在变得越来越小。
    - **HTTPS**：加密和解密过程需要额外的处理时间和资源，这可能导致相对于 HTTP 稍微增加的延迟和处理负担。
4. **SSL/TLS 证书**：
    - **HTTP**：不需要证书。
    - **HTTPS**：需要 SSL/TLS 证书来建立安全连接。证书由证书颁发机构（CA）颁发，用于验证网站的身份，并为浏览器和服务器之间的数据传输提供加密。
5. **URL格式**：
    - **HTTP**：URL以 `http://` 开头。
    - **HTTPS**：URL以 `https://` 开头。
6. **用途**：
    - **HTTP**：由于安全性较低，通常用于不敏感的信息传输。
    - **HTTPS**：推荐用于所有网站，特别是那些处理敏感信息（如电子商务、在线银行、个人数据）的网站。
7. HTTP 连接建立相对简单， TCP 三次握手之后便可进行 HTTP 的报文传输。而HTTPS在 TCP,三次握手之后，还需进行 SSL/TLS 的握手过程，才可进入加密报文传输

总的来说，HTTPS 提供了比 HTTP 更高的安全性，这是通过在客户端和服务器之间的通信加密来实现的。随着互联网安全意识的提高，越来越多的网站正在采用 HTTPS 来保护用户数据和隐私。


Cookie、Session、Token

HTTP是⽆状态、明⽂传输、不安全
⽆状态：
服务器不会去记忆HTTP的状态，所以不需要额外的资源来记录状态信息，这能减轻服务器的负担。但它在完成有
关联性的操作时会⾮常麻烦。

Cookie基本流程

<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20241006235930.png" alt="image.png" style="zoom:40%;" />


1. 浏览器发起HTTP请求，服务器会进行Cookie设置,也就是**Set-Cookie**。Cookie里有名和值两个重要属性。
2. Cookie发给浏览器以后,浏览器会保存起来,浏览器以后发送的**每一个请求都会自动附上这个Cookie**。
3. Cookie是**保存在浏览器**上的，是**不安全**。


Session基本流程

<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20241007001546.png" alt="image.png" style="zoom:40%;" />


1. 首先我们使用用户名密码发送给B站服务器，B站服务器核对了一下，确认用户名密码是对的，身份认证成功
2. 于是就在服务器这边创建一个**Session ID**和会话结束时间，这个Session ID通常是一串没有规律的字符串
3. 服务器就需要把Session ID和会话结束时间发送给浏览器，这里是用了**Set-Cookie**（Session ID放在Cookie里面）
4. 浏览器拿到Cookie后进行保存，浏览器这个时候**没有保存用户名密码**，保存的Session ID也是没有规律的字符串
5. 浏览器以后发送的**每一个请求都会自动附上这个Cookie**。浏览器的下次访问，下下次访问都会自动发送这个Session ID给服务器，直到Cookie的有效期失效之后，浏览器一般就会自行删除这个Cookie
6. 直到Cookie的有效期失效之后，浏览器一般就会自行删除这个Cookie，这就是会话结束了。
7. 那么在Cookies失效之后，用户就得重新输入用户名密码了

JSON Web Token

<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20241007002354.png" alt="image.png" style="zoom:40%;" />

流程：
1. 首先用户第一次登录网页以后，服务器就会生成一个JWT，服务器不需要保存这个JWT,只需要保存JWT签名的密文
2. 接着把JWT发给浏览器,可以让浏览器以Cookie或者Storage的形式进行存储,这样用户每次发送请求都会把这个JWT发给服务器,用户就不需要重新输入账号密码了
3. JWT是由三部分组成的点分开,header.payload.signature.虽然**JWT不保存在服务器这里**,但是服务器需要保存一段密码,这段密码要结合着两段编码进行算法运算最终得到签名信息,这样一个完整的WT就可以发给客户端了
	1. header部分声明需要用什么算法来生成签名
	2. payload部分是一些特定的数据，比如有效期之类的
	3. 接着header和payload两部分的内容会经由Base64编码

<img src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20241007002437.png" alt="image.png" style="zoom:40%;" />

总结：
Session是诞生并且保存在服务器那边的，由服务器主导一切
而Cookie.则是一种数据载体，把Session放入Cookie中送到客户端那边
Cookie跟随着HTTP的每个请求发送出去，
Token是诞生在服务器，但保存在浏览器这边的，由客户端主导一切。持有Token就像持有“令牌”一样可以允许访问服务器